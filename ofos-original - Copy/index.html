<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzalicious - Pizza Online Ordering System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet (OpenStreetMap) for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* General Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 1px;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        /* UI Enhancements */
        /* Modern card look for forms and modals */
        .login-box, .signup-box, .cart-content, .address-content, .payment-content, .success-content {
            background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 12px 30px rgba(16,24,40,0.08), 0 4px 8px rgba(16,24,40,0.04);
            border: 1px solid rgba(16,24,40,0.04);
        }

        /* Inputs and selects */
        input[type="text"], input[type="password"], input[type="tel"], textarea, select {
            border: 1px solid #e6e6e9;
            background: #fff;
            padding: 12px 14px;
            border-radius: 10px;
            box-shadow: inset 0 1px 2px rgba(16,24,40,0.02);
            transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.08s ease;
            font-size: 14px;
        }

        input[type="text"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            border-color: #ff7e5f;
            box-shadow: 0 6px 18px rgba(255,126,95,0.08);
            outline: none;
            transform: translateY(-1px);
        }

        /* Buttons */
        .login-btn, .signup-btn, .admin-btn, .add-to-cart-btn, .checkout-btn, .continue-payment-btn, .confirm-payment-btn {
            background: linear-gradient(90deg,#ff7e5f,#feb47b);
            color: #fff;
            border: none;
            padding: 12px 18px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255,126,95,0.12);
            transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
        }

        .login-btn:hover, .signup-btn:hover, .add-to-cart-btn:hover, .checkout-btn:hover { transform: translateY(-3px); }
        .admin-btn.delete { background: #ff6b6b; box-shadow: 0 8px 20px rgba(255,107,107,0.12); }

        /* Inline error messages */
        .error-message {
            display: none; /* default hidden, JS will show */
            color: #d9534f;
            font-size: 13px;
            margin-top: 8px;
        }

        /* Toast notification improvements */
        .toast {
            position: fixed;
            right: 24px;
            bottom: 24px;
            background: rgba(34,34,34,0.95);
            color: #fff;
            padding: 12px 16px;
            border-radius: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            box-shadow: 0 12px 30px rgba(16,24,40,0.2);
            z-index: 2000;
            animation: slideIn 0.25s ease;
        }

        @keyframes slideIn { from { transform: translateY(12px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }

        /* Menu and pizza cards spacing + hover */
        .menu-grid .menu-item, .pizza-grid .pizza-card {
            border-radius: 14px;
            overflow: hidden;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        .menu-grid .menu-item:hover, .pizza-grid .pizza-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 18px 40px rgba(16,24,40,0.08);
        }

        /* Admin table improvements */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            /* soft peach background instead of stark white */
            background: rgba(255, 255, 255, 0.96);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(16,24,40,0.04);
        }

        .admin-table th, .admin-table td {
            padding: 12px 14px;
            border-bottom: 1px solid #f1f1f3;
            text-align: left;
            vertical-align: middle;
            font-size: 14px;
        }

        .admin-table thead th {
            background: linear-gradient(90deg,#fff7f0,#fffaf6);
            color: #2d2020;
            font-weight: 700;
        }

        /* Smaller screens tweaks: make forms full-width and readable */
        @media (max-width: 768px) {
            .login-box, .signup-box { width: 92%; padding: 18px; }
            .nav-tabs { gap: 8px; }
        }
        
        /* Entrance animations */
        .enter {
            opacity: 0;
            transform: translateY(8px) scale(0.995);
        }

        .enter {
            animation: fadeUp 420ms cubic-bezier(.2,.8,.2,1) forwards;
        }

        /* Disable entrance animations for order cards and staff order items to avoid popping */
        .order-card.enter, .order-item.enter {
            animation: none !important;
            opacity: 1 !important;
            transform: none !important;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(8px) scale(0.995); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Modal pop-in */
        .cart-modal.active .cart-content,
        .address-modal.active .address-content,
        .payment-modal.active .payment-content,
        .success-modal.active .success-content,
        .login-container .login-box,
        .signup-container .signup-box {
            transform-origin: center top;
        }

        .cart-modal.active .cart-content,
        .address-modal.active .address-content,
        .payment-modal.active .payment-content,
        .success-modal.active .success-content {
            animation: popIn 320ms cubic-bezier(.2,.9,.3,1) both;
        }

        @keyframes popIn {
            from { opacity: 0; transform: translateY(8px) scale(0.985); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Slight hover micro-interaction for nav tabs */
        .nav-tab { transition: transform 0.12s ease, background-color 0.12s ease; }
        .nav-tab:hover { transform: translateY(-3px); }

        /* Landing Page Styles */
        .landing-page {
            background: linear-gradient(to bottom, #ffecd2, #fcb69f);
            min-height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* center a rounded nav container like the design */
            position: fixed;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 120px);
            max-width: 1100px;
            padding: 12px 22px;
            background-color: transparent; /* make nav background transparent */
            color: #0f1720; /* nav text color: dark */
            /* subtle border and blur so the pill remains visible over any background */
            border: 1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(6px);
            border-radius: 999px;
            z-index: 1000;
            box-shadow: 0 8px 20px rgba(2,6,23,0.45);
        }

        header .logo {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
        }

        /* Visually hidden but accessible to screen readers */
        .sr-only {
            position: absolute !important;
            width: 1px; height: 1px;
            padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0,0,0,0);
            white-space: nowrap; border: 0;
        }

        /* Hide the nav tab buttons visually while keeping them available to screen readers and JS */
        .nav-tabs .nav-tab {
            display: none !important;
        }

        /* Search button in header */
        .search-btn {
            background: transparent;
            border: 1px solid rgba(0,0,0,0.06);
            width: 42px;
            height: 42px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 8px;
            cursor: pointer;
            color: #333;
            transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease, color 160ms ease;
        }

        .search-btn i { font-size: 16px; transition: color 160ms ease; }

        .search-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(16,24,40,0.12);
            background: linear-gradient(90deg, #433c3a, #58483d);
            color: #fff;
        }

        .search-btn:hover i { color: #fff; }

        /* Back button style (placed before search) */
        .back-btn {
            background: transparent;
            border: 1px solid rgba(0,0,0,0.06);
            width: 42px;
            height: 42px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 8px 0 0;
            cursor: pointer;
            color: #333;
        }

        .back-btn i { font-size: 14px }

        /* Back button outside header wrapper */
        .back-outside-wrap {
            display: flex;
            justify-content: flex-start;
            padding: 12px 0 0 1280px;
        }

        /* Make the outside back button icon-only and red (no box) */
        .back-outside {
            background: #ffffff;
            border: 1px solid rgba(16,24,40,0.08);
            box-shadow: 0 8px 24px rgba(16,24,40,0.08);
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 120ms ease, box-shadow 120ms ease;
        }

        .back-outside:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(16,24,40,0.12); }

        .back-outside i {
            color: #e53935; /* red */
            font-size: 20px;
            line-height: 1;
        }

        header .logo img {
            border-radius: 50%;
            border: 3px solid #f2cdb9;
            height: 40px;
            width: 50px;
            object-fit: cover;
            margin-right: 10px;
        }

        header nav {
            flex: 1;
            display: flex;
            justify-content: center;
            margin: 0 20px;
        }

        header nav ul {
            list-style: none;
            display: flex;
            gap: 28px;
            margin: 0;
            padding: 0;
        }

        header nav ul li {
            display: inline;
        }

        header nav ul li a {
            color: #0f1720;
            text-decoration: none;
            font-weight: 600;
            position: relative;
            padding: 8px 12px;
            border-radius: 8px;
            transition: color 0.2s, background 0.18s, transform 0.12s;
        }

        header nav ul li a:hover {
            color: #0f1720;
            background: rgba(15,23,32,0.05);
            transform: translateY(-2px);
        }

        header nav ul li a::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -6px;
            width: 0;
            height: 2px;
            background: #0f1720;
            transform: translateX(-50%);
            transition: width 0.22s ease;
        }

        header nav ul li a:hover::after {
            width: 60%;
        }

        /* Header color modes: white text on home, dark text on other sections */
        header.header--white { color: #ffffff; }
        header.header--white nav ul li a { color: #ffffff; }
        header.header--white nav ul li a::after { background: #ffffff; }
        header.header--white .auth-buttons .login { color: #ffffff; border-color: rgba(255,255,255,0.12); }
        header.header--white .auth-buttons .signup { background: rgba(255,255,255,0.95); color: #0f1720; }
        header { transition: color 220ms ease; }

        .auth-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .auth-buttons button {
            border: none;
            padding: 8px 16px;
            font-size: 15px;
            cursor: pointer;
            border-radius: 999px;
            transition: background 0.18s, transform 0.12s;
            white-space: nowrap;
        }

        .auth-buttons button:hover {
            transform: translateY(-2px);
        }

        .auth-buttons .login {
            background: transparent;
            color: #0f1720;
            border: 1px solid rgba(15,23,32,0.06);
        }

        .auth-buttons .signup {
            background: #fff;
            color: #0f1720;
            padding: 8px 18px;
            font-weight: 700;
        }

        .hamburger {
            display: none;
            cursor: pointer;
            font-size: 22px;
            color: #0f1720;
        }

        .hero {
            background-image: url('img/bg.png');
            background-size: cover;
            width: 100%;
            height: 100vh;
            background-position: center;
            color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
        }

        .hero h1 {
            font-size: 56px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        .hero p {
            font-size: 20px;
            margin-bottom: 30px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }

        .hero .btn {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 25px;
            margin: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .hero .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }

        footer {
            background-color: rgba(51, 51, 51, 0.9);
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 14px;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
        }

        footer a {
            color: #ffd700;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Dashboard footer: keep it in normal flow and reveal when user scrolls near the page bottom */
        .dashboard-footer {
            position: relative; /* sit in normal document flow */
            width: 100%;
            background-color: rgba(51, 51, 51, 0.95);
            color: white;
            text-align: center;
            padding: 14px 16px;
            font-size: 13px;
            box-shadow: 0 -6px 16px rgba(0,0,0,0.18);
            transition: transform 260ms ease, opacity 260ms ease;
            transform: translateY(8px);
            opacity: 0;
            pointer-events: none;
        }

        /* Visible state when user scrolls near bottom */
        .dashboard-footer.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        /* Make a small default bottom padding for customer content; footer will not overlap content */
        #customerDashboard .main-content {
            padding-bottom: 30px; /* small breathing room when footer is hidden/visible */
        }

        /* Menu Section Styles */
        .menu-section {
            width: 100%;
            padding: 100px 20px 50px;
            text-align: center;
            background: linear-gradient(to bottom, #ffecd2, #fcb69f);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .menu-section h2 {
            font-size: 36px;
            margin-bottom: 30px;
            color: #ff4500;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .menu-items {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            max-width: 1200px;
            /* ensure the container fills most of the viewport so footer can sit at the bottom */
            min-height: calc(100vh - 120px);
        }

        .menu-item {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            padding: 20px;
            width: 270px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .menu-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }

        .menu-item img {
            width: 100%;
            border-radius: 15px;
            margin-bottom: 15px;
            height: 180px;
            object-fit: cover;
        }

        .menu-item h3 {
            margin: 0 0 10px;
            color: #333;
        }

        .menu-item p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }

        /* Reviews Section */
        .reviews-section {
            padding: 100px 20px 50px;
            background: #fff7f0;
            text-align: center;
        }

        .reviews-section h2 {
            color: #ff4500;
            font-size: 36px;
            margin-bottom: 30px;
        }

        .reviews-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .review-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            padding: 25px;
            width: 320px;
            min-width: 280px;
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .review-card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .stars {
            font-size: 2rem;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .review-text {
            font-style: italic;
            color: #555;
            margin-bottom: 15px;
        }

        .review-author {
            font-weight: 500;
            color: #ff4500;
        }

        /* Contact Section */
        .contact-section {
            position: relative;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 100px 20px 50px;
            overflow: hidden;
        }

        .contact-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%23ffffff" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="%23ffffff" opacity="0.1"/><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }

        .contact-overlay {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .contact-title {
            font-size: 3rem;
            color: #ff4500;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .contact-subtitle {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 50px;
            font-weight: 300;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }

        .contact-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(255, 69, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .contact-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 30px 60px rgba(255, 69, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            gap: 15px;
        }

        .card-header i {
            font-size: 2rem;
            color: #ff4500;
        }

        .card-header h3 {
            color: #ff4500;
            font-size: 1.5rem;
            margin: 0;
            font-weight: 600;
        }

        .contact-form {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            position: relative;
            margin-bottom: 25px;
        }

        .contact-form input,
        .contact-form textarea {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            background: #fff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-family: inherit;
        }

        .contact-form input:focus,
        .contact-form textarea:focus {
            border-color: #ff7e5f;
            box-shadow: 0 0 0 3px rgba(255, 126, 95, 0.1);
            outline: none;
        }

        .contact-form textarea {
            resize: vertical;
            min-height: 120px;
            width: 100%;
        }

        .contact-form input:hover,
        .contact-form textarea:hover {
            border-color: #ff7e5f;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 126, 95, 0.15);
        }

        .input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #ff4500;
            font-size: 1.2rem;
        }

        .contact-btn {
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .contact-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 126, 95, 0.3);
        }

        .info-list {
            margin-bottom: 30px;
        }

        .info-item {
            display: flex;
            align-items: stretch;
            gap: 0px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 126, 95, 0.05);
            border-radius: 10px;
            transition: background 0.3s ease;
            flex-direction: column;
            justify-content: space-evenly;
        }

        .info-item:hover {
            background: rgba(255, 126, 95, 0.1);
        }

        .info-item div {
            text-align: center;
        }

        .info-item strong {
            color: #ff4500;
            display: block;
            margin-bottom: 5px;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .social-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            color: #fff;
            border-radius: 50%;
            text-decoration: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            font-size: 1.2rem;
        }

        .social-link:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(255, 126, 95, 0.3);
        }

        /* Find Us Section */
        .find-us-section {
            position: relative;
            background: linear-gradient(135deg, #fcb69f 0%, #ffecd2 100%);
            padding: 100px 20px 50px;
            overflow: hidden;
        }

        .find-us-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="location-pattern" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="2" fill="%23ff4500" opacity="0.05"/><circle cx="80" cy="80" r="2" fill="%23ff4500" opacity="0.05"/><circle cx="50" cy="50" r="2" fill="%23ff4500" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23location-pattern)"/></svg>');
            pointer-events: none;
        }

        .find-us-overlay {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .find-us-title {
            font-size: 3rem;
            color: #ff4500;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .find-us-subtitle {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 50px;
            font-weight: 300;
        }

        .location-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
            align-items: start;
        }

        .location-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(255, 69, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .map-container {
            margin-bottom: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .location-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 126, 95, 0.05);
            border-radius: 10px;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        .detail-item:hover {
            background: rgba(255, 126, 95, 0.1);
            transform: translateY(-2px);
        }

        .detail-item i {
            color: #ff4500;
            font-size: 1.5rem;
            margin-top: 2px;
        }

        .detail-item h4 {
            color: #ff4500;
            margin: 0 0 5px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .detail-item p {
            margin: 0;
            color: #555;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .location-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(255, 69, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(255, 69, 0, 0.15);
        }

        .feature-card i {
            font-size: 2rem;
            color: #ff4500;
            margin-bottom: 10px;
        }

        .feature-card h4 {
            color: #ff4500;
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .feature-card p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .find-us-cta {
            margin-top: 40px;
            text-align: center;
        }

        .find-us-btn {
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            color: #fff;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            box-shadow: 0 8px 16px rgba(255, 126, 95, 0.3);
        }

        .find-us-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(255, 126, 95, 0.4);
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* Use the provided image as the login background (no overlay so image remains crisp) */
            background: url('img/bglogin.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #fff8f5; /* fallback */
            padding: 20px 12px;
        }

        .login-box, .signup-box {
            /* Warm-tinted, slightly translucent card for better legibility */
            background: rgba(255, 244, 239, 0.88); /* warm peach tint, slightly less opaque */
            color: #111; /* ensure strong contrast for text */
            border: 1px solid rgba(16, 24, 32, 0.06);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(2,6,23,0.12);
            padding: 40px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            font-size: 32px;
            font-weight: bold;
            color: #ff4500;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-title {
            font-size: 24px;
            margin-bottom: 30px;
            color: #333;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .login-form input, .login-form select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .login-form input:focus, .login-form select:focus {
            border-color: #ff4500;
            outline: none;
        }

        .login-btn {
            background: linear-gradient(to right, #ff4500, #ff6347);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: linear-gradient(to right, #e03e00, #ff4500);
            transform: translateY(-2px);
        }

        .login-footer {
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }

        /* Signup Page Styles */
        .signup-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* Use the same provided image as the signup background (no overlay so image remains crisp) */
            background: url('img/bglogin.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #fff8f5; /* fallback */
            padding: 20px 12px;
        }

        .signup-box {
            /* match login readable card with warm tint */
            background: rgba(255, 244, 239, 0.88);
            color: #111;
            border: 1px solid rgba(16, 24, 32, 0.06);
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(2,6,23,0.12);
            padding: 26px 28px;
            width: 100%;
            max-width: 400px; /* expanded form width */
            text-align: center;
            margin: 0 12px;
        }

        .signup-logo {
            font-size: 18px;
            font-weight: 700;
            color: #ff4500;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .signup-title {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .signup-form .form-group {
            margin-bottom: 10px;
            text-align: left;
        }

        .signup-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .signup-form input, .signup-form select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .signup-form input:focus, .signup-form select:focus {
            border-color: #ff4500;
            outline: none;
        }

        .signup-btn {
            background: linear-gradient(to right, #ff4500, #ff6347);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 6px;
            width: 100%;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 6px;
        }

        .signup-btn:hover {
            background: linear-gradient(to right, #e03e00, #ff4500);
            transform: translateY(-2px);
        }

        .signup-footer {
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }

        .signup-footer a {
            color: #ff4500;
            text-decoration: none;
            font-weight: 500;
        }

        .signup-footer a:hover {
            text-decoration: underline;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            /* soft peach background, subtle by default */
            background-color: rgba(255,126,95,0.12);
            color: #ff6b45; /* icon/text uses warm accent */
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            transition: background-color 0.2s, transform 0.12s, box-shadow 0.12s;
            z-index: 1000;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-button:hover {
            background-color: rgba(255,126,95,0.22);
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(255,126,95,0.08);
        }

        /* When the back-button is inside the auth card, position it there instead of fixed */
        .login-box, .signup-box {
            position: relative;
        }

        .login-box .back-button, .signup-box .back-button {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 40px;
            height: 40px;
            padding: 8px 10px;
            border-radius: 8px; /* softer rounded when inside card */
            z-index: 10;
        }

        .password-strength {
            margin-top: 0px;
            font-size: 12px;
            height: 1px;
        }

        .strength-weak {
            color: #ff4500;
        }

        .strength-medium {
            color: #ffa500;
        }

        .strength-strong {
            color: #28a745;
        }

        .error-message {
            color: #ff4500;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
            /* ensure dashboard content sits below any fixed header */
            padding-top: 96px; /* give extra space to account for centered pill and mobile spacing */
        }


        /* Dashboard backgrounds are transparent to allow underlying hero to show through
           and support an optional translucent overlay for better text legibility on busy backgrounds */
        .dashboard {
            /* dashboards share the transparent base; specific dashboards may override */
            background: transparent;
            min-height: 100vh;
            position: relative; /* required for overlay pseudo-element positioning */
        }

        /* Toggleable translucent overlay (non-interactive) applied to any dashboard when .overlay-on is present */
        .dashboard.overlay-on::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.28); /* subtle darkening */
            pointer-events: none; /* do not block interactions */
            z-index: 1;
            border-radius: inherit;
        }

        /* Ensure main content sits above the overlay when active */
        .dashboard.overlay-on .main-content {
            position: relative;
            z-index: 2;
        }

        /* Disable overlay specifically for Staff Dashboard: prevent the pseudo-element from rendering
           while leaving the overlay available for other dashboards (customer/admin). */
        #staffDashboard.overlay-on::before {
            /* remove pseudo-element content and any dimming for staff dashboard */
            content: none !important;
            background: transparent !important;
            pointer-events: none !important;
        }

        /* Small header toggle control styling */
        .overlay-toggle-btn {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.06);
            color: inherit;
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .overlay-toggle-btn.active {
            background: linear-gradient(90deg,#666,#66666691);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 6px 18px rgba(255,126,95,0.12);
        }

        /* Header Styles - centered pill like landing header */
        .dashboard-header {
            /* center the header as a pill */
            position: fixed;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 120px);
            max-width: 1100px;
            padding: 12px 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            /* transparent like landing header */
            background-color: transparent;
            color: #0f1720; /* dark text by default to match landing page when transparent */
            border: 1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(6px);
            border-radius: 999px;
            box-shadow: none;
        }

        .dashboard-header .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .dashboard-header .logo img {
            border-radius: 50%;
            border: 3px solid #f2cdb9;
            height: 40px;
            width: 40px;
            object-fit: cover;
            margin-right: 10px;
        }

        .logo-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            margin-left: 10px;
        }

        .nav-tabs {
            display: flex;
            gap: 20px;
            /* absolutely center the tabs so they remain visually centered between logo and actions */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            pointer-events: auto;
        }

        /* On small screens, revert to normal flow so tabs don't overlap logo/actions */
        @media (max-width: 760px) {
            .nav-tabs {
                position: static;
                transform: none;
                margin: 0;
                justify-content: flex-start;
                gap: 12px;
            }
            .dashboard-header { padding: 12px; }
        }

        .nav-tab {
            background: none;
            border: none;
            color: inherit; /* use header color so pill header shows dark text */
            font-size: 16px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 20px;
            transition: background-color 0.3s, transform 0.12s;
            will-change: transform;
            position: relative; /* allow underline pseudo-element */
        }

        .nav-tab.active {
            background-color: rgba(15,23,32,0.06);
        }

        .nav-tab:hover {
            background-color: rgba(15,23,32,0.04);
            transform: translateY(-2px);
        }

        /* Underline bar similar to landing header nav a::after */
        .nav-tab::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -6px;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: currentColor;
            transition: width 0.22s ease;
            border-radius: 2px;
        }

        .nav-tab:hover::after {
            width: 60%;
        }

        /* When header is in white mode (over dark background), force white text and underline */
        .dashboard-header.header--white {
            color: #ffffff;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .cart-btn {
            position: relative;
            background: none;
            border: none;
            color: inherit;
            font-size: 20px;
            cursor: pointer;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ffd700;
            color: #333;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .my-orders-btn {
            background: rgba(15,23,32,0.06);
            color: inherit;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }

        .my-orders-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .my-orders-btn.active {
            background: rgba(255, 255, 255, 0.4);
        }

        .logout-btn {
            background: #333;
            border: none;
            color: #ffffff;
            font-size: 16px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: rgba(15, 23, 32, 0.06);
            color: #0a0808;
        }

        /* Main Content Styles */
        .main-content {
            padding: 0px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .section-title {
            font-size: 28px;
            margin-bottom: 20px;
            color: #000000bd;
            text-align: center;
        }

        /* Menu Section */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(245px, 1fr));
            gap: 32px;
            margin-top: 70px;
        }

        .menu-item {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .menu-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .menu-item-content {
            padding: 20px;
        }

        .menu-item h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .menu-item p {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .menu-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price {
            font-size: 18px;
            font-weight: bold;
            color: #ff4500;
        }

        .add-to-cart-btn {
            background-color: #ff4500;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .add-to-cart-btn:hover {
            background-color: #e03e00;
        }

        /* Orders Section */
        .orders-container {
            margin-top: 20px;
        }

        .order-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: none !important;
        }

        .order-card:hover {
            transform: none !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .order-id {
            font-weight: bold;
            color: #333;
            font-size: 18px;
        }

        .order-date {
            color: #666;
            font-size: 14px;
        }

        .order-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-preparing {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-out-for-delivery {
            background-color: #d4edda;
            color: #155724;
        }

        .status-delivered {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .order-items {
            margin-bottom: 15px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            transition: none !important;
            animation: none !important;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 18px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .order-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .detail-row {
            display: flex;
            margin-bottom: 8px;
        }

        .detail-label {
            font-weight: bold;
            min-width: 140px;
            color: #555;
        }

        .detail-value {
            flex: 1;
        }

        .no-orders {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Order Actions Styles */
        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .track-order-btn {
            background-color: #ff4500;
            color: rgb(255, 81, 0);
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }

        .track-order-btn:hover {
            background-color: #e03e00;
            color: rgb(255, 255, 255);
        }

        .view-details-btn {
            background-color: #6c757d;
            color: rgb(113, 106, 106);
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }

        .view-details-btn:hover {
            background-color: #5a6268;
            color: rgb(255, 255, 255);
        }

        /* Staff Dashboard Styles (responsive & organized) */
        .staff-header {
            /* transparent header so underlying hero/brand can show through */
            background-color: transparent;
            color: #0f1720; /* dark text for better contrast on light backgrounds */
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            /* subtle frosted backdrop for legibility */
            backdrop-filter: blur(6px) saturate(1.05);
            border-bottom: 1px solid rgba(16,24,40,0.06);
        }

        .staff-header .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
            color: #0f1720; /* match header text color */
        }

        .staff-header .logo img {
            height: 44px;
            width: 44px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid rgba(16,24,40,0.06);
        }

        .staff-header .actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .staff-header .actions button {
            background: none;
            border: 1px solid rgba(16,24,40,0.08);
            color: #0f1720;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.18s ease;
        }

        .staff-header .actions button:hover {
            background: rgba(16,24,40,0.04);
            color: #0f1720;
        }

        /* Controls & Stats row above orders */
        .staff-orders {
            padding: 28px 18px;
            background: linear-gradient(180deg,#ffffff,#fff8f3);
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
            margin: 20px auto;
            max-width: 1100px;
        }

        .staff-orders h2 {
            text-align: center;
            margin-bottom: 18px;
            font-size: 26px;
            color: #222; /* darker for better contrast */
            font-weight: 700;
            text-shadow: 0 1px 0 rgba(255,255,255,0.6);
        }

        .staff-controls {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        .staff-search {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1 1 360px;
        }

        .staff-search input[type="search"] {
            flex: 1;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #eee;
            box-shadow: inset 0 1px 2px rgba(16,24,40,0.03);
            font-size: 14px;
        }

        .staff-filters {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: white;
            border: 1px solid #ffd8c8;
            color: #ff5d33;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 6px 18px rgba(255, 94, 59, 0.06);
        }

        .staff-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 18px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            box-shadow: 0 6px 18px rgba(16,24,40,0.04);
            border-left: 4px solid rgba(255,69,0,0.12);
        }

        .stat-card .value {
            font-size: 20px;
            font-weight: 700;
            color: #111111; /* darker for better contrast in dashboards */
        }

        .stat-card .label {
            font-size: 12px;
            color: #777;
        }

        .order-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
        }

        /* Improved order-item layout */
        .order-item {
            background: #ffffff;
            border-radius: 10px;
            padding: 10px; /* compact padding */
            display: flex;
            gap: 10px;
            align-items: flex-start;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
            border: 1px solid rgba(0,0,0,0.04);
            overflow: hidden;
        }

        .order-item:hover {
            transform: translateY(-6px);
            box-shadow: 0 14px 30px rgba(16,24,40,0.06);
        }

        .order-left {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            flex: 1 1 60%;
        }

        .order-avatar {
            width: 56px;
            height: 56px;
            border-radius: 10px;
            object-fit: cover;
            background: linear-gradient(45deg,#fff3e6,#fff9f2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff4500;
            font-weight: 700;
        }

        .order-body {
            flex: 1;
        }

        .order-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            color: #666;
            font-size: 13px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .order-title {
            font-size: 16px;
            margin: 0 0 4px 0;
            color: #222;
            font-weight: 700;
        }

        .items-list {
            color: #444;
            font-size: 14px;
            line-height: 1.4;
        }

        .order-total-amount {
            margin-top: 8px;
            color: #111111; /* ensure total is clearly visible */
            font-weight: 700;
        }

        .order-contact {
            color: #111111; /* darker for high contrast */
            font-size: 13px;
        }

        .order-date {
            color: #111111; /* darker date color for visibility */
            font-size: 13px;
            font-weight: 600;
        }

        .order-right {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            min-width: 160px;
        }

        .status-badge {
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 13px;
            color: white;
            transition: none !important;
            animation: none !important;
        }

        .badge-pending { background: #ffb74d; color: #6a4200; }
        .badge-preparing { background: #64b5f6; color: #072a4a; }
        .badge-out { background: #81c784; color: #083910; }
        .badge-delivered { background: #90caf9; color: #04314f; }

        .order-actions {
            display: flex;
            gap: 8px;
            width: 100%;
            justify-content: flex-end;
        }

        .order-actions button, .order-actions select {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid #eee;
            background: white;
            cursor: pointer;
        }

        .order-actions .update-btn {
            background: linear-gradient(90deg,#ff7e5f,#feb47b);
            border: none;
            color: #fff;
            font-weight: 700;
        }

        /* Wider screens: two-column layout for orders */
        @media (min-width: 800px) {
            .order-list { grid-template-columns: repeat(2, 1fr); }
            .order-right { align-items: flex-end; }
        }

        /* Small screens tweaks */
        @media (max-width: 600px) {
            .staff-header { padding: 10px 12px; }
            .staff-header .logo img { height: 40px; width: 40px; }
            .staff-orders { padding: 18px 12px; }
            .staff-orders h2 { font-size: 22px; }
            .order-list { grid-template-columns: 1fr; }
            .order-right { min-width: 120px; align-items: flex-end; }
        }

        /* Admin Dashboard Styles */
        .admin-header {
            background: linear-gradient(to right, #ff4500, #ff6347);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* When in the admin dashboard view we use the sidebar for navigation - hide the top admin header */
        #adminDashboard .admin-header {
            display: none;
        }

        .admin-header .logo {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .admin-header .logo i {
            margin-right: 12px;
        }

        .admin-header .actions button {
            background: none;
            border: 2px solid white;
            color: white;
            font-size: 16px;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-header .actions button:hover {
            background: white;
            color: #ff4500;
        }

        .admin-dashboard {
            padding: 0; /* container will provide spacing */
            margin: 12px auto 0; /* reduce top space so admin panel sits closer to top */
            max-width: 4200px;
        }

        /* Reduce extra top gap when admin view is active (header is hidden) */
        #adminDashboard {
            padding-top: 8px; /* small breathing room instead of large header offset */
            margin-top: 0;
        }

        /* Staff-specific override: remove extra top gap and make top corners square so the
           staff dashboard content sits flush to the top (does not affect other dashboards) */
        #staffDashboard {
            padding-top: 8px !important; /* override global .dashboard padding-top */
            margin-top: 0 !important;
        }

        /* Fullscreen mode for Staff Dashboard. When the element has the `fullscreen` class
           it will expand to cover the entire viewport. This keeps the rules scoped to
           #staffDashboard only and does not affect other dashboards. */
        #staffDashboard.fullscreen {
            position: fixed !important;
            inset: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
            z-index: 2000 !important;
            background: linear-gradient(180deg, #fff6f0, #fff) !important;
            overflow: hidden !important;
            border-radius: 0 !important;
        }

        /* Make the inner two-column layout fill the available fullscreen space */
        #staffDashboard.fullscreen .staff-container {
            max-width: none !important;
            width: 100% !important;
            height: calc(100vh - 64px) !important; /* leave room for top controls if any */
            margin: 0 !important;
            padding: 8px 12px !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        /* Make main column scrollable while keeping sidebar sticky inside fullscreen */
        #staffDashboard.fullscreen .staff-main {
            height: 100% !important;
            overflow: auto !important;
            padding: 12px 16px !important;
        }

        #staffDashboard.fullscreen .staff-sidebar {
            height: calc(100vh - 64px) !important;
            position: sticky !important;
            top: 64px !important;
            overflow: auto !important;
            background: rgba(255,255,255,0.02) !important;
        }

        /* Make the staff container sit nearer the viewport top */
        #staffDashboard .staff-container {
            margin-top: 0;
            padding-top: 6px;
        }

        /* Remove the top corner rounding and reduce top padding inside the main orders panel
           so the heading visually sits close to the top edge */
        #staffDashboard .staff-orders {
            margin-top: 0;
            padding-top: 8px;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }

        /* Make the staff dashboard use the same color palette as the admin dashboard
           without affecting other dashboards. This scopes the admin-like gradient,
           button styles and accents to #staffDashboard only. */
        #staffDashboard .staff-header {
            background: linear-gradient(to right, #ff4500, #ff6347);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #staffDashboard .staff-header .logo { color: #fff; }
        #staffDashboard .staff-header .logo img { border-color: rgba(255,255,255,0.14); }

        #staffDashboard .staff-header .actions button {
            background: none;
            border: 2px solid white;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
        }

        #staffDashboard .staff-header .actions button:hover {
            background: white;
            color: #ff4500;
        }

        /* Staff topbar hidden: removed visual top bar above staff container */
        .staff-dashboard .staff-topbar { display: none !important; }

        /* Pizzalicious badge (logo + text) shown inside staff dashboard */
        .pizzalicious-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            color: #000000;
            font-size: 20px;
            margin: 12px 0;
        }

        .pizzalicious-badge img {
            height: 44px;
            width: 44px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid rgba(16,24,40,0.06);
            background: white;
            padding: 2px;
        }

        /* Slight responsive shrink on small screens */
        @media (max-width: 600px) {
            .pizzalicious-badge { font-size: 16px; gap: 8px; }
            .pizzalicious-badge img { height: 36px; width: 36px; }
        }
        /* Slight spacing tweak when badge is used inside the staff sidebar */
        .staff-sidebar .sidebar-badge {
            display: flex;
            align-items: center;
            margin: 6px 0 8px 0;
            padding-left: 4px;
        }

        /* Make the main orders panel feel aligned with admin palette (soft warm background)
           and use the admin accent for headings */
        #staffDashboard .staff-orders {
            background: rgba(255,244,239,0.96);
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.06);
        }

        #staffDashboard .staff-orders h2 {
            color: #ff4500;
            font-weight: 800;
        }

        /* Stronger accent on stat cards within staff views */
        #staffDashboard .stat-card {
            border-left: 4px solid rgba(255,69,0,0.18);
        }

        /* Buttons and filter chips in staff should use the admin gradient */
        #staffDashboard .filter-btn,
        #staffDashboard .sidebar-btn.admin-btn {
            background: linear-gradient(90deg,#ff4500,#ff6347);
            color: #fff;
            border: none;
            box-shadow: 0 8px 20px rgba(255,69,0,0.08);
        }

        #staffDashboard .filter-btn:hover,
        #staffDashboard .sidebar-btn.admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 26px rgba(255,69,0,0.12);
        }

        /* Accessibility / contrast improvements (staff dashboard only)
           - Darken text, increase contrast of interactive controls and badges
           - Keep the warm peach palette but ensure sufficient contrast for readability
        */
        #staffDashboard .staff-sidebar {
            background: transparent !important;
            color: #222222; /* dark text for soft white container */
            border: none;
        }

        #staffDashboard .staff-sidebar .sidebar-logo span {
            color: #ff4500; /* brand accent for logo text */
            font-weight: 700;
        }

        #staffDashboard .staff-sidebar .sidebar-btn {
            color: #222222; /* dark button text for readability */
            background: transparent;
            border: 1px solid rgba(16,24,40,0.06);
        }

        #staffDashboard .staff-sidebar .sidebar-btn.active {
            background: linear-gradient(90deg,#ff9a6b,#ff7e5f);
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 8px 20px rgba(255,126,95,0.12);
        }

        #staffDashboard .staff-orders {
            background: linear-gradient(180deg,#ffffff,#fff6f1);
            color: #111111;
        }

        /* Header that shows Staff Dashboard and the section title side-by-side */
        .staff-orders-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
        }

        .staff-dashboard-title {
            font-size: 26px;
            font-weight: 800;
            color: #000000;
            margin: 0;
        }

        .staff-orders-widget {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 700;
            color: #111;
            background: linear-gradient(90deg, #fff, #fffaf6);
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(16,24,40,0.04);
            box-shadow: 0 6px 18px rgba(16,24,40,0.04);
            white-space: nowrap;
            align-self: flex-start; /* ensure widget aligns left when header is stacked */
        }

        /* orders-count removed */

        .staff-orders-widget .orders-title-text {
            color: #1c1b1a;
        }

        /* orders-count rule removed */

        /* Desktop: keep the widget left under the Staff Dashboard title */

        #staffDashboard .staff-orders h2 {
            color: #1c1b1a; /* accent color for Manage Orders heading */
            text-shadow: none;
        }

        #staffDashboard .stat-card {
            background: #ffffff;
            color: #222222;
            border-left-color: rgba(255,126,95,0.18);
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
        }

        #staffDashboard .stat-card .value { color: #111111; }
        #staffDashboard .stat-card .label { color: #666666; }

        #staffDashboard .order-item {
            background: #ffffff;
            color: #222222;
            border: 1px solid rgba(0,0,0,0.04);
        }

        #staffDashboard .order-item .order-title,
        #staffDashboard .order-item .order-meta,
        #staffDashboard .order-item .items-list {
            color: #111111;
        }

        /* Improve badge contrast */
        #staffDashboard .status-badge.badge-pending { background-color: #ffb74d; color: #5a3700; }
        #staffDashboard .status-badge.badge-preparing { background-color: #2b7bd6; color: #ffffff; }
        #staffDashboard .status-badge.badge-out { background-color: #2e9f5a; color: #ffffff; }
        #staffDashboard .status-badge.badge-delivered { background-color: #63a6d6; color: #ffffff; }

        /* Buttons inside orders should be clearly visible */
        #staffDashboard .order-actions .update-btn,
        #staffDashboard .order-actions .track-order-btn {
            color: #ffffff;
            background: linear-gradient(90deg,#ff7e5f,#feb47b);
            border: none;
        }

        /* Ensure small meta text remains readable */
        #staffDashboard .order-meta, #staffDashboard .detail-value { color: #444444; }

        /* New admin two-column layout */
        /* Make the admin container background match the dark sidebar so the layout feels cohesive */
        .admin-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            padding: 30px 20px;
            background: #ffffff; /* match sidebar dark slate */
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(2,6,23,0.45);
            border: 1px solid rgba(255,255,255,0.03);
        }

        /* Staff two-column sidebar layout (mirrors the admin sidebar pattern) */
        .staff-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            /* reduced vertical padding to bring content closer to the top */
            padding: 12px 20px;
            /* smaller top margin so the main panel sits nearer the viewport top */
            margin: 6px auto 0;
            max-width: 1200px;
            /* soft off-white background for staff dashboard */
            background: #fbfbfb;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(16,24,40,0.04);
            border: 1px solid rgba(16,24,40,0.04);
        }

        /* Global staff text color: dark text on soft white container */
        #staffDashboard { color: #111111; }

        /* Staff main panel: translucent dark panel so headings and content read well */
        #staffDashboard .staff-orders {
            background: rgba(255,255,255,0.04) !important;
            color: rgba(255,255,255,0.92) !important;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.03);
        }

        /* Ensure the main heading uses the accent and remains visible */
        #staffDashboard .staff-orders h2 {
            color: #0a0a0a !important;
            text-shadow: none;
        }

        /* Sidebar brand text lighter for better contrast */
        #staffDashboard .staff-sidebar .sidebar-logo span {
            color: #ffd1b8 !important;
        }

        /* Make small meta text and footer readable on dark background */
        #staffDashboard .order-meta,
        #staffDashboard .detail-value,
        #staffDashboard footer,
        #staffDashboard .staff-main p { color: rgba(255,255,255,0.76) !important; }

        .staff-sidebar {
            flex: 0 0 240px; /* fixed column width in the two-column layout */
            width: 240px;
            /* transparent so dark staff container shows through */
            background: transparent;
            /* light text for contrast against the dark staff container */
            color: rgba(255,255,255,0.92);
            border-radius: 10px;
            padding: 14px;
            /* remove inner shadow - container shadow is primary */
            box-shadow: none;
            /* make sidebar sticky so buttons remain visible while scrolling */
            position: sticky;
            top: 96px; /* leave room for topbar/header */
            height: calc(100vh - 112px);
            overflow: auto; /* allow sidebar to scroll internally if content exceeds viewport */
            align-self: flex-start; /* keep sidebar height independent of main column */
            /* subtle inner border to separate sidebar from main panel */
            border-right: 1px solid rgba(255,255,255,0.03);
        }

        .staff-sidebar .sidebar-logo { display:flex; align-items:center; gap:10px; margin-bottom:12px; }

        .staff-sidebar .sidebar-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: transparent;
            /* light border for contrast on dark background */
            border: 1px solid rgba(255,255,255,0.04);
            cursor: pointer;
            color: inherit;
        }

        .staff-sidebar .sidebar-btn:hover {
            transform: translateY(-2px);
            background: rgba(255,255,255,0.03);
            color: #fff;
        }

        /* Staff logout button: soft red background for clear CTA */
        #staffDashboard .staff-sidebar .sidebar-btn[onclick="logout()"] {
            background: linear-gradient(90deg,#c32a2a74,#ff6b6b);
            color: #ffffff;
            border: none;
            box-shadow: 0 8px 20px rgba(255,107,107,0.12);
        }

        #staffDashboard .staff-sidebar .sidebar-btn[onclick="logout()"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 26px rgba(255,107,107,0.16);
            filter: brightness(0.98);
        }

        .staff-sidebar .sidebar-btn.active {
            /* use the admin orange gradient for active state so it reads on dark */
            background: linear-gradient(90deg,#ff7e5f,#feb47b);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 8px 20px rgba(255,126,95,0.12);
        }

    .staff-main { flex: 1; padding-top: 6px; display: flex; flex-direction: column; }

    /* push footer to the bottom of the staff main area */
    #staffDashboard .staff-main footer { margin-top: auto; }

    /* Slightly adapt staff orders content so it fits nicely inside the main column */
    .staff-orders { padding: 12px 8px; }

    /* Tighter order card sizing for staff dashboard so cards fit the panel padding */
    #staffDashboard .order-list {
        display: grid;
        /* Force two cards per row on wide screens */
        grid-template-columns: repeat(2, 1fr);
        gap: 12px; /* tightened gap to make cards denser */
        align-items: start;
        /* make all grid rows equal height so cards line up */
        grid-auto-rows: 1fr;
    }

    /* Make order cards a bit smaller and more compact */
    /* Standardize card height and internal layout for visual consistency */
    #staffDashboard .order-item {
        padding: 12px 14px;
        border-radius: 10px;
        max-width: 100%;
        /* fixed, consistent height so cards line up */
        height: 300px;
        display: flex;
        flex-direction: row;
        gap: 12px;
        box-sizing: border-box;
        /* subtle accent line across the top of each order card */
        border-top: 4px solid rgba(255,126,95,0.12);
    }

    /* Reduce right column min-width so cards can fit side-by-side better */
    #staffDashboard .order-right { min-width: 110px; display: flex; flex-direction: column; align-items: flex-end; }

    /* let the left content take remaining space and distribute vertically */
    #staffDashboard .order-left { flex: 1 1 auto; display:flex; flex-direction:column; justify-content:space-between; overflow:hidden; }

    /* make long item lists scroll inside the card so card height remains fixed */
    #staffDashboard .items-list { max-height: 120px; overflow: auto; }

    /* Responsive card height adjustments */
    @media (max-width: 1000px) {
        #staffDashboard .order-item { height: 280px; }
    }
    @media (max-width: 420px) {
        #staffDashboard .order-item { height: 240px; }
    }

    /* Compact responsive typography for staff cards */
    /* Order title: slightly smaller baseline and tight margins */
    #staffDashboard .order-title { font-size: clamp(13px, 1.2vw, 18px); margin-bottom: 4px; font-weight:700; }
    /* Order ID smaller and less dominant */
    #staffDashboard .order-id { font-size: clamp(12px, 1.0vw, 14px); font-weight:600; color:#222; }
    /* Items list and meta: smaller, readable sizes */
    #staffDashboard .items-list { font-size: clamp(12px, 1vw, 14px); color:#444; max-height:120px; overflow:auto; }
    #staffDashboard .order-meta { font-size: clamp(11px, 0.9vw, 13px); color: #666; }
    /* Right column compact text and smaller controls */
    #staffDashboard .order-right { font-size: clamp(12px, 0.9vw, 13px); min-width: 90px; }
    #staffDashboard .order-avatar { width:44px; height:44px; border-radius:8px; }
    .status-badge { padding:6px 8px; font-size:12px; }
    .order-actions button, .order-actions select { padding:6px 8px; font-size:12px; }

    /* Reduce staff orders container padding for a compact look */
    .staff-orders { padding: 16px 12px; }

    /* Slightly smaller card heights for compact layout */
    @media (min-width: 1001px) {
        #staffDashboard .order-item { height: 376px; }
    }
    @media (max-width: 1000px) {
        #staffDashboard .order-item { height: 220px; }
    }
    @media (max-width: 420px) {
        #staffDashboard .order-item { height: 200px; }
    }

    /* Small-screen tweaks */
    @media (max-width: 480px) {
        #staffDashboard .order-item { padding:8px; gap:8px; }
        #staffDashboard .order-right { min-width: 80px; }
        #staffDashboard .items-list { max-height: 80px; }
        #staffDashboard .staff-stats .value { font-size: clamp(16px, 3.5vw, 22px); }
    }

    /* Reduce top spacing for headings inside staff dashboard */
    #staffDashboard h2 { margin-top: 4px; }

        /* High-contrast/dark admin sidebar for better readability */
        .admin-sidebar {
            width: 240px;
            background: #ffffff; /* dark slate background for strong contrast */
            color: #040404; /* sidebar text color */
            border-radius: 10px;
            padding: 14px;
            box-shadow: 0 8px 24px rgba(2,6,23,0.45);
            position: sticky;
            top: 20px; /* reduced because header is hidden in admin view */
            height: calc(100vh - 140px);
            overflow: auto;
        }

        .admin-sidebar .sidebar-logo {
            display:flex; align-items:center; gap:10px; margin-bottom:12px;
            color: inherit;
        }
        /* Make the Pizzalicious brand text use the warm accent in admin view */
        .admin-sidebar .sidebar-logo span {
            color: #000000;
            font-weight: 800;
            font-size: 18px;
        }
        .admin-header .logo span {
            color: #000000;
            font-weight: 800;
        }

        .admin-sidebar .sidebar-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.98);
            cursor: pointer;
            color: inherit;
        }

        .admin-sidebar .sidebar-btn:hover {
            transform: translateY(-2px);
            background: rgba(255,255,255,0.04);
        }

        .admin-sidebar .sidebar-btn.active {
            background: linear-gradient(90deg,#000000,#010101);
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 6px 18px rgba(255,126,95,0.12);
        }

        /* Make sure buttons and links inside the sidebar inherit readable colors */
        .admin-sidebar a, .admin-sidebar button, .admin-sidebar .sidebar-logo span {
            color: inherit;
        }

        /* Responsive: stack sidebar above main content on smaller screens */
        @media (max-width: 1000px) {
            #staffDashboard .staff-container {
                flex-direction: column;
                padding: 12px;
                margin: 8px auto 0;
            }

            #staffDashboard .staff-sidebar {
                width: 100%;
                position: relative;
                top: 0;
                height: auto;
                display: flex;
                gap: 8px;
                align-items: center;
                padding: 10px;
                border-radius: 10px;
                margin-bottom: 12px;
                overflow: visible;
                border-right: none;
                border-bottom: 1px solid rgba(255,255,255,0.03);
            }

            #staffDashboard .staff-sidebar .sidebar-logo { flex: 0 0 auto; }
            /* Keep buttons stacked and readable (full-width) instead of inline */
            #staffDashboard .staff-sidebar .sidebar-btn { display: block; width: 100%; padding: 10px 12px; margin-bottom: 8px; font-size: 16px; }

            #staffDashboard .staff-main { width: 100%; }

            /* collapse order cards to single column for narrow screens */
            #staffDashboard .order-list { grid-template-columns: 1fr !important; gap: 18px; }

            /* make order cards span full width and reduce padding */
            #staffDashboard .order-item { padding: 12px; }

            /* reduce main panel paddings and heading sizes */
            #staffDashboard .staff-orders { padding: 14px; }
            #staffDashboard .staff-orders h2 { font-size: 22px; }

            /* footer spacing */
            #staffDashboard .staff-main footer { margin-top: 18px; }
        }

        /* Small phones: further reduce paddings and font sizes */
        @media (max-width: 420px) {
            #staffDashboard .staff-orders { padding: 10px; }
            #staffDashboard .staff-orders h2 { font-size: 18px; }
            #staffDashboard .order-item { padding: 10px; }
            /* Keep button text legible on small phones */
            #staffDashboard .staff-sidebar .sidebar-btn { padding: 10px 12px; font-size: 15px; }
            #staffDashboard .staff-sidebar { padding: 8px; }
        }

        /* Slightly style the scrollbar for the dark sidebar (nice-to-have) */
        .admin-sidebar::-webkit-scrollbar { width: 10px; }
        .admin-sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 8px; }

        .admin-main { flex: 1; }

        .admin-panel {
            padding: 22px;
            /* semi-transparent panel so the dark container shows through but content remains readable */
            background: rgba(255,255,255,0.06);
            backdrop-filter: blur(6px);
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(2,6,23,0.12);
            border: 1px solid rgba(255,255,255,0.06);
            color: #111; /* ensure text remains dark for readability */
        }

        /* Make the Admin Dashboard title align with panel content (left-aligned) */
        .admin-dashboard h2 {
            text-align: left;
            margin: 0 0 18px 0; /* tighten spacing and align with section headings */
            font-size: 28px;
            color: #000000;
        }

        .admin-section {
            margin-bottom: 40px;
        }

        /* Hide admin sections until user explicitly opens them */
        .admin-dashboard .admin-section { display: none; }
        .admin-dashboard .admin-section.active { display: block; }

        .admin-section h3 {
            margin-bottom: 20px;
            /* use a light color so the heading remains visible over the translucent dark panel */
            color: rgba(46, 31, 31, 0.92);
            border-bottom: 2px solid #020202;
            padding-bottom: 10px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .admin-table th, .admin-table td {
            border: 1px solid #02020295;
            padding: 12px;
            text-align: left;
        }

        .admin-table th {
            background-color: #e9e1df;
            color: white;
        }

        .admin-table img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }

        .admin-btn {
            background: linear-gradient(to right, #ff4500, #ff6347);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s ease;
            margin-right: 10px;
        }

        .admin-btn:hover {
            background: linear-gradient(to right, #e03e00, #ff4500);
        }

        .admin-btn.delete {
            background: #dc3545;
        }

        .admin-btn.delete:hover {
            background: #c82333;
        }

        /* Cart Modal */
        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .cart-modal.active {
            display: flex;
        }

        .cart-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .cart-title {
            font-size: 22px;
            color: #333;
        }

        .close-cart {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .cart-items {
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .cart-item-price {
            color: #ff4500;
            font-weight: bold;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            background: none;
            border: 1px solid #ddd;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .cart-item-quantity {
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .remove-item {
            color: #ff4500;
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 10px;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 18px;
            padding: 15px 0;
            border-top: 1px solid #eee;
        }

        .checkout-btn {
            background-color: #ff4500;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 15px;
        }

        .checkout-btn:hover {
            background-color: #e03e00;
        }

        .empty-cart {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        /* Address Modal */
        .address-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .address-modal.active {
            display: flex;
        }

        .address-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .address-title {
            font-size: 22px;
            color: #333;
        }

        .close-address {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .order-summary {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .order-summary h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .address-form {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .continue-payment-btn {
            background-color: #ff4500;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 15px;
        }

        .continue-payment-btn:hover {
            background-color: #e03e00;
        }

        /* Payment Modal */
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .payment-modal.active {
            display: flex;
        }

        .payment-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .payment-title {
            font-size: 22px;
            color: #333;
        }

        .close-payment {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .payment-methods {
            margin-bottom: 25px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }

        .payment-method.selected {
            border-color: #ff4500;
            background-color: #fff5f0;
        }

        .payment-method:hover {
            border-color: #ff4500;
        }

        .payment-icon {
            width: 40px;
            height: 40px;
            background-color: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
            color: #666;
        }

        .payment-details {
            flex: 1;
        }

        .payment-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .payment-desc {
            font-size: 14px;
            color: #666;
        }

        .payment-form {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .payment-form.active {
            display: block;
        }

        .confirm-payment-btn {
            background-color: #ff4500;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 15px;
        }

        .confirm-payment-btn:hover {
            background-color: #e03e00;
        }

        /* Success Modal */
        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .success-modal.active {
            display: flex;
        }

        .success-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .success-icon {
            font-size: 64px;
            color: #28a745;
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 15px;
        }

        .success-message {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .order-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .order-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .order-info-label {
            font-weight: bold;
            color: #555;
        }

        .order-info-value {
            color: #333;
        }

        .success-buttons {
            display: flex;
            gap: 15px;
        }

        .view-orders-btn {
            background-color: #ff4500;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            flex: 1;
        }

        .view-orders-btn:hover {
            background-color: #e03e00;
        }

        .continue-shopping-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            flex: 1;
        }

        .continue-shopping-btn:hover {
            background-color: #5a6268;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s, slideOutRight 0.3s 2.7s;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }

        /* Enhanced styling for Track Order section */
        .track-order-container {
            background: #ffffff3b;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
        }

        .order-search {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .order-search input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .order-search button {
            background-color: #ff4500;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .order-search button:hover {
            background-color: #e03e00;
        }

        .tracking-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tracking-id {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .tracking-status {
            font-size: 16px;
            font-weight: bold;
            color: #ff4500;
        }

        .tracking-timeline {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .tracking-step {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tracking-step.completed .step-icon {
            background-color: #28a745;
            color: white;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background-color 0.3s;
        }

        .step-details {
            flex: 1;
        }

        .step-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .step-description {
            font-size: 14px;
            color: #666;
        }

        /* Styling for Browse Pizzas section */
        .filter-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .filter-search {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .filter-dropdown {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .pizza-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .pizza-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .pizza-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .pizza-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .pizza-details {
            padding: 15px;
            text-align: center;
        }

        .pizza-details h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .pizza-details p {
            color: #ff4500;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .add-to-cart-btn {
            background-color: #ff4500;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .add-to-cart-btn:hover {
            background-color: #e03e00;
        }

        /* Auth Form Styles */
        .auth-form-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: relative;
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 50%, #667eea 100%);
            background-attachment: fixed;
        }

        .auth-form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url(bg.jpg) no-repeat center center;
            background-size: cover;
            opacity: 0.1;
            z-index: -1;
        }

        .auth-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(255, 69, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 450px;
            width: 90%;
            text-align: center;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Landing page hero entrance animations */
        @keyframes floatUpDown {
            0% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
            100% { transform: translateY(0); }
        }

        .hero h1 {
            opacity: 0;
            transform: translateY(18px);
            transition: transform 700ms cubic-bezier(.2,.9,.2,1), opacity 500ms ease;
        }

        .hero p {
            opacity: 0;
            transform: translateY(12px);
            transition: transform 600ms cubic-bezier(.2,.9,.2,1), opacity 450ms ease;
            color: rgba(255,255,255,0.95);
        }

        .auth-buttons {
            opacity: 0;
            transform: translateY(10px);
            transition: transform 600ms ease, opacity 600ms ease;
        }

        /* applied classes when animation triggers */
        .hero-headline-animate {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        .hero-subtitle-animate {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        .hero-cta-animate {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        /* subtle floating for hero indicator/logo for life */
        .logo-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            margin-left: 8px;
            animation: floatUpDown 7.6s ease-in-out infinite;
        }

        .auth-form h2 {
            color: #ff4500;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
        }

        .auth-form .form-group {
            position: relative;
            margin-bottom: 25px;
        }

        .auth-form input,
        .auth-form select {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            background: #fff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-family: inherit;
        }

        .auth-form input:focus,
        .auth-form select:focus {
            border-color: #ff7e5f;
            box-shadow: 0 0 0 3px rgba(255, 126, 95, 0.1);
            outline: none;
        }

        .auth-form .input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #ff4500;
            font-size: 1.2rem;
        }

        .auth-form button {
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-weight: 600;
            margin-top: 20px;
            width: 100%;
        }

        .auth-form button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 126, 95, 0.3);
        }

        .auth-form p {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .auth-form a {
            color: #ff4500;
            text-decoration: none;
        }

        .auth-form a:hover {
            text-decoration: underline;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            /* soft peach background, subtle by default */
            background-color: rgba(255,126,95,0.12);
            color: #ff6b45; /* icon/text uses warm accent */
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            transition: background-color 0.2s, transform 0.12s, box-shadow 0.12s;
            z-index: 1000;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-button:hover {
            background-color: rgba(255,126,95,0.22);
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(255,126,95,0.08);
        }

        /* Responsive Styles */
        @media (max-width: 1200px) {
            .hero h1 {
                font-size: 48px;
            }
            
            .contact-title, .find-us-title {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 992px) {
            .hero h1 {
                font-size: 42px;
            }
            
            .hero p {
                font-size: 18px;
            }
            
            .contact-grid, .location-container {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .location-details {
                grid-template-columns: 1fr;
            }
            
            .location-features {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: row;
                padding: 10px 15px;
            }
            
            .hamburger {
                display: block;
            }
            
            header nav {
                display: none;
                position: absolute;
                top: 70px;
                left: 0;
                width: 100%;
                background-color: rgba(255, 69, 0, 0.95);
                padding: 20px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            
            header nav.active {
                display: flex;
            }
            
            header nav ul {
                flex-direction: column;
                width: 100%;
                text-align: center;
            }
            
            .auth-buttons {
                display: flex;
                flex-direction: row;
                gap: 10px;
                justify-content: center;
            }
            
            .hero h1 {
                font-size: 36px;
            }
            
            .hero p {
                font-size: 16px;
            }
            
            .menu-section h2, .reviews-section h2 {
                font-size: 30px;
            }
            
            .contact-title, .find-us-title {
                font-size: 2rem;
            }
            
            .contact-subtitle, .find-us-subtitle {
                font-size: 1rem;
            }
            
            .contact-card {
                padding: 30px 20px;
            }
            
            .location-features {
                grid-template-columns: 1fr;
            }

            .detail-item div {
                text-align: left;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .nav-tabs {
                order: 3;
                width: 100%;
                justify-content: center;
            }

            .header-actions {
                order: 2;
                width: 100%;
                justify-content: space-between;
            }

            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .success-buttons {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .pizza-grid {
                grid-template-columns: 1fr;
            }

            .order-actions {
                flex-direction: column;
            }

            .order-list {
                grid-template-columns: 1fr;
            }

            .admin-table {
                display: block;
                overflow-x: auto;
            }
        }

        @media (max-width: 576px) {
            .hero h1 {
                font-size: 28px;
            }
            
            .hero p {
                font-size: 14px;
            }
            
            .menu-section h2, .reviews-section h2 {
                font-size: 26px;
            }
            
            .contact-title, .find-us-title {
                font-size: 1.8rem;
            }
            
            .menu-item, .review-card {
                width: 100%;
                max-width: 300px;
            }
            
            .auth-form {
                width: 95%;
                padding: 15px;
            }
            
            .contact-btn, .find-us-btn {
                width: 100%;
                justify-content: center;
            }

            .menu-grid {
                grid-template-columns: 1fr;
            }

            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        @media (max-width: 400px) {
            .hero h1 {
                font-size: 24px;
            }
            
        /* Desktop-only: style Manage Orders as a blue pill (matches screenshot) */
        @media (min-width: 601px) {
            #staffDashboard .staff-orders h2 {
                display: inline-block;
                background: linear-gradient(90deg,#2b6be6,#3b82f6);
                color: #ffffff;
                padding: 10px 20px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(59,130,246,0.12);
                font-weight: 800;
                font-size: 28px;
            }
        }
            .hero .btn {
                padding: 10px 20px;
                font-size: 16px;
            }
            
            .menu-section h2, .reviews-section h2 {
                font-size: 22px;
            }
            
            .contact-title, .find-us-title {
                font-size: 1.5rem;
            }
            
            .card-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .social-links {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .auth-buttons button {
                padding: 8px 15px;
                font-size: 14px;
            }
        }
    </style>
    <!-- Chart.js for analytics charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Chart.js DataLabels plugin (shows percentage labels inside pie slices) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        // Try to register DataLabels early so it's available before charts are created.
        try {
            if (window.Chart && window.ChartDataLabels) {
                // Avoid double-registering
                if (!window.__chartjs_datalabels_registered) {
                    Chart.register(ChartDataLabels);
                    window.__chartjs_datalabels_registered = true;
                    console.debug('ChartDataLabels registered');
                }
            }
        } catch (e) {
            console.warn('ChartDataLabels registration failed or not available', e);
        }
    </script>
</head>
<body>
    <!-- Landing Page -->
    <div id="landingPage" class="landing-page">
        <header>
            <div class="logo">
                <img src="img/logo.png" alt="Pizzalicious Logo" style="height: 50px;">
                <span>Pizzalicious</span>
            </div>
            <nav id="main-nav">
                <ul>
                    <li><a href="#home">Home</a></li>
                    <li><a href="#menu">Menu</a></li>
                    <li><a href="#reviews">Reviews</a></li>
                    <li><a href="#contact">Contact</a></li>
                    <li><a href="#find-us">Find Us</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <button class="login-button" onclick="showLoginPage()">Login</button>
                <button class="btn" onclick="showSignUpPage()">Sign Up</button>
            </div>
            <div class="hamburger" onclick="toggleMenu()">
                &#9776;
            </div>
        </header>

        <section id="home" class="hero">
            <h1>Welcome to Pizzalicious Pizza</h1>
            <p>Order your favorite pizzas online and get them delivered to your doorstep!</p>
        </section>

        <section id="menu" class="menu-section">
            <h2>Our Menu</h2>
            <div class="menu-items">
                <div class="menu-item">
                    <img src="img/margharita1.jpg" alt="Margherita Pizza">
                    <h3>Margherita Pizza</h3>
                    <p>A classic delight with fresh tomatoes, mozzarella, and basil.</p>
                </div>
                <div class="menu-item">
                    <img src="img/pepperoni.jpg" alt="Pepperoni Pizza">
                    <h3>Pepperoni Pizza</h3>
                    <p>Loaded with pepperoni and cheese for a savory treat.</p>
                </div>
                <div class="menu-item">
                    <img src="img/Veggie-Supreme.png" alt="Veggie Supreme">
                    <h3>Veggie Supreme</h3>
                    <p>A healthy choice with bell peppers, olives, and onions.</p>
                </div>
                <div class="menu-item">
                    <img src="img/bbq-chicken-pizza.jpg" alt="BBQ Chicken Pizza">
                    <h3>BBQ Chicken Pizza</h3>
                    <p>Grilled chicken, BBQ sauce, and red onions for a smoky flavor.</p>
                </div>
                <div class="menu-item">
                    <img src="img/hawaiian.jpg" alt="Hawaiian Pizza">
                    <h3>Hawaiian Pizza</h3>
                    <p>Ham and pineapple for a sweet and savory combination.</p>
                </div>
                <div class="menu-item">
                    <img src="img/four-cheese.jpg" alt="Four Cheese Pizza">
                    <h3>Four Cheese Pizza</h3>
                    <p>A rich blend of mozzarella, cheddar, parmesan, and gouda.</p>
                </div>
                <div class="menu-item">
                    <img src="img/spicy-italian-pizza.jpg" alt="Spicy Italian Pizza">
                    <h3>Spicy Italian Pizza</h3>
                    <p>Spicy sausage, jalapeos, and a fiery tomato sauce.</p>
                </div>
                <div class="menu-item">
                    <img src="img/mushroom-delight.jpg" alt="Mushroom Delight Pizza">
                    <h3>Mushroom Delight Pizza</h3>
                    <p>Fresh mushrooms, garlic, and a creamy white sauce.</p>
                </div>
            </div>
        </section>

        <!-- Reviews Section -->
        <section id="reviews" class="reviews-section">
            <h2>Customer Reviews</h2>
            <div class="reviews-container">
                <div class="review-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>
                    </div>
                    <p class="review-text">"The Margherita pizza was so fresh and delicious! Fast delivery and friendly staff. Will order again!"</p>
                    <div class="review-author">- Sarah L.</div>
                </div>
                <div class="review-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                    <p class="review-text">"Best pepperoni pizza in town! The crust was perfect and the cheese was so gooey. Highly recommend."</p>
                    <div class="review-author">- Mike D.</div>
                </div>
                <div class="review-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                    <p class="review-text">"Loved the Veggie Supreme! Fresh ingredients and great flavors. My kids enjoyed it too."</p>
                    <div class="review-author">- Priya S.</div>
                </div>
                <div class="review-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                    <p class="review-text">"Quick delivery and the BBQ Chicken pizza was amazing. Will definitely order again!"</p>
                    <div class="review-author">- John R.</div>
                </div>
                <div class="review-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>
                    </div>
                    <p class="review-text">"The Hawaiian pizza was a delightful surprise! The perfect balance of sweet and savory."</p>
                    <div class="review-author">- Emma T.</div>
                </div>
                <div class="review-card">
                    <div class="stars">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                    <p class="review-text">"Four Cheese pizza is my new favorite! So cheesy and delicious. Highly recommend!"</p>
                    <div class="review-author">- Alex M.</div>
                </div>
            </div>
        </section>

        <!-- Contact Section -->
        <section id="contact" class="contact-section">
            <div class="contact-overlay">
                <h2 class="contact-title">Get In Touch</h2>
                <p class="contact-subtitle">We'd love to hear from you! Send us a message or visit us.</p>
                <div class="contact-grid">
                    <div class="contact-card contact-form-card">
                        <div class="card-header">
                            <i class="fas fa-envelope-open-text"></i>
                            <h3>Send Message</h3>
                        </div>
                        <form class="contact-form">
                            <div class="form-group">
                                <input type="text" id="name" name="name" placeholder="Your Name" required>
                                <i class="fas fa-user input-icon"></i>
                            </div>
                            <div class="form-group">
                                <input type="email" id="email" name="email" placeholder="Your Email" required>
                                <i class="fas fa-envelope input-icon"></i>
                            </div>
                            <div class="form-group">
                                <textarea id="message" name="message" placeholder="Your Message" required></textarea>
                                <i class="fas fa-comment input-icon"></i>
                            </div>
                            <button type="submit" class="contact-btn">
                                <i class="fas fa-paper-plane"></i>
                                Send Message
                            </button>
                        </form>
                    </div>
                    <div class="contact-card contact-info-card">
                        <div class="card-header">
                            <i class="fas fa-info-circle"></i>
                            <h3>Contact Info</h3>
                        </div>
                        <div class="info-list">
                            <div class="info-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <div>
                                    <strong>Address</strong><br>
                                    Mabini, Batangas<br>
                                    Philippines
                                </div>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-phone"></i>
                                <div>
                                    <strong>Phone</strong><br>
                                    (+63) 916 796 5239
                                </div>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-envelope"></i>
                                <div>
                                    <strong>Email</strong><br>
                                    pizzalicious@gmail.com
                                </div>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <div>
                                    <strong>Hours</strong><br>
                                    Mon-Sun: 9AM - 11PM
                                </div>
                            </div>
                        </div>
                        <div class="social-links">
                            <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                            <a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Find Us Section -->
        <section id="find-us" class="find-us-section">
            <div class="find-us-overlay">
                <h2 class="find-us-title">Find Us</h2>
                <p class="find-us-subtitle">Visit our location in Mabini, Batangas and enjoy the best pizza in the Philippines!</p>
                <div class="location-container">
                    <div class="location-card">
                        <div class="map-container">
                            <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
                                <input id="mapSearch" type="text" placeholder="Search address or place (e.g. Malimatoc 2)" style="flex:1; padding:10px 12px; border-radius:10px; border:1px solid #e6e6e9;" />
                                <button id="mapSearchBtn" class="find-us-btn" style="padding:9px 14px; border-radius:10px;">Search</button>
                            </div>
                            <div id="map" style="width:100%; height:340px; border-radius:15px;"></div>

                            <!-- Get Directions button placed near the map for easier access -->
                            <div style="margin-top:12px;">
                                <a id="getDirectionsBtn" href="https://www.google.com/maps/dir/?api=1&destination=Mabini+Batangas" target="_blank" class="find-us-btn">
                                    <i class="fas fa-directions"></i>
                                    Get Directions
                                </a>
                            </div>

                        </div>
                        <div class="location-details">
                            <div class="detail-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <div>
                                    <h4>Address</h4>
                                    <p>Malimatoc 2, Mabini, Batangas - Philippines</p>
                                </div>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-route"></i>
                                <div>
                                    <h4>Directions</h4>
                                    <p>Located in the heart of Mabini, Batangas. Easily accessible from major highways.</p>
                                </div>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-parking"></i>
                                <div>
                                    <h4>Parking</h4>
                                    <p>Ample parking available in our lot and nearby streets.</p>
                                </div>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-subway"></i>
                                <div>
                                    <h4>Public Transport</h4>
                                    <p>Accessible by jeepneys, tricycles, and buses from nearby towns.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="location-features">
                        <div class="feature-card">
                            <i class="fas fa-utensils"></i>
                            <h4>Dine-In</h4>
                            <p>Comfortable seating for up to 50 guests</p>
                        </div>
                        <div class="feature-card">
                            <i class="fas fa-truck"></i>
                            <h4>Delivery</h4>
                            <p>Fast delivery within Mabini and nearby areas</p>
                        </div>
                        <div class="feature-card">
                            <i class="fas fa-shopping-bag"></i>
                            <h4>Takeout</h4>
                            <p>Quick pickup service available</p>
                        </div>
                        <div class="feature-card">
                            <i class="fas fa-birthday-cake"></i>
                            <h4>Events</h4>
                            <p>Perfect for parties and celebrations</p>
                        </div>
                    </div>
                    </div>
            </div>
        </section>

        <footer>
            <p>&copy; 2025 Pizza Online. All rights reserved. <a href="#">Privacy Policy</a></p>
        </footer>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="login-container" style="display: none;">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-pizza-slice"></i>
                <span>Pizzalicious</span>
            </div>
            <h2 class="login-title">Welcome Back!</h2>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email or Username</label>
                    <input type="text" id="loginEmail" placeholder="Enter your email or username" required>
                    <div class="error-message" id="loginEmailError">Please enter your email or username</div>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                    <div class="error-message" id="loginPasswordError">Please enter your password</div>
                </div>
                <!-- Role is auto-detected on login based on the username -->
                <div class="error-message" id="loginError">Invalid credentials. Please try again or sign up for a new account.</div>
                <button type="submit" class="login-btn">Login</button>
            </form>
            <!-- Social login buttons (Google) -->
            <div class="social-login" style="margin-top:18px; text-align:center;">
                <div id="googleSignInButton" style="display:inline-block; margin-bottom:8px;"></div>
                <div id="socialMessage" style="margin-top:10px; font-size:14px; color:#333;"></div>
            </div>
            <div class="login-footer">
                <p>Don't have an account? <a href="#" onclick="showSignUpPage()">Sign up here</a></p>
            </div>
            <button class="back-button" onclick="goToLandingPage()"></button>
        </div>
    </div>

    <!-- Signup Page -->
    <div id="signupPage" class="signup-container" style="display: none;">
        <div class="signup-box">
            <div class="signup-logo">
                <i class="fas fa-pizza-slice"></i>
                <span>Pizzalicious</span>
            </div>
            <h2 class="signup-title">Create Your Account</h2>
            <form class="signup-form" id="signupForm">
                <div class="form-group">
                    <label for="usernameSignup">Username</label>
                    <input type="text" id="usernameSignup" placeholder="Choose a username" required>
                    <div class="error-message" id="usernameError">Username must be at least 3 characters</div>
                </div>
                <div class="form-group">
                    <label for="emailSignup">Email</label>
                    <input type="email" id="emailSignup" placeholder="you@gmail.com" required>
                    <div class="error-message" id="emailError">Please provide a valid email address</div>
                </div>
                <div class="form-group">
                    <label for="passwordSignup">Password</label>
                    <input type="password" id="passwordSignup" placeholder="Create a password" required>
                    <div class="password-strength" id="passwordStrength"></div>
                    <div class="error-message" id="passwordError">Password must be at least 6 characters</div>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                    <div class="error-message" id="confirmPasswordError">Passwords do not match</div>
                </div>
                <!-- Google sign-up button -->
                <div class="social-signup" style="margin-top:18px; text-align:center;">
                    <div id="googleSignUpButton" style="display:inline-block; margin-bottom:8px;"></div>
                    <div id="signupSocialMessage" style="margin-top:10px; font-size:14px; color:#333;"></div>
                </div>
                <div class="form-group">
                    <!-- Account type removed: all signups are Customers by default -->
                </div>
                <button type="submit" class="signup-btn">Create Account</button>
            </form>
            <div class="signup-footer">
                <p>Already have an account? <a href="#" onclick="showLoginPage()">Login here</a></p>
            </div>
            <button class="back-button" onclick="goToLandingPage()"></button>
        </div>
    </div>

    <!-- Customer Dashboard -->
    <div id="customerDashboard" class="dashboard">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="logo">
                <img src="img/logo.png" alt="Pizzalicious Logo">
                <span>Pizzalicious</span>
                <span class="logo-indicator" title="Status: Active"></span>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="menu" aria-label="Menu">
                    <span class="sr-only">Menu</span>
                </button>
                <button class="nav-tab" data-tab="track-order" aria-label="Track Order">
                    <span class="sr-only">Track Order</span>
                </button>
                <button class="nav-tab" data-tab="browse-pizzas" aria-label="Browse Pizzas" title="Browse Pizzas">
                    <span class="sr-only">Browse Pizzas</span>
                </button>
            </div>
            
            <div class="header-actions">
                <button class="search-btn" id="searchBtn" aria-label="Search" title="Search">
                    <i class="fas fa-search" aria-hidden="true"></i>
                </button>
                <button class="my-orders-btn" id="myOrdersBtn">
                    <i class="fas fa-clipboard-list"></i>
                    My Orders
                </button>
                <button class="cart-btn" id="cartButton">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </button>
                <!-- Overlay toggle: improves readability on busy backgrounds -->
                <button id="toggleOverlayBtn" class="overlay-toggle-btn" aria-pressed="false" title="Toggle reading overlay">
                    <i class="fas fa-adjust"></i>
                </button>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        </header>

        <!-- Back to Menu (outside header) -->
        <div class="back-outside-wrap">
            <button class="back-outside back-btn" id="backToMenuBtn" aria-label="Close" title="Close">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Menu Section -->
            <section id="menu" class="section active">
                <h2 class="section-title">Our Delicious Pizzas</h2>
                <div class="menu-grid" id="menuGrid">
                    <!-- Menu items will be dynamically loaded here -->
                </div>
            </section>

            <!-- Orders Section -->
            <section id="orders" class="section">
                <h2 class="section-title">My Orders</h2>
                <div style="margin-top:12px; margin-bottom:8px;">
                    <button id="clearCustomerOrdersBtn" class="admin-btn delete" onclick="clearOrderHistory()">Clear Order History</button>
                </div>
                <div class="orders-container" id="ordersContainer">
                    <!-- Orders will be dynamically loaded here -->
                </div>
            </section>

            <!-- Track Order Section -->
            <section id="track-order" class="section">
                <h2 class="section-title">Track Your Order</h2>
                <div class="track-order-container">
                    <div class="order-search">
                        <input type="text" id="orderSearch" placeholder="Enter your order ID">
                        <button id="searchOrderBtn">Track Order</button>
                    </div>
                    <div id="trackingResult">
                        <!-- Tracking information will be displayed here -->
                    </div>
                </div>
            </section>

            <!-- Browse Pizzas Section -->
            <section id="browse-pizzas" class="section">
                <h2 class="section-title">Browse Pizzas</h2>
                <div class="filter-container">
                    <input type="text" id="pizzaSearch" class="filter-search" placeholder="Search for pizzas...">
                    <select id="pizzaFilter" class="filter-dropdown">
                        <option value="all">All</option>
                        <option value="vegetarian">Vegetarian</option>
                        <option value="non-vegetarian">Non-Vegetarian</option>
                        <option value="cheese">Cheese Lovers</option>
                    </select>
                </div>
                <div class="pizza-grid" id="pizzaGrid">
                    <!-- Pizzas will be dynamically loaded here -->
                </div>
            </section>
        </div>

        <!-- Cart Modal -->
        <div class="cart-modal" id="cartModal">
            <div class="cart-content">
                <div class="cart-header">
                    <h3 class="cart-title">Your Cart</h3>
                    <button class="close-cart" id="closeCart">&times;</button>
                </div>
                <div class="cart-items" id="cartItems">
                    <!-- Cart items will be dynamically loaded here -->
                </div>
                <div class="cart-total">
                    <span>Total:</span>
                    <span id="cartTotal">0.00</span>
                </div>
                <button class="checkout-btn" id="checkoutBtn">Proceed to Checkout</button>
            </div>
        </div>

        <!-- Address Modal -->
        <div class="address-modal" id="addressModal">
            <div class="address-content">
                <div class="address-header">
                    <h3 class="address-title">Delivery Address</h3>
                    <button class="close-address" id="closeAddress">&times;</button>
                </div>
                
                <div class="order-summary">
                    <h4>Order Summary</h4>
                    <div id="addressOrderItems">
                        <!-- Order items will be dynamically loaded here -->
                    </div>
                    <div class="summary-total">
                        <span>Total:</span>
                        <span id="addressOrderTotal">0.00</span>
                    </div>
                </div>
                
                <form class="address-form" id="addressForm">
                    <div class="form-group">
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" placeholder="Enter your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="phoneNumber">Phone Number *</label>
                        <input type="tel" id="phoneNumber" placeholder="Enter your phone number" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="streetAddress">Street Address *</label>
                        <input type="text" id="streetAddress" placeholder="House/Unit No., Street Name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="provinceSelect">Province *</label>
                        <select id="provinceSelect" required>
                            <option value="">Choose province</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="citySelect">City/Municipality *</label>
                            <select id="citySelect" required>
                                <option value="">Choose city/municipality</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="barangaySelect">Barangay *</label>
                            <select id="barangaySelect" required>
                                <option value="">Choose barangay</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="zipCode">ZIP Code *</label>
                        <input type="text" id="zipCode" placeholder="Enter ZIP code" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveryInstructions">Delivery Instructions (Optional)</label>
                        <textarea id="deliveryInstructions" placeholder="Any special instructions for delivery"></textarea>
                    </div>
                </form>
                
                <button class="continue-payment-btn" id="continuePaymentBtn">Continue to Payment</button>
            </div>
        </div>

        <!-- Payment Modal -->
        <div class="payment-modal" id="paymentModal">
            <div class="payment-content">
                <div class="payment-header">
                    <h3 class="payment-title">Select Payment Method</h3>
                    <button class="close-payment" id="closePayment">&times;</button>
                </div>
                
                <div class="order-summary">
                    <h4>Order Summary</h4>
                    <div id="paymentOrderItems">
                        <!-- Order items will be dynamically loaded here -->
                    </div>
                    <div class="summary-total">
                        <span>Total:</span>
                        <span id="paymentOrderTotal">0.00</span>
                    </div>
                </div>
                        <!-- Voucher / Promo Code -->
                        <div class="voucher-row" style="margin-top:12px; display:flex; gap:8px; align-items:center;">
                            <input type="text" id="voucherInput" placeholder="Enter voucher code" style="flex:1; padding:8px; border-radius:8px; border:1px solid #e6e6e9;" />
                            <button class="admin-btn" id="applyVoucherBtn">Apply</button>
                        </div>
                        <div id="voucherMessage" style="margin-top:8px; color:#fff; display:none; background:rgba(0,0,0,0.2); padding:8px 10px; border-radius:8px;">Voucher applied</div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-method="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash on Delivery</div>
                            <div class="payment-desc">Pay with cash when your order arrives</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="card">
                        <div class="payment-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Credit/Debit Card</div>
                            <div class="payment-desc">Pay securely with your card</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="gcash">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">GCash</div>
                            <div class="payment-desc">Pay using your GCash wallet</div>
                        </div>
                    </div>
                </div>
                
                <!-- Credit Card Form -->
                <div class="payment-form" id="cardForm">
                    <div class="form-group">
                        <label for="cardNumber">Card Number</label>
                        <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiryDate">Expiry Date</label>
                            <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV</label>
                            <input type="text" id="cvv" placeholder="123" maxlength="3">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cardName">Name on Card</label>
                        <input type="text" id="cardName" placeholder="John Doe">
                    </div>
                </div>
                
                <!-- GCash Form -->
                <div class="payment-form" id="gcashForm">
                    <div class="form-group">
                        <label for="gcashNumber">GCash Mobile Number</label>
                        <input type="text" id="gcashNumber" placeholder="09XX XXX XXXX" maxlength="11">
                    </div>
                    <div class="form-group">
                        <label for="gcashName">Account Name</label>
                        <input type="text" id="gcashName" placeholder="As registered in GCash">
                    </div>
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">Confirm Payment</button>
            </div>
        </div>

        <!-- Success Modal -->
        <div class="success-modal" id="successModal">
            <div class="success-content">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="success-title">Order Placed Successfully!</h2>
                <p class="success-message">Thank you for your order! Your pizza is being prepared and will be delivered soon.</p>
                
                <div class="order-info" id="successOrderInfo">
                    <!-- Order details will be dynamically loaded here -->
                </div>
                
                <div class="success-buttons">
                    <button class="view-orders-btn" id="viewOrdersBtn">View My Orders</button>
                    <button class="continue-shopping-btn" id="continueShoppingBtn">Continue Shopping</button>
                </div>
            </div>
        </div>
        <!-- Confirmation Modal (reusable) -->
        <div class="payment-modal" id="confirmModal" aria-hidden="true">
            <div class="payment-content">
                <div class="payment-header">
                    <h3 class="payment-title">Please confirm</h3>
                    <button class="close-payment" id="closeConfirmModal">&times;</button>
                </div>
                <div style="padding:12px 0;">
                    <p id="confirmMessage" style="margin:0; font-size:15px; color:#333">Are you sure?</p>
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
                    <button class="admin-btn delete" id="confirmNoBtn">Cancel</button>
                    <button class="admin-btn" id="confirmYesBtn">Confirm</button>
                </div>
            </div>
        </div>
        <!-- Restore Backup Modal -->
        <div class="payment-modal" id="restoreModal" aria-hidden="true">
            <div class="payment-content">
                <div class="payment-header">
                    <h3 class="payment-title">Restore from Backup</h3>
                    <button class="close-payment" id="closeRestoreModal">&times;</button>
                </div>
                <div style="padding:12px 0; max-height:360px; overflow:auto;">
                    <p style="margin:0 0 8px; color:#333">Select a backup to restore. Only the latest backup for each type is shown.</p>
                    <ul id="restoreList" style="list-style:none; padding:0; margin:8px 0; display:flex; flex-direction:column; gap:8px;"></ul>
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
                    <button class="admin-btn delete" id="restoreCancelBtn">Close</button>
                </div>
            </div>
        </div>

        <footer class="dashboard-footer">
            <p>&copy; 2025 Pizza Online. All rights reserved. <a href="#">Privacy Policy</a></p>
        </footer>
        <script>
            (function(){
                // Show the dashboard footer only when the customer dashboard is visible
                // and the user has scrolled near the bottom of the page.
                const footer = document.querySelector('.dashboard-footer');
                const customer = document.getElementById('customerDashboard');
                if (!footer || !customer) return;

                // Ensure footer starts hidden
                footer.classList.remove('visible');

                function updateFooterVisibility() {
                    try {
                        const custVisible = customer.style.display !== 'none' && document.body.contains(customer);
                        if (!custVisible) { footer.classList.remove('visible'); return; }

                        const nearBottom = (window.innerHeight + window.scrollY) >= (document.documentElement.scrollHeight - 120);
                        if (nearBottom) footer.classList.add('visible'); else footer.classList.remove('visible');
                    } catch (e) { /* ignore */ }
                }

                // Fast evaluate on load and when resizing/scrolling
                setTimeout(updateFooterVisibility, 150);
                window.addEventListener('scroll', updateFooterVisibility, { passive: true });
                window.addEventListener('resize', updateFooterVisibility);

                // Re-evaluate when the customer dashboard display style changes
                try {
                    const mo = new MutationObserver(updateFooterVisibility);
                    mo.observe(customer, { attributes: true, attributeFilter: ['style'] });
                } catch (e) { /* ignore */ }
            })();
        </script>
    </div>

    <!-- Staff Dashboard (left sidebar layout) -->
    <div id="staffDashboard" class="dashboard">
        <section class="staff-dashboard">
            <div class="staff-topbar">
                <div class="topbar">
                    <div class="topbar-left">
                            <img src="img/logo.png" alt="logo" class="topbar-logo" />
                            <div class="topbar-text">
                                <div class="topbar-title">Staff Dashboard</div>
                                <div class="topbar-subtitle">Overview  Manage orders and staff tasks</div>
                            </div>
                        </div>
                    <div class="topbar-actions">
                        <div class="topbar-meta">Today: <span id="topbarDate">--</span></div>
                    </div>
                </div>
            </div>
            <script>
                try {
                    const el = document.getElementById('topbarDate');
                    if (el) el.textContent = new Date().toLocaleDateString();
                } catch(e){}
            </script>
            <div class="staff-container">
                <aside class="staff-sidebar">
                    <div class="sidebar-logo" aria-hidden="true"></div>
                    <!-- Pizzalicious logo + text badge (moved into sidebar to align with buttons) -->
                    <div class="pizzalicious-badge sidebar-badge" aria-hidden="false">
                        <img src="img/logo.png" alt="Pizzalicious logo" />
                        <span>Pizzalicious</span>
                    </div>
                    <nav style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
                        <button id="staffOrdersBtn" class="sidebar-btn"> <i class="fas fa-list" style="margin-right:8px;"></i> Orders</button>
                        <button id="staffStatsBtn" class="sidebar-btn"> <i class="fas fa-chart-line" style="margin-right:8px;"></i> Stats</button>
                        <!-- Analytics view: chart + filters -->
                        <!-- Analytics now embedded inside the Stats view -->
                        <button id="clearLoginHistoryBtnStaff" class="sidebar-btn admin-btn delete"> <i class="fas fa-trash" style="margin-right:8px;"></i> Clear History</button>
                        <!-- overlay control removed for staff dashboard (overlay disabled for staff) -->
                        <button onclick="logout()" class="sidebar-btn"> <i class="fas fa-sign-out-alt" style="margin-right:8px;"></i> Logout</button>
                    </nav>
                    <div style="margin-top:12px; font-size:13px; color:#666;">Quick actions and controls.</div>
                </aside>

                <main class="staff-main">
                    <!-- Stats Section (main content) -->
                    <section id="staffStatsSection" class="staff-section" style="display:none;">
                        <h2>Staff Overview</h2>
                        <div class="staff-stats" aria-hidden="false">
                            <div class="stat-card">
                                <div class="value" id="statTotalOverview">--</div>
                                <div class="label">Total Orders</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="statPendingOverview">--</div>
                                <div class="label">Pending</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="statPreparingOverview">--</div>
                                <div class="label">Preparing</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="statOutOverview">--</div>
                                <div class="label">Out for Delivery</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="statRevenueOverview">--</div>
                                <div class="label">Total Revenue</div>
                            </div>
                        </div>

                        <div style="margin-top:14px;">
                            <p style="color:#666;">Quick overview of recent orders and activity. Use the Orders view to manage individual orders.</p>
                        </div>

                        <!-- Embedded Analytics Controls & Chart -->
                        <div class="analytics-controls" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:12px;margin-bottom:12px;">
                            <label style="font-size:14px;color:#666;">Range:</label>
                            <select id="analyticsRange" style="padding:8px;border-radius:8px;border:1px solid #eee;">
                                <option value="day">Day</option>
                                <option value="month" selected>Month</option>
                                <option value="year">Year</option>
                            </select>

                            <label style="font-size:14px;color:#666;">Date:</label>
                            <input id="analyticsDate" type="date" style="padding:8px;border-radius:8px;border:1px solid #eee;" />

                            <button id="analyticsApplyBtn" class="filter-btn">Apply</button>
                        </div>

                        <div style="background:linear-gradient(180deg,#ffffff,#fff8f3);border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,0.04);">
                            <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:stretch;">
                                <div style="flex:2;min-width:320px;">
                                    <canvas id="staffAnalyticsChart" width="800" height="300" style="width:100%;height:320px;"></canvas>
                                </div>
                                <div style="flex:1;min-width:220px;display:flex;flex-direction:column;gap:12px;">
                                    <div style="flex:1;display:flex;align-items:center;justify-content:center;">
                                        <canvas id="staffStatusPieChart" width="300" height="300" style="width:100%;max-width:360px;height:160px;"></canvas>
                                    </div>
                                    <div style="flex:1;min-width:220px;display:flex;flex-direction:column;align-items:stretch;justify-content:center;">
                                        <div style="text-align:center;padding:6px 8px;color:#333;font-weight:700;">Top Sales</div>
                                        <div style="flex:1;display:flex;align-items:center;justify-content:center;">
                                            <canvas id="staffTopSalesChart" width="300" height="220" style="width:100%;max-width:360px;height:120px;"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Analytics embedded in Stats view (removed separate section) -->

                    <!-- Orders Section (main content) -->
                    <section class="staff-orders">
                        <div class="staff-orders-header">
                            <h2 class="staff-dashboard-title">Staff Dashboard</h2>
                            <div class="staff-orders-widget" title="Manage Orders">
                                <div class="orders-icon"><i class="fas fa-box-open" aria-hidden="true"></i></div>
                                <div class="orders-title-text">Manage Orders</div>
                                
                            </div>
                        </div>

                        <!-- Quick stats removed -->

                        <div class="order-list" id="staffOrderList" aria-live="polite">
                            <!-- Orders will be dynamically loaded here -->
                        </div>
                    </section>

                    <footer style="margin-top:18px; text-align:center; color:#666;">
                        <p>&copy; 2025 Pizza Online. All rights reserved. <a href="#">Privacy Policy</a></p>
                    </footer>
                </main>
            </div>
        </section>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard">
        <!-- Header -->
        <header class="admin-header">
            <div class="logo">
                <img src="img/logo.png" alt="Pizzalicious Logo" />
                <span>Pizzalicious</span>
            </div>
            <div class="actions">
                <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <!-- Dashboard Section with Sidebar -->
        <section class="admin-dashboard">
            <div class="admin-container">
                <aside class="admin-sidebar">
                    <div class="sidebar-logo">
                        <img src="img/logo.png" alt="logo" style="height:40px;width:40px;border-radius:8px;border:2px solid #f2cdb9;object-fit:cover;" />
                        <div style="font-weight:700;color:#000000;">Pizzalicious</div>
                    </div>
                    <nav style="margin-top:6px;">
                        <button id="manageMenuBtn" class="sidebar-btn admin-btn"> <i class="fas fa-utensils" style="margin-right:8px;"></i> Manage Menu</button>
                        <button id="manageUsersBtn" class="sidebar-btn admin-btn"> <i class="fas fa-users" style="margin-right:8px;"></i> Manage Users</button>
                        <button id="viewHistoryBtn" class="sidebar-btn admin-btn"> <i class="fas fa-history" style="margin-right:8px;"></i> Login History</button>
                        <button id="openRestoreBtnAdmin" class="sidebar-btn admin-btn"> <i class="fas fa-undo" style="margin-right:8px;"></i> Restore</button>
                        <button onclick="logout()" class="sidebar-btn admin-btn delete"> <i class="fas fa-sign-out-alt" style="margin-right:8px;"></i> Logout</button>
                    </nav>
                    <div style="margin-top:12px; font-size:13px; color:#666;">Quick actions and backups are here.</div>
                </aside>

                <div class="admin-main">
                    <div class="admin-panel">
                        <h2>Admin Dashboard</h2>
                        <!-- Admin revenue display removed (staff-only control remains) -->

            <!-- Manage Menu Items -->
            <div class="admin-section" id="adminMenuSection">
                <h3>Manage Menu Items</h3>
                <table class="admin-table" id="menuTable">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Image</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Menu items will be dynamically loaded here -->
                    </tbody>
                </table>
                <button class="admin-btn" onclick="addMenuItem()">Add New Item</button>
                <!-- Admin Add/Edit Item Modal -->
                <div class="payment-modal" id="adminItemModal">
                    <div class="payment-content">
                        <div class="payment-header">
                            <h3 class="payment-title" id="adminItemModalTitle">Add Menu Item</h3>
                            <button class="close-payment" id="closeAdminItemModal">&times;</button>
                        </div>
                        <div class="admin-item-form">
                            <div class="form-group">
                                <label for="aiName">Item Name</label>
                                <input type="text" id="aiName" placeholder="Enter item name">
                                <div class="error-message" id="aiNameError">Please provide a name</div>
                            </div>
                            <div class="form-group">
                                <label for="aiDescription">Description</label>
                                <textarea id="aiDescription" placeholder="Enter description"></textarea>
                                <div class="error-message" id="aiDescriptionError">Please provide a description</div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="aiPrice">Price</label>
                                    <input type="text" id="aiPrice" placeholder="Enter price">
                                    <div class="error-message" id="aiPriceError">Enter a valid price</div>
                                </div>
                                <div class="form-group">
                                    <label for="aiCategory">Category</label>
                                    <select id="aiCategory">
                                        <option value="">Select category</option>
                                        <option value="vegetarian">Vegetarian</option>
                                        <option value="non-vegetarian">Non-Vegetarian</option>
                                        <option value="cheese">Cheese</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <div class="error-message" id="aiCategoryError">Please select a category</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="aiImage">Image URL / Upload</label>
                                <input type="text" id="aiImage" placeholder="Enter image URL (or upload below)">
                                <input type="file" id="aiImageFile" accept="image/*" style="margin-top:8px;">
                                <div style="margin-top:10px;">
                                    <img id="aiImagePreview" src="" alt="Preview" style="max-width:140px; display:none; border-radius:8px; border:1px solid #eee;" />
                                </div>
                                <div class="error-message" id="aiImageError">Please provide an image URL</div>
                            </div>
                            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
                                <button class="admin-btn" id="saveAdminItemBtn">Save</button>
                                <button class="admin-btn delete" id="cancelAdminItemBtn">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage User Accounts -->
            <div class="admin-section" id="adminUsersSection">
                <h3>Manage User Accounts</h3>
                <table class="admin-table" id="userTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Password</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- User accounts will be dynamically loaded here -->
                    </tbody>
                </table>
                <div style="margin-top:10px; display:flex; justify-content:flex-start; gap:8px;">
                    <button class="admin-btn" id="addUserBtn">Add New User</button>
                </div>
                <!-- Edit User Modal -->
                <div class="confirm-modal" id="editUserModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center;">
                    <div class="confirm-content" style="background:#fff; border-radius:12px; padding:20px; width:90%; max-width:480px; box-shadow:0 12px 40px rgba(0,0,0,0.2);">
                        <h3 style="margin-top:0;">Edit User Account</h3>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="editUsername" placeholder="Username" />
                                <div class="error-message" id="editUsernameError" style="display:none;">Username is required or already taken.</div>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="editEmail" placeholder="Email" />
                                <div class="error-message" id="editEmailError" style="display:none;">Please enter a valid email or it's already in use.</div>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select id="editRole">
                                    <option value="Customer">Customer</option>
                                    <option value="Staff">Staff</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Password (leave blank to keep current)</label>
                                <input type="password" id="editPassword" placeholder="New password" />
                            </div>
                            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:8px;">
                                <button class="admin-btn" id="editUserSaveBtn">Save</button>
                                <button class="admin-btn delete" id="editUserCancelBtn">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                <!-- Add User Modal -->
                <div class="confirm-modal" id="addUserModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center;">
                    <div class="confirm-content" style="background:#fff; border-radius:12px; padding:20px; width:90%; max-width:480px; box-shadow:0 12px 40px rgba(0,0,0,0.2);">
                        <h3 style="margin-top:0;">Add New User</h3>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="addUsername" placeholder="Username" />
                                <div class="error-message" id="addUsernameError" style="display:none;">Username is required or already taken.</div>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="addEmail" placeholder="Email" />
                                <div class="error-message" id="addEmailError" style="display:none;">Please enter a valid email or it's already in use.</div>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select id="addRole">
                                    <option value="Customer">Customer</option>
                                    <option value="Staff">Staff</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="addPassword" placeholder="Password" />
                                <div class="error-message" id="addPasswordError" style="display:none;">Password must be at least 4 characters.</div>
                            </div>
                            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:8px;">
                                <button class="admin-btn" id="addUserSaveBtn">Save</button>
                                <button class="admin-btn delete" id="addUserCancelBtn">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- Login History -->
            <div class="admin-section" id="adminLoginHistorySection">
                <h3>Login History</h3>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <button class="admin-btn" id="clearLoginHistoryBtn">Clear History</button>
                    <small style="color:#777;">Stored in localStorage</small>
                </div>
                <table class="admin-table" id="loginHistoryTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Password</th>
                            <th>Timestamp</th>
                            <th>Status</th>
                            <th>Info</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Login history will be dynamically loaded here -->
                    </tbody>
                </table>
            </div>
                    </div> <!-- .admin-panel -->
                </div> <!-- .admin-main -->
            </div> <!-- .admin-container -->
        </section>

        <footer>
            <p>&copy; 2025 Pizza Online. All rights reserved. <a href="#">Privacy Policy</a></p>
        </footer>
    </div>

    <script>
        // Sample data (menuItems will load from localStorage when available)
        let menuItems = JSON.parse(localStorage.getItem('menuItems')) || [
            { id: 1, name: "Margherita Pizza", description: "A classic delight with fresh tomatoes, mozzarella, and basil.", price: 299, image: "margharita1.jpg", category: 'vegetarian' },
            { id: 2, name: "Pepperoni Pizza", description: "Loaded with pepperoni and cheese for a savory treat.", price: 349, image: "pepperoni.jpg", category: 'non-vegetarian' },
            { id: 3, name: "Veggie Supreme", description: "A healthy choice with bell peppers, olives, and onions.", price: 329, image: "Veggie-Supreme.png", category: 'vegetarian' },
            { id: 4, name: "BBQ Chicken Pizza", description: "Grilled chicken, BBQ sauce, and red onions for a smoky flavor.", price: 379, image: "bbq-chicken-pizza.jpg", category: 'non-vegetarian' },
            { id: 5, name: "Hawaiian Pizza", description: "Ham and pineapple for a sweet and savory combination.", price: 359, image: "hawaiian.jpg", category: 'non-vegetarian' },
            { id: 6, name: "Four Cheese Pizza", description: "A rich blend of mozzarella, cheddar, parmesan, and gouda.", price: 389, image: "four-cheese.jpg", category: 'cheese' }
        ];

        // Sample pizza data
        const pizzas = [
            { id: 1, name: "Margherita Pizza", category: "vegetarian", price: 299, image: "margharita.jpg" },
            { id: 2, name: "Pepperoni Pizza", category: "non-vegetarian", price: 349, image: "pepperoni.jpg" },
            { id: 3, name: "Veggie Supreme", category: "vegetarian", price: 329, image: "veggie-supreme.jpg" },
            { id: 4, name: "BBQ Chicken Pizza", category: "non-vegetarian", price: 379, image: "bbq-chicken.jpg" },
            { id: 5, name: "Four Cheese Pizza", category: "cheese", price: 389, image: "four-cheese.jpg" },
        ];

    // Initialize cart and orders from localStorage or set defaults
    // Shipping fee can be configured via localStorage key 'shippingFee' (number). Default to 50.
    const SHIPPING_FEE = Number(localStorage.getItem('shippingFee')) || 50;
    // Delivery options: pickup (no fee), standard (SHIPPING_FEE), express (higher fee)
    const DELIVERY_OPTIONS = {
        pickup: 0,
        standard: SHIPPING_FEE,
        express: Number(localStorage.getItem('expressFee')) || (SHIPPING_FEE * 2)
    };
    // Voucher definitions: add or modify codes here
    // Types: 'shipping' (waive shipping), 'percent' (percentage off items subtotal), 'fixed' (fixed amount off), 'free_item' (adds a free item)
    const VOUCHERS = {
        'SHIPFREE': { type: 'shipping' },
        'DISC10': { type: 'percent', value: 10 },
        'P50OFF': { type: 'fixed', value: 50 },
        'FREEGARLIC': { type: 'free_item', item: { id: 'F-GAR', name: 'Garlic Bread (Free)', price: 0 } }
    };
    // currently applied voucher during checkout
    let appliedVoucher = null;
    // current selected delivery type (used during checkout)
    let currentDelivery = 'standard';
    // Cart is now stored per-user to avoid sharing carts between different users
    // Default to an empty array here; we'll load the correct cart for the active user
    let cart = [];
    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    // Interval id used to periodically refresh staff orders (cleared on logout/navigation)
    let staffRefreshInterval = null;
    // track last rendered order ids so we only animate newly added orders
    let lastRenderedOrderIds = new Set();
    // Ensure default admin and staff accounts exist (provide email + known password so email-login works)
    (function ensureDefaultAccounts(){
        try {
            const existing = JSON.parse(localStorage.getItem('users')) || [];
            let changed = false;

            // Admin: ensure one exists and has an email + password suitable for testing
            let adminUser = existing.find(u => u.username === 'admin');
            if (!adminUser) {
                adminUser = { id: Date.now()+1, username: 'admin', email: 'admin@gmail.com', password: 'admin123', role: 'Admin', createdAt: new Date().toISOString() };
                existing.push(adminUser);
                changed = true;
            } else {
                // If admin exists but missing email/password, fill sensible defaults for email-login
                if (!adminUser.email) { adminUser.email = 'admin@gmail.com'; changed = true; }
                if (!adminUser.password) { adminUser.password = 'admin123'; changed = true; }
            }

            // Staff: ensure staff account exists and has an email
            let staffUser = existing.find(u => u.username === 'staff');
            if (!staffUser) {
                staffUser = { id: Date.now()+2, username: 'staff', email: 'staff@example.com', password: 'staff123', role: 'Staff', createdAt: new Date().toISOString() };
                existing.push(staffUser);
                changed = true;
            } else {
                if (!staffUser.email) { staffUser.email = 'staff@example.com'; changed = true; }
                if (!staffUser.password) { staffUser.password = staffUser.password || 'staff123'; changed = true; }
            }

            if (changed) localStorage.setItem('users', JSON.stringify(existing));
        } catch (e) {
            console.error('Failed to ensure default accounts', e);
        }
    })();
        let currentAddress = {};
        let latestOrder = null;
        let activeUser = null;

        // Helper: compute storage key for the current cart (per-user or guest)
        function getCartKey() {
            return (activeUser && activeUser.username) ? ('cart_' + activeUser.username) : 'cart_guest';
        }

        // Load cart for the active user. If mergeGuest is true, merge any guest cart into the user's cart.
        function loadCartForActiveUser(mergeGuest = false) {
            try {
                const key = getCartKey();
                let userCart = JSON.parse(localStorage.getItem(key)) || [];

                if (mergeGuest) {
                    // Try both legacy 'cart' and new 'cart_guest' keys for guest data
                    const legacyGuest = JSON.parse(localStorage.getItem('cart')) || [];
                    const guestCart = JSON.parse(localStorage.getItem('cart_guest')) || legacyGuest || [];
                    if (guestCart && guestCart.length) {
                        guestCart.forEach(gc => {
                            const existing = userCart.find(i => i.id === gc.id);
                            if (existing) existing.quantity = (existing.quantity || 0) + (gc.quantity || 0);
                            else userCart.push(gc);
                        });
                        try { localStorage.removeItem('cart_guest'); } catch(e) {}
                        try { localStorage.removeItem('cart'); } catch(e) {}
                    }
                }

                cart = userCart;
            } catch (e) {
                cart = [];
                console.error('Failed loading cart for user', e);
            }
            updateCartCount();
        }

        // DOM Elements
        const landingPage = document.getElementById('landingPage');
        const loginPage = document.getElementById('loginPage');
        const signupPage = document.getElementById('signupPage');
        const customerDashboard = document.getElementById('customerDashboard');
        const staffDashboard = document.getElementById('staffDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');

        // Customer Dashboard Elements
        const menuGrid = document.getElementById('menuGrid');
        const ordersContainer = document.getElementById('ordersContainer');
        const trackingResult = document.getElementById('trackingResult');
        const cartModal = document.getElementById('cartModal');
        const cartButton = document.getElementById('cartButton');
        const closeCart = document.getElementById('closeCart');
        const cartItems = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const cartCount = document.querySelector('.cart-count');
        const navTabs = document.querySelectorAll('.nav-tab');
        const sections = document.querySelectorAll('.section');
        const orderSearch = document.getElementById('orderSearch');
        const searchOrderBtn = document.getElementById('searchOrderBtn');
        const myOrdersBtn = document.getElementById('myOrdersBtn');
        
        // Address modal elements
        const addressModal = document.getElementById('addressModal');
        const closeAddress = document.getElementById('closeAddress');
        const addressOrderItems = document.getElementById('addressOrderItems');
        const addressOrderTotal = document.getElementById('addressOrderTotal');
        const addressForm = document.getElementById('addressForm');
        const continuePaymentBtn = document.getElementById('continuePaymentBtn');
        
        // Payment modal elements
        const paymentModal = document.getElementById('paymentModal');
        const closePayment = document.getElementById('closePayment');
        const paymentOrderItems = document.getElementById('paymentOrderItems');
        const paymentOrderTotal = document.getElementById('paymentOrderTotal');
        const paymentMethods = document.querySelectorAll('.payment-method');
        const paymentForms = document.querySelectorAll('.payment-form');
        const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
    const voucherInput = document.getElementById('voucherInput');
    const applyVoucherBtn = document.getElementById('applyVoucherBtn');
    const voucherMessage = document.getElementById('voucherMessage');
        
        // Success modal elements
        const successModal = document.getElementById('successModal');
        const successOrderInfo = document.getElementById('successOrderInfo');
        const viewOrdersBtn = document.getElementById('viewOrdersBtn');
        const continueShoppingBtn = document.getElementById('continueShoppingBtn');

        // Browse Pizzas elements
        const pizzaGrid = document.getElementById('pizzaGrid');
        const pizzaFilter = document.getElementById('pizzaFilter');
        const pizzaSearch = document.getElementById('pizzaSearch');
        const searchBtn = document.getElementById('searchBtn');
        const backToMenuBtn = document.getElementById('backToMenuBtn');

        // Staff Dashboard Elements
        const staffOrderList = document.getElementById('staffOrderList');

        // Prevent list entrance animations while the user is interacting with controls inside the list
        if (staffOrderList) {
            // When the user focuses or presses down inside the list (e.g. opens a status <select>),
            // temporarily disable entrance animations for a short window to avoid the 'pop'.
            function suppressListAnimation() {
                try { staffOrderList.dataset.disableAnimate = '1'; } catch(e) {}
                try { clearTimeout(staffOrderList._disableTimeout); } catch(e) {}
                staffOrderList._disableTimeout = setTimeout(function(){ try { delete staffOrderList.dataset.disableAnimate; } catch(e) {} }, 900);
            }

            staffOrderList.addEventListener('pointerdown', function(e){
                const t = e.target || e.srcElement;
                if (!t) return;
                // If interacting with selects, buttons or inputs inside the list, suppress animation
                if (t.tagName === 'SELECT' || t.tagName === 'OPTION' || t.tagName === 'BUTTON' || t.tagName === 'INPUT' || (t.closest && t.closest('select,button,input'))) {
                    suppressListAnimation();
                }
            }, { capture: true });

            staffOrderList.addEventListener('focusin', function(e){
                const t = e.target || e.srcElement;
                if (!t) return;
                if (t.tagName === 'SELECT' || t.tagName === 'INPUT' || t.tagName === 'BUTTON') suppressListAnimation();
            });
        }

        // Wire header search button: open Browse Pizzas and focus the pizza search input
        if (searchBtn) {
            searchBtn.addEventListener('click', function() {
                try {
                    const browseTab = document.querySelector('.nav-tab[data-tab="browse-pizzas"]');
                    if (browseTab) browseTab.click();
                    if (pizzaSearch) { pizzaSearch.focus(); pizzaSearch.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                } catch(e) { console.error('Search button failed', e); }
            });
        }

        // Wire Back to Menu button: go to Menu and scroll to top
        if (backToMenuBtn) {
            backToMenuBtn.addEventListener('click', function() {
                try {
                    const menuTab = document.querySelector('.nav-tab[data-tab="menu"]');
                    if (menuTab) menuTab.click();
                    const menuEl = document.getElementById('menu');
                    if (menuEl) menuEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } catch(e) { console.error('Back to Menu failed', e); }
            });
        }

        // Admin Dashboard Elements
        const adminMenuTable = document.getElementById('menuTable').querySelector('tbody');
        const adminUserTable = document.getElementById('userTable').querySelector('tbody');
    const loginHistoryTable = document.getElementById('loginHistoryTable').querySelector('tbody');
    const clearLoginHistoryBtn = document.getElementById('clearLoginHistoryBtn');
    // Confirmation modal elements
    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmYesBtn = document.getElementById('confirmYesBtn');
    const confirmNoBtn = document.getElementById('confirmNoBtn');
    const closeConfirmModal = document.getElementById('closeConfirmModal');
    // Restore modal elements
    const openRestoreBtnAdmin = document.getElementById('openRestoreBtnAdmin');
    const restoreModal = document.getElementById('restoreModal');
    const restoreList = document.getElementById('restoreList');
    const closeRestoreModal = document.getElementById('closeRestoreModal');
    const restoreCancelBtn = document.getElementById('restoreCancelBtn');

    // confirm callback holder
    let confirmCallback = null;
    // Admin item modal elements
    const adminItemModal = document.getElementById('adminItemModal');
    const adminItemModalTitle = document.getElementById('adminItemModalTitle');
    const closeAdminItemModal = document.getElementById('closeAdminItemModal');
    const saveAdminItemBtn = document.getElementById('saveAdminItemBtn');
    const cancelAdminItemBtn = document.getElementById('cancelAdminItemBtn');
    const aiName = document.getElementById('aiName');
    const aiDescription = document.getElementById('aiDescription');
    const aiPrice = document.getElementById('aiPrice');
    const aiCategory = document.getElementById('aiCategory');
    const aiImage = document.getElementById('aiImage');
    const aiImageFile = document.getElementById('aiImageFile');
    const aiImagePreview = document.getElementById('aiImagePreview');
    const aiNameError = document.getElementById('aiNameError');
    const aiDescriptionError = document.getElementById('aiDescriptionError');
    const aiPriceError = document.getElementById('aiPriceError');
    const aiCategoryError = document.getElementById('aiCategoryError');
    const aiImageError = document.getElementById('aiImageError');

    // State for admin editing
    let adminEditingIndex = null;

    // Attach single listener for aiImageFile to convert uploads to data URLs and show preview
    if (aiImageFile) {
        aiImageFile.addEventListener('change', function() {
            const file = this.files && this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    if (aiImage) aiImage.value = evt.target.result;
                    if (aiImagePreview) { aiImagePreview.src = evt.target.result; aiImagePreview.style.display = 'inline-block'; }
                } catch (e) { console.error('Failed to load image file', e); }
            };
            reader.readAsDataURL(file);
        });
    }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            activeUser = JSON.parse(localStorage.getItem('activeUser'));
            // Debug: print users and admin record to console to help diagnose login issues
            try {
                const dbgUsers = JSON.parse(localStorage.getItem('users')) || [];
                console.log('DEBUG: localStorage users ->', dbgUsers);
                console.log('DEBUG: activeUser ->', activeUser);
                const adminRecord = dbgUsers.find(u => u.username === 'admin' || (u.email || '').toLowerCase() === 'admin@gmail.com');
                console.log('DEBUG: adminRecord ->', adminRecord);
            } catch (e) { console.error('DEBUG: failed reading users from localStorage', e); }
            if (activeUser) {
                showDashboard(activeUser.role);
            } else {
                landingPage.style.display = 'block';
            }

            // Load the correct cart for the current user (do not merge on initial load)
            try { loadCartForActiveUser(false); } catch(e) { console.error('Failed to load cart on init', e); }

            // Ensure Back button visibility is correct on initial load
            try { if (typeof updateBackBtnVisibility === 'function') updateBackBtnVisibility(); } catch(e) {}

            // Set up login form with inline validation messages
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Reset inline errors
                document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

                const emailEl = document.getElementById('loginEmail');
                const passwordEl = document.getElementById('password');

                const email = emailEl.value.trim().toLowerCase();
                const password = passwordEl.value;

                let valid = true;

                if (!email) {
                    document.getElementById('loginEmailError').style.display = 'block';
                    emailEl.focus();
                    valid = false;
                }

                if (!password) {
                    document.getElementById('loginPasswordError').style.display = 'block';
                    if (valid) passwordEl.focus();
                    valid = false;
                }

                if (!valid) return;

                // Check against registered users by email
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const user = users.find(u => (u.email || '').toLowerCase() === email);

                // Username to record in history and for activeUser (preserve original username field)
                const recordedUsername = user ? user.username : email;

                if (user && user.password === password) {
                    // Login successful
                    const role = user.role || 'Customer';
                    activeUser = { username: user.username, email: user.email, role };
                    localStorage.setItem('activeUser', JSON.stringify(activeUser));

                    // Record login success in history (includes attempted password)
                    addLoginHistoryEntry({
                        username: recordedUsername,
                        role,
                        password: password, // stored for admin audit (sensitive)
                        status: 'success',
                        timestamp: new Date().toISOString(),
                        info: navigator.userAgent || ''
                    });

                    showDashboard(role);
                    // After a successful login, load the user's cart and merge any guest cart that existed
                    try { loadCartForActiveUser(true); } catch(e) { console.error('Failed to load cart after login', e); }
                } else {
                    // Determine role for history if possible
                    const attemptedRole = user ? (user.role || 'Customer') : 'Unknown';

                    // Record failed attempt in history (includes attempted password)
                    addLoginHistoryEntry({
                        username: recordedUsername,
                        role: attemptedRole,
                        password: password, // stored for admin audit (sensitive)
                        status: 'failed',
                        timestamp: new Date().toISOString(),
                        info: 'Invalid credentials'
                    });

                    const loginErr = document.getElementById('loginError');
                    loginErr.textContent = 'Invalid credentials. Please try again or sign up for a new account.';
                    loginErr.style.display = 'block';
                }
            });

            // Header color mode: white text on Home, dark elsewhere
            try {
                const headerEl = document.querySelector('header');
                const homeSec = document.getElementById('home');
                function setHeaderWhite(isWhite) {
                    if (!headerEl) return;
                    if (isWhite) headerEl.classList.add('header--white'); else headerEl.classList.remove('header--white');
                }

                if (homeSec && headerEl) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            // when a good portion of home is visible, use white text
                            if (entry.isIntersecting && entry.intersectionRatio > 0.35) {
                                setHeaderWhite(true);
                            } else {
                                setHeaderWhite(false);
                            }
                        });
                    }, { threshold: [0, 0.15, 0.35, 0.6] });

                    observer.observe(homeSec);
                }

                // Also update on nav clicks which might jump to sections
                document.querySelectorAll('header nav a').forEach(a => {
                    a.addEventListener('click', function() {
                        const href = (this.getAttribute('href') || '');
                        const id = href.startsWith('#') ? href.slice(1) : null;
                        setTimeout(() => setHeaderWhite(id === 'home'), 120);
                    });
                });

                // initial check
                setTimeout(() => {
                    if (homeSec) {
                        const rect = homeSec.getBoundingClientRect();
                        const visible = rect.top < window.innerHeight * 0.6 && rect.bottom > window.innerHeight * 0.2;
                        setHeaderWhite(visible);
                    }
                }, 200);
            } catch (e) { console.error('Header color init failed', e); }

            // Password strength indicator
            const passwordInput = document.getElementById('passwordSignup');
            const passwordStrength = document.getElementById('passwordStrength');
            
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                let strength = '';
                let strengthClass = '';
                
                if (password.length === 0) {
                    strength = '';
                } else if (password.length < 6) {
                    strength = 'Weak';
                    strengthClass = 'strength-weak';
                } else if (password.length < 8) {
                    strength = 'Medium';
                    strengthClass = 'strength-medium';
                } else {
                    strength = 'Strong';
                    strengthClass = 'strength-strong';
                }
                
                passwordStrength.textContent = strength;
                passwordStrength.className = 'password-strength ' + strengthClass;
            });
            
            // Form validation
            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Reset error messages
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                });
                
                // Get form values
                const username = document.getElementById('usernameSignup').value.trim();
                const email = (document.getElementById('emailSignup') && document.getElementById('emailSignup').value || '').trim();
                const password = document.getElementById('passwordSignup').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const userRole = 'Customer';
                
                let isValid = true;
                
                // Validate username
                if (username.length < 3) {
                    document.getElementById('usernameError').style.display = 'block';
                    isValid = false;
                }

                // Validate email (simple regex)
                const emailEl = document.getElementById('emailSignup');
                if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
                    document.getElementById('emailError').style.display = 'block';
                    if (isValid) emailEl && emailEl.focus();
                    isValid = false;
                }
                
                // Validate password
                if (password.length < 6) {
                    document.getElementById('passwordError').style.display = 'block';
                    isValid = false;
                }
                
                // Validate password confirmation
                if (password !== confirmPassword) {
                    document.getElementById('confirmPasswordError').style.display = 'block';
                    isValid = false;
                }
                
                // If form is valid, process signup (all signups are Customers)
                if (isValid) {
                    processSignup({
                        username,
                        email,
                        password,
                        role: userRole
                    });
                }
            });

            // Initialize landing page functionality
            initializeLandingPage();
        });

        // Initialize Landing Page
        function initializeLandingPage() {
            // Toggle mobile menu
            function toggleMenu() {
                const nav = document.getElementById('main-nav');
                nav.classList.toggle('active');
            }

            // Close mobile menu when clicking on a link
            document.querySelectorAll('#main-nav a').forEach(link => {
                link.addEventListener('click', () => {
                    document.getElementById('main-nav').classList.remove('active');
                });
            });

            // Smooth scrolling for navigation links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    if (targetId === '#') return;
                    
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        const headerHeight = document.querySelector('header').offsetHeight;
                        const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight;
                        
                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                });
            });

            // Animate sections on scroll
            function animateOnScroll() {
                const sections = document.querySelectorAll('.menu-section, .reviews-section, .contact-section, .find-us-section');
                
                sections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    if (rect.top < window.innerHeight * 0.8 && !section.classList.contains('fade-in')) {
                        section.classList.add('fade-in');
                        section.style.opacity = 1;
                    }
                });
            }

            // Initialize animations
            window.addEventListener('DOMContentLoaded', () => {
                animateOnScroll();
                // Set initial opacity for sections that should be visible
                const menuSection = document.querySelector('.menu-section');
                if (menuSection) menuSection.style.opacity = 1;

                // Landing page hero entrance animations (staggered)
                const hero = document.querySelector('.hero');
                if (hero) {
                    const headline = hero.querySelector('h1');
                    const subtitle = hero.querySelector('p');
                    const cta = document.querySelector('.auth-buttons');

                    // headline first
                    if (headline) {
                        setTimeout(() => headline.classList.add('hero-headline-animate'), 80);
                    }

                    // subtitle shortly after
                    if (subtitle) {
                        setTimeout(() => subtitle.classList.add('hero-subtitle-animate'), 220);
                    }

                    // CTAs last
                    if (cta) {
                        setTimeout(() => cta.classList.add('hero-cta-animate'), 380);
                    }
                }
            });

            window.addEventListener('scroll', animateOnScroll);

            // Set up hamburger menu
            document.querySelector('.hamburger').addEventListener('click', toggleMenu);
        }

        // Show appropriate dashboard based on role
        function showDashboard(role) {
            landingPage.style.display = 'none';
            loginPage.style.display = 'none';
            signupPage.style.display = 'none';
            
            // Ensure fullscreen class is only active for Staff view
            try { if (staffDashboard) staffDashboard.classList.remove('fullscreen'); } catch(e) {}

            if (role === 'Customer') {
                customerDashboard.style.display = 'block';
                staffDashboard.style.display = 'none';
                adminDashboard.style.display = 'none';
                initializeCustomerDashboard();
            } else if (role === 'Staff') {
                customerDashboard.style.display = 'none';
                staffDashboard.style.display = 'block';
                adminDashboard.style.display = 'none';
                try { if (staffDashboard) staffDashboard.classList.add('fullscreen'); } catch(e) {}
                initializeStaffDashboard();
            } else if (role === 'Admin') {
                customerDashboard.style.display = 'none';
                staffDashboard.style.display = 'none';
                adminDashboard.style.display = 'block';
                initializeAdminDashboard();
            }
        }

        // Initialize Customer Dashboard
        function initializeCustomerDashboard() {
            renderMenu();
            renderOrders();
            updateCartCount();
            renderPizzas('all', '');
        }

        // Initialize Staff Dashboard
        function initializeStaffDashboard() {
            renderStaffOrders();
            
            // Set up interval to check for new orders (only when staff dashboard is visible)
            try { if (staffRefreshInterval) clearInterval(staffRefreshInterval); } catch(e) {}
            // Keep a lightweight snapshot string to detect real changes and avoid rebuilding DOM unnecessarily
            try { window._staffOrdersSnapshot = JSON.stringify(JSON.parse(localStorage.getItem('orders') || '[]').map(o=>({id:o.id, status:o.status, date:o.date}))); } catch(e) { window._staffOrdersSnapshot = null; }
            staffRefreshInterval = setInterval(function() {
                try {
                    if (!staffDashboard || staffDashboard.style.display === 'none') return;
                    const current = JSON.stringify(JSON.parse(localStorage.getItem('orders') || '[]').map(o=>({id:o.id, status:o.status, date:o.date})));
                    if (current !== window._staffOrdersSnapshot) {
                        window._staffOrdersSnapshot = current;
                        renderStaffOrders();
                    }
                } catch (e) { /* ignore individual interval errors */ }
            }, 3000); // Check every 3 seconds

            // Wire up staff-side clear history button (calls existing clearLoginHistory)
            try {
                const clearStaffHistoryBtn = document.getElementById('clearLoginHistoryBtnStaff');
                if (clearStaffHistoryBtn) {
                    // Prevent attaching multiple handlers if initializeStaffDashboard runs repeatedly
                    if (!clearStaffHistoryBtn.dataset.clearAttached) {
                        clearStaffHistoryBtn.addEventListener('click', function() {
                            if (!confirm('Clear all order history? This action will permanently delete all orders. Continue?')) return;
                            // Only allow staff or admin to perform this
                            if (!activeUser || (activeUser.role !== 'Staff' && activeUser.role !== 'Admin')) {
                                showToast('You do not have permission to clear all orders');
                                return;
                            }

                            // Clear all orders (with backup). clearAllOrders now returns an object with details
                            try {
                                const result = clearAllOrders();
                                if (result && result.ok) {
                                    if (result.clearedCount && result.clearedCount > 0) {
                                        showToast(`Cleared ${result.clearedCount} orders (backup: ${result.backupKey || 'none'})`);
                                    } else {
                                        showToast('No orders to clear');
                                    }
                                } else {
                                    console.error('clearAllOrders reported failure', result);
                                    showToast('Failed to clear orders');
                                }
                            } catch (err) {
                                console.error('Failed clearing orders', err);
                                showToast('Failed to clear orders');
                            }
                        });
                        clearStaffHistoryBtn.dataset.clearAttached = '1';
                    }
                }
            } catch(e) { console.error('Failed wiring staff clear history button', e); }

            // Wire staff sidebar view buttons (Orders / Stats)
            try {
                const ordersBtn = document.getElementById('staffOrdersBtn');
                const statsBtn = document.getElementById('staffStatsBtn');
                const ordersSection = document.querySelector('.staff-orders');
                const statsSection = document.getElementById('staffStatsSection');

                    function syncOverviewStats() {
                    const list = JSON.parse(localStorage.getItem('orders')) || [];
                    const total = list.length;
                    const revenue = (function(){ try { return Number(localStorage.getItem('revenue')) || 0; } catch(e){ return 0; } })();
                    const pending = list.filter(o => (o.status || '').toLowerCase().includes('pend')).length;
                    const preparing = list.filter(o => (o.status || '').toLowerCase().includes('prepar')).length;
                    const outFor = list.filter(o => (o.status || '').toLowerCase().includes('out')).length;
                    const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                    setEl('statTotalOverview', total);
                    setEl('statRevenueOverview', `${Number(revenue).toFixed(2)}`);
                    setEl('statPendingOverview', pending);
                    setEl('statPreparingOverview', preparing);
                    setEl('statOutOverview', outFor);
                }

                function showStaffView(view) {
                    if (view === 'stats') {
                        if (ordersSection) ordersSection.style.display = 'none';
                        if (statsSection) statsSection.style.display = '';
                        if (ordersBtn) ordersBtn.classList.remove('active');
                        if (statsBtn) statsBtn.classList.add('active');
                        // update overview metrics and analytics chart
                        try { syncOverviewStats(); } catch(e) { console.error('syncOverviewStats failed', e); }
                        // When the user explicitly clicked the Stats button, force animations
                        try { window._forceAnalyticsAnimate = true; } catch(e) {}
                        try { renderStaffAnalytics(); } catch(e) { /* ignore if chart not ready */ }
                        // Clear the force flag after animations should be finished (1.2s)
                        try { setTimeout(function(){ window._forceAnalyticsAnimate = false; }, 1200); } catch(e) {}
                    } else {
                        // default to orders
                        if (ordersSection) ordersSection.style.display = '';
                        if (statsSection) statsSection.style.display = 'none';
                        if (ordersBtn) ordersBtn.classList.add('active');
                        if (statsBtn) statsBtn.classList.remove('active');
                        // refresh list
                        try { renderStaffOrders(); } catch(e) { console.error('renderStaffOrders failed', e); }
                    }
                    try { localStorage.setItem('staffView', view); } catch(e) {}
                }

                if (ordersBtn && !ordersBtn.dataset.viewAttached) {
                    ordersBtn.addEventListener('click', function() { showStaffView('orders'); });
                    ordersBtn.dataset.viewAttached = '1';
                }
                if (statsBtn && !statsBtn.dataset.viewAttached) {
                    statsBtn.addEventListener('click', function() {
                        try { window._forceAnalyticsAnimate = true; } catch(e) {}
                        try { showStaffView('stats'); } catch(e) {}
                        try { setTimeout(function(){ window._forceAnalyticsAnimate = false; }, 1200); } catch(e) {}
                    });
                    statsBtn.dataset.viewAttached = '1';
                }
                // Restore last view (if any)
                try {
                    const last = localStorage.getItem('staffView') || 'orders';
                    showStaffView(last);
                } catch(e) { showStaffView('orders'); }
            
                // --- Analytics rendering helpers ---
                // Chart instances will be created lazily
                let staffAnalyticsChart = null;
                let staffStatusChart = null;
                let staffTopSalesChart = null;

                function prepareAnalyticsData(range, dateStr) {
                    const list = JSON.parse(localStorage.getItem('orders')) || [];
                    const now = dateStr ? new Date(dateStr) : new Date();
                    let labels = [];
                    let counts = [];

                    if (range === 'day') {
                        // 24-hour buckets but show labels in 12-hour AM/PM format
                        labels = Array.from({length:24}, (_,i) => {
                            const suffix = i < 12 ? 'AM' : 'PM';
                            const hour12 = i % 12 === 0 ? 12 : (i % 12);
                            return `${hour12}:00 ${suffix}`;
                        });
                        counts = new Array(24).fill(0);
                        list.forEach(o => {
                            try {
                                const ts = new Date(o.timestamp || o.createdAt || o.date || o.time || o.created || Date.now());
                                if (ts.getFullYear() === now.getFullYear() && ts.getMonth() === now.getMonth() && ts.getDate() === now.getDate()) {
                                    counts[ts.getHours()]++;
                                }
                            } catch(e) {}
                        });
                    } else if (range === 'month') {
                        const year = now.getFullYear();
                        const month = now.getMonth();
                        const days = new Date(year, month+1, 0).getDate();
                        labels = Array.from({length:days}, (_,i) => String(i+1));
                        counts = labels.map(() => 0);
                        list.forEach(o => {
                            try {
                                const ts = new Date(o.timestamp || o.createdAt || o.date || o.time || o.created || Date.now());
                                if (ts.getFullYear() === year && ts.getMonth() === month) {
                                    counts[ts.getDate()-1]++;
                                }
                            } catch(e) {}
                        });
                    } else {
                        // year
                        labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                        counts = labels.map(() => 0);
                        const year = now.getFullYear();
                        list.forEach(o => {
                            try {
                                const ts = new Date(o.timestamp || o.createdAt || o.date || o.time || o.created || Date.now());
                                if (ts.getFullYear() === year) {
                                    counts[ts.getMonth()]++;
                                }
                            } catch(e) {}
                        });
                    }

                    // If no real data, leave counts as zeros so the chart accurately reflects no activity
                    // (previously we injected random synthetic data here which caused 'random orders' to appear)
                    // keep counts as-is (all zero) when total is 0
                    const total = counts.reduce((s,n) => s+n, 0);

                    return { labels, counts };
                }

                function renderStaffAnalytics() {
                    try {
                        const rangeEl = document.getElementById('analyticsRange');
                        const dateEl = document.getElementById('analyticsDate');
                        const range = rangeEl ? rangeEl.value : 'month';
                        const dateStr = dateEl && dateEl.value ? dateEl.value : (new Date()).toISOString().slice(0,10);
                        const data = prepareAnalyticsData(range, dateStr);

                        const ctx = document.getElementById('staffAnalyticsChart');
                        if (!ctx) return;

                        if (!staffAnalyticsChart) {
                            staffAnalyticsChart = new Chart(ctx.getContext('2d'), {
                                type: 'bar',
                                data: {
                                    labels: data.labels,
                                    datasets: [{
                                        label: 'Orders',
                                        data: data.counts,
                                        backgroundColor: 'rgba(255,126,95,0.9)'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: { y: { beginAtZero: true, ticks: { precision:0 } } },
                                    plugins: { datalabels: { display: false } },
                                    animation: { duration: (window._forceAnalyticsAnimate ? 800 : 400), easing: 'easeOutQuart' }
                                }
                            });
                        } else {
                            staffAnalyticsChart.data.labels = data.labels;
                            staffAnalyticsChart.data.datasets[0].data = data.counts;
                            try {
                                if (!staffAnalyticsChart.options) staffAnalyticsChart.options = {};
                                staffAnalyticsChart.options.animation = staffAnalyticsChart.options.animation || {};
                                staffAnalyticsChart.options.animation.duration = window._forceAnalyticsAnimate ? 800 : (staffAnalyticsChart.options.animation.duration || 400);
                                staffAnalyticsChart.options.animation.easing = 'easeOutQuart';
                            } catch (e) {}
                            staffAnalyticsChart.update();
                        }
                        // Also render the order-status pie/doughnut chart
                        try { renderStatusPieChart(); } catch(e) { console.error('renderStatusPieChart failed', e); }
                        // render top sales chart as well (respect selected range/date)
                        try { renderTopSalesChart(range, dateStr); } catch(e) { console.error('renderTopSalesChart failed', e); }
                    } catch(e) {
                        console.error('Failed to render analytics chart', e);
                    }
                }

                function renderStatusPieChart() {
                    try {
                        const list = JSON.parse(localStorage.getItem('orders')) || [];
                        const buckets = { 'Pending': 0, 'Preparing': 0, 'Out For Delivery': 0, 'Delivered': 0, 'Other': 0 };
                        list.forEach(o => {
                            const s = (o.status || '').toString().toLowerCase();
                            if (s.includes('pend')) buckets['Pending']++;
                            else if (s.includes('prepar')) buckets['Preparing']++;
                            else if (s.includes('out')) buckets['Out For Delivery']++;
                            else if (s.includes('deliver')) buckets['Delivered']++;
                            else buckets['Other']++;
                        });

                        const labels = Object.keys(buckets);
                        const counts = labels.map(l => buckets[l]);

                        const ctxPie = document.getElementById('staffStatusPieChart');
                        if (!ctxPie) return;

                        const colors = [
                            'rgba(255,193,7,0.95)', // Pending - amber
                            'rgba(54,162,235,0.95)', // Preparing - blue
                            'rgba(75,192,192,0.95)', // Out - green
                            'rgba(153,102,255,0.95)', // Delivered - purple
                            'rgba(201,203,207,0.95)'  // Other - grey
                        ];

                        // Register DataLabels plugin if available
                        try { if (window.Chart && window.ChartDataLabels) Chart.register(ChartDataLabels); } catch (e) { /* ignore */ }

                        // datalabels config: show percentage centered in each slice
                        const datalabelsOptions = {
                            color: '#000',
                            font: { weight: '700', size: 12 },
                            formatter: function(value, ctx) {
                                const dataArr = (ctx.chart && ctx.chart.data && ctx.chart.data.datasets && ctx.chart.data.datasets[0] && ctx.chart.data.datasets[0].data) || [];
                                const total = dataArr.reduce((s, n) => s + (Number(n) || 0), 0);
                                if (!total || Number(value) === 0) return '';
                                return ((Number(value) / total) * 100).toFixed(1) + '%';
                            },
                            anchor: 'center',
                            align: 'center'
                        };

                        if (staffStatusChart) {
                            staffStatusChart.data.labels = labels;
                            staffStatusChart.data.datasets[0].data = counts;
                            if (!staffStatusChart.options.plugins) staffStatusChart.options.plugins = {};
                            staffStatusChart.options.plugins.datalabels = datalabelsOptions;
                            try {
                                staffStatusChart.options.animation = staffStatusChart.options.animation || {};
                                staffStatusChart.options.animation.duration = window._forceAnalyticsAnimate ? 800 : (staffStatusChart.options.animation.duration || 400);
                                staffStatusChart.options.animation.easing = 'easeOutQuart';
                            } catch (e) {}
                            staffStatusChart.update();
                        } else {
                            staffStatusChart = new Chart(ctxPie.getContext('2d'), {
                                type: 'doughnut',
                                data: {
                                    labels: labels,
                                    datasets: [{ data: counts, backgroundColor: colors, borderWidth: 0 }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8 } },
                                        tooltip: {
                                            enabled: true,
                                            callbacks: {
                                                label: function(ctx) {
                                                    const v = ctx.raw || 0;
                                                    const dataset = ctx.dataset && ctx.dataset.data ? ctx.dataset.data : [];
                                                    const total = dataset.reduce((s,n) => s + (Number(n)||0), 0);
                                                    const pct = total ? ((Number(v)/total)*100).toFixed(1) : '0.0';
                                                    return `${ctx.label}: ${v} (${pct}%)`;
                                                }
                                            }
                                        },
                                        datalabels: datalabelsOptions
                                    },
                                    animation: { duration: (window._forceAnalyticsAnimate ? 800 : 400), easing: 'easeOutQuart' }
                                }
                            });
                        }
                    } catch (e) { console.error('Failed to render status pie chart', e); }
                }

                // Render Top Sales (top-selling menu items by quantity)
                function renderTopSalesChart(range, dateStr) {
                    try {
                        const rawList = JSON.parse(localStorage.getItem('orders')) || [];
                        const now = dateStr ? new Date(dateStr) : new Date();

                        function inSelectedRange(orderDate) {
                            try {
                                const d = new Date(orderDate);
                                if (range === 'day') {
                                    return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth() && d.getDate() === now.getDate();
                                } else if (range === 'month') {
                                    return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
                                } else { // year
                                    return d.getFullYear() === now.getFullYear();
                                }
                            } catch (e) { return false; }
                        }

                        // Filter orders to the selected period
                        const list = rawList.filter(o => {
                            const od = o.timestamp || o.createdAt || o.date || o.time || o.created || null;
                            if (!od) return false;
                            return inSelectedRange(od);
                        });

                        const countsByItem = Object.create(null);

                        list.forEach(o => {
                            (o.items || []).forEach(it => {
                                try {
                                    const name = (it && (it.name || it.id)) ? String(it.name || it.id) : 'Unknown';
                                    const qty = Number(it.quantity) || 0;
                                    if (!countsByItem[name]) countsByItem[name] = 0;
                                    countsByItem[name] += qty;
                                } catch(e) {}
                            });
                        });

                        // Convert to array and sort by quantity desc
                        const entries = Object.keys(countsByItem).map(k => ({ name: k, qty: countsByItem[k] }));
                        entries.sort((a,b) => b.qty - a.qty);

                        // Pick top N (6) for display
                        const topN = 6;
                        const top = entries.slice(0, topN);

                        const labels = top.map(e => e.name);
                        const data = top.map(e => e.qty);

                        const ctxTop = document.getElementById('staffTopSalesChart');
                        if (!ctxTop) return;

                        const barColors = [
                            'rgba(255,99,132,0.95)', 'rgba(54,162,235,0.95)', 'rgba(255,206,86,0.95)',
                            'rgba(75,192,192,0.95)', 'rgba(153,102,255,0.95)', 'rgba(255,159,64,0.95)'
                        ];

                        if (staffTopSalesChart) {
                            staffTopSalesChart.data.labels = labels;
                            staffTopSalesChart.data.datasets[0].data = data;
                            try {
                                staffTopSalesChart.options.animation = staffTopSalesChart.options.animation || {};
                                staffTopSalesChart.options.animation.duration = window._forceAnalyticsAnimate ? 800 : (staffTopSalesChart.options.animation.duration || 400);
                                staffTopSalesChart.options.animation.easing = 'easeOutQuart';
                            } catch (e) {}
                            staffTopSalesChart.update();
                        } else {
                            staffTopSalesChart = new Chart(ctxTop.getContext('2d'), {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Quantity Sold',
                                        data: data,
                                        backgroundColor: barColors.slice(0, labels.length),
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: { beginAtZero: true, ticks: { precision: 0 } },
                                        y: { ticks: { autoSkip: false } }
                                    },
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: function(ctx) {
                                                    const v = ctx.raw || 0;
                                                    return `${v} pcs`;
                                                }
                                            }
                                        }
                                    },
                                    animation: { duration: (window._forceAnalyticsAnimate ? 800 : 400), easing: 'easeOutQuart' }
                                }
                            });
                        }
                    } catch (e) { console.error('Failed to render top sales chart', e); }
                }

                // Wire analytics controls
                try {
                    const applyBtn = document.getElementById('analyticsApplyBtn');
                    if (applyBtn && !applyBtn.dataset.wired) {
                        applyBtn.addEventListener('click', function() { renderStaffAnalytics(); });
                        applyBtn.dataset.wired = '1';
                    }

                    const rangeSel = document.getElementById('analyticsRange');
                    if (rangeSel && !rangeSel.dataset.wired) {
                        rangeSel.addEventListener('change', function() {
                            // adjust date input placeholder or behavior if needed
                            renderStaffAnalytics();
                        });
                        rangeSel.dataset.wired = '1';
                    }
                } catch(e) { console.error('Failed wiring analytics controls', e); }
            } catch (e) { console.error('Failed wiring staff sidebar buttons', e); }
        }

        // Initialize Admin Dashboard
        function initializeAdminDashboard() {
            // hide all admin subsections until user clicks a button
            document.querySelectorAll('.admin-dashboard .admin-section').forEach(s => s.classList.remove('active'));

            // helper to show a named section and render its content on demand
            function showAdminSection(name) {
                const menuSection = document.getElementById('adminMenuSection');
                const usersSection = document.getElementById('adminUsersSection');
                const historySection = document.getElementById('adminLoginHistorySection');

                [menuSection, usersSection, historySection].forEach(s => { if (s) s.classList.remove('active'); });
                // update sidebar active state
                try {
                    document.querySelectorAll('.admin-sidebar .sidebar-btn').forEach(b => b.classList.remove('active'));
                } catch (e) {}

                if (name === 'menu' && menuSection) {
                    menuSection.classList.add('active');
                    renderAdminMenuItems();
                    try { document.getElementById('manageMenuBtn').classList.add('active'); } catch(e){}
                }
                if (name === 'users' && usersSection) {
                    usersSection.classList.add('active');
                    renderAdminUsers();
                    try { document.getElementById('manageUsersBtn').classList.add('active'); } catch(e){}
                }
                if (name === 'history' && historySection) {
                    historySection.classList.add('active');
                    renderLoginHistory();
                    try { document.getElementById('viewHistoryBtn').classList.add('active'); } catch(e){}
                }
            }

            // wire up control buttons
            const menuBtn = document.getElementById('manageMenuBtn');
            const usersBtn = document.getElementById('manageUsersBtn');
            const historyBtn = document.getElementById('viewHistoryBtn');

            if (menuBtn) menuBtn.addEventListener('click', () => showAdminSection('menu'));
            if (usersBtn) usersBtn.addEventListener('click', () => showAdminSection('users'));
            if (historyBtn) historyBtn.addEventListener('click', () => showAdminSection('history'));

            // wire up clear history button (exists in the login history section) only once
            if (clearLoginHistoryBtn) {
                clearLoginHistoryBtn.addEventListener('click', function() {
                    if (!confirm('Clear all login history? This action cannot be undone.')) return;
                    clearLoginHistory();
                    showToast('Login history cleared');
                    // re-render history if visible
                    try { if (document.getElementById('adminLoginHistorySection').classList.contains('active')) renderLoginHistory(); } catch(e) {}
                });
            }

            // no section shown by default; show on click per user request
            // Render revenue display on admin init
            try { renderRevenueDisplay(); } catch(e) { console.error('Failed to render revenue during admin init', e); }
            // Admin recompute button removed; staff-only button is wired elsewhere
        }

        // Login history helpers
        function getLoginHistory() {
            return JSON.parse(localStorage.getItem('loginHistory')) || [];
        }

        // Revenue helpers: store total revenue in localStorage under 'revenue' (number)
        function getRevenue() {
            try { return Number(localStorage.getItem('revenue')) || 0; } catch(e) { return 0; }
        }

        function saveRevenue(amount) {
            try { localStorage.setItem('revenue', String(Number(amount) || 0)); } catch(e) { console.error('Failed to save revenue', e); }
        }

        function addRevenue(amount) {
            try {
                const current = getRevenue();
                const next = Number(current || 0) + Number(amount || 0);
                saveRevenue(next);
            } catch (e) { console.error('Failed to add revenue', e); }
        }

        // Render revenue into admin dashboard if element exists
        function renderRevenueDisplay() {
            try {
                const el = document.getElementById('revenueDisplay');
                if (!el) return;
                const rev = getRevenue();
                el.textContent = `${Number(rev).toFixed(2)}`;
            } catch (e) { console.error('Failed to render revenue', e); }
        }

        // Recompute revenue from orders with status 'Delivered'. This will replace the stored
        // `revenue` value with the sum of totals for delivered orders and mark those orders
        // with `revenueRecorded = true` to avoid double-counting later.
        function recomputeRevenueFromOrders() {
            try {
                if (!activeUser || (activeUser.role !== 'Admin' && activeUser.role !== 'Staff')) {
                    showToast('Insufficient permissions to recompute revenue');
                    return;
                }

                const list = JSON.parse(localStorage.getItem('orders')) || [];
                let sum = 0;
                let modified = false;
                list.forEach(o => {
                    const s = (o.status || '').toLowerCase();
                    if (s.includes('deliver')) {
                        const amt = Number(o.total) || 0;
                        sum += amt;
                        if (!o.revenueRecorded) { o.revenueRecorded = true; modified = true; }
                    }
                });

                // Persist new revenue and optionally updated orders
                saveRevenue(sum);
                if (modified) try { localStorage.setItem('orders', JSON.stringify(list)); } catch(e) { console.error('Failed persisting orders after recompute', e); }

                renderRevenueDisplay();
                try { syncOverviewStats(); } catch(e) {}
                showToast('Revenue recomputed from delivered orders');
            } catch (e) {
                console.error('Failed recomputing revenue', e);
                showToast('Failed recomputing revenue');
            }
        }

        function saveLoginHistory(arr) {
            localStorage.setItem('loginHistory', JSON.stringify(arr));
        }

        function addLoginHistoryEntry(entry) {
            try {
                const history = getLoginHistory();
                // keep newest first
                history.unshift(entry);
                // cap to a reasonable size (e.g., 500 entries)
                if (history.length > 500) history.length = 500;
                saveLoginHistory(history);
                renderLoginHistory();
            } catch (e) {
                console.error('Failed to add login history entry', e);
            }
        }

        function clearLoginHistory() {
            try {
                // Backup existing login history before deleting to avoid accidental data loss
                const existing = JSON.parse(localStorage.getItem('loginHistory')) || [];
                if (existing && existing.length > 0) {
                    const backupKey = 'loginHistory_backup_' + Date.now();
                    localStorage.setItem(backupKey, JSON.stringify(existing));
                    console.log('Login history backed up to', backupKey);
                }
                // Remove only the login history key
                localStorage.removeItem('loginHistory');
                renderLoginHistory();
            } catch (e) {
                console.error('Failed to clear login history', e);
            }
        }

        // Clear all orders (staff/admin action). Creates a backup key before deletion.
        function clearAllOrders() {
            // Return an object: { ok: boolean, clearedCount: number, backupKey?: string, error?: string }
            try {
                // Only allow staff or admin
                if (!activeUser || (activeUser.role !== 'Staff' && activeUser.role !== 'Admin')) {
                    console.error('clearAllOrders: insufficient permissions', activeUser);
                    return { ok: false, clearedCount: 0, error: 'Insufficient permissions' };
                }

                const existing = JSON.parse(localStorage.getItem('orders')) || [];
                const count = Array.isArray(existing) ? existing.length : 0;
                let backupKey = null;
                if (count > 0) {
                    backupKey = 'orders_backup_' + Date.now();
                    try {
                        localStorage.setItem(backupKey, JSON.stringify(existing));
                        console.log('Orders backed up to', backupKey);
                    } catch (e) {
                        console.error('Failed to write orders backup', e);
                        // continue  we will still attempt to clear
                    }
                }

                // Clear orders storage and in-memory array
                try { localStorage.removeItem('orders'); } catch (e) { console.error('Failed removing orders from localStorage', e); }
                orders = [];

                // Re-render views that depend on orders
                try { renderStaffOrders(); } catch (e) { /* ignore if not visible */ }
                try { renderOrders(); } catch (e) { /* ignore if not visible */ }

                return { ok: true, clearedCount: count, backupKey };
            } catch (e) {
                console.error('Failed to clear all orders', e);
                return { ok: false, clearedCount: 0, error: e && e.message ? e.message : String(e) };
            }
        }

        function renderLoginHistory() {
            if (!loginHistoryTable) return;
            const history = getLoginHistory();
            if (history.length === 0) {
                loginHistoryTable.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;">No login history available</td></tr>';
                return;
            }

            // Render rows and include masked password + reveal button
            loginHistoryTable.innerHTML = history.map((entry, idx) => {
                const ts = new Date(entry.timestamp).toLocaleString();
                const infoSafe = (entry.info || '').toString().replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const statusColor = entry.status === 'success' ? '#28a745' : '#dc3545';
                const pwd = entry.password || '';
                const masked = pwd ? (''.repeat(Math.min(10, pwd.length))) : '';
                return `
                    <tr data-index="${idx}">
                        <td>${entry.username || ''}</td>
                        <td>${entry.role || ''}</td>
                        <td style="max-width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            <span class="masked-password">${masked}</span>
                            ${pwd ? `<button class="admin-btn" style="margin-left:8px;padding:6px 8px;" data-idx="${idx}" data-pwd="${encodeURIComponent(pwd)}">Show</button>` : ''}
                        </td>
                        <td>${ts}</td>
                        <td style="color:${statusColor}; font-weight:600">${entry.status || ''}</td>
                        <td style="max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${infoSafe}</td>
                    </tr>
                `;
            }).join('');

            // Attach handlers to Show buttons
            document.querySelectorAll('#loginHistoryTable button[data-idx]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const pwdEncoded = this.getAttribute('data-pwd') || '';
                    const pwd = decodeURIComponent(pwdEncoded);
                    const confirmed = confirm('Reveal the password for this login attempt? This will display sensitive information stored locally. Proceed?');
                    if (!confirmed) return;

                    // Replace masked text with actual password temporarily
                    const tr = this.closest('tr');
                    if (!tr) return;
                    const span = tr.querySelector('.masked-password');
                    if (span) span.textContent = pwd;

                    // Change button to 'Hide'
                    this.textContent = 'Hide';
                    this.removeAttribute('data-pwd');

                    // When clicked again, re-mask
                    this.addEventListener('click', function hideHandler() {
                        if (span) span.textContent = ''.repeat(Math.min(10, pwd.length));
                        this.textContent = 'Show';
                        // restore data-pwd so it can be revealed again
                        this.setAttribute('data-pwd', encodeURIComponent(pwd));
                        // remove this hideHandler to avoid stacking listeners
                        this.removeEventListener('click', hideHandler);
                    });
                });
            });
        }

        // Show signup page
        function showSignUpPage() {
            landingPage.style.display = 'none';
            loginPage.style.display = 'none';
            signupPage.style.display = 'flex';
        }

        // Show login page
        function showLoginPage() {
            landingPage.style.display = 'none';
            loginPage.style.display = 'flex';
            signupPage.style.display = 'none';
        }

        // Process signup
        function processSignup(userData) {
            // In a real application, you would send this data to a server
            // For this demo, we'll store it in localStorage
            
            // Get existing users or initialize empty array
            const users = JSON.parse(localStorage.getItem('users')) || [];
            
            // Check if username already exists
            const existingUser = users.find(user => user.username === userData.username);
            if (existingUser) {
                // Show inline error for existing username
                const usernameErr = document.getElementById('usernameError');
                usernameErr.textContent = 'Username already exists. Please choose a different username.';
                usernameErr.style.display = 'block';
                return;
            }
            // Check if email already exists
            if (userData.email) {
                const existingEmail = users.find(user => (user.email || '').toLowerCase() === (userData.email || '').toLowerCase());
                if (existingEmail) {
                    const emailErr = document.getElementById('emailError');
                    emailErr.textContent = 'An account with this email already exists.';
                    emailErr.style.display = 'block';
                    return;
                }
            }
            
            // Add new user
            users.push({
                id: Date.now(), // Simple ID generation
                ...userData,
                createdAt: new Date().toISOString()
            });
            
            // Save to localStorage
            localStorage.setItem('users', JSON.stringify(users));
            
            // Show success message (non-blocking) and redirect to login
            showToast('Account created successfully! You can now login with your credentials.');
            // Redirect to login page
            showLoginPage();
        }

        // My Orders Button functionality
        myOrdersBtn.addEventListener('click', function() {
            // Remove active class from all tabs
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Hide all sections
            sections.forEach(section => section.classList.remove('active'));
            
            // Show orders section
            document.getElementById('orders').classList.add('active');
            
            // Update button state
            myOrdersBtn.classList.add('active');
            
            // Refresh orders
            renderOrders();
        });

        // Render menu items
        function renderMenu() {
            menuGrid.innerHTML = '';
            
            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <div class="menu-item-content">
                        <h3>${item.name}</h3>
                        <p>${item.description}</p>
                        <div class="menu-item-footer">
                            <div class="price">${item.price}</div>
                            <button class="add-to-cart-btn" data-id="${item.id}">Add to Cart</button>
                        </div>
                    </div>
                `;
                menuGrid.appendChild(menuItem);
            });

            // Animate menu items on entry (staggered)
            animateList(menuGrid);

            // Add event listeners to Add to Cart buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = parseInt(this.getAttribute('data-id'));
                    addToCart(itemId);
                });
            });
        }

        // Add item to cart
        function addToCart(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            const existingItem = cart.find(i => i.id === itemId);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    ...item,
                    quantity: 1
                });
            }
            
            updateCart();
            showToast(`${item.name} added to cart!`);
        }

        // Update cart UI
        function updateCart() {
            // Save cart to localStorage under the per-user cart key
            try { localStorage.setItem(getCartKey(), JSON.stringify(cart)); } catch(e) { console.error('Failed to save cart', e); }
            
            // Update cart count
            updateCartCount();
            
            // Update cart modal if open
            if (cartModal.classList.contains('active')) {
                renderCartItems();
            }
        }

        // Update cart count in header
        function updateCartCount() {
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
            cartCount.textContent = totalItems;
        }

        // Render cart items in modal
        function renderCartItems() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="empty-cart">Your cart is empty</div>';
                cartTotal.textContent = '0.00';
                return;
            }
            
            let total = 0;
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${item.price}</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="quantity-btn minus" data-index="${index}">-</button>
                        <span class="cart-item-quantity">${item.quantity}</span>
                        <button class="quantity-btn plus" data-index="${index}">+</button>
                        <button class="remove-item" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                cartItems.appendChild(cartItem);
            });
            
            // Show shipping line and grand total
            const shipping = SHIPPING_FEE;
            const grandTotal = total + shipping;

            const shippingRow = document.createElement('div');
            shippingRow.className = 'cart-item summary-item';
            shippingRow.style.borderTop = '1px solid #eee';
            shippingRow.style.marginTop = '10px';
            shippingRow.innerHTML = `<span>Shipping</span><span>${shipping.toFixed(2)}</span>`;
            cartItems.appendChild(shippingRow);

            cartTotal.textContent = `${grandTotal.toFixed(2)}`;
            
            // Add event listeners to cart controls
            document.querySelectorAll('.quantity-btn.minus').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    decreaseQuantity(index);
                });
            });
            
            document.querySelectorAll('.quantity-btn.plus').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    increaseQuantity(index);
                });
            });
            
            document.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removeFromCart(index);
                });
            });
        }

        // Increase item quantity
        function increaseQuantity(index) {
            cart[index].quantity++;
            updateCart();
        }

        // Decrease item quantity
        function decreaseQuantity(index) {
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
            } else {
                cart.splice(index, 1);
            }
            updateCart();
        }

        // Remove item from cart
        function removeFromCart(index) {
            const itemName = cart[index].name;
            cart.splice(index, 1);
            updateCart();
            showToast(`${itemName} removed from cart`);
        }

        // Render orders
        function renderOrders() {
            ordersContainer.innerHTML = '';
            
            if (orders.length === 0) {
                ordersContainer.innerHTML = `
                    <div class="no-orders">
                        <i class="fas fa-shopping-bag" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3>No orders yet</h3>
                        <p>Your orders will appear here once you place them.</p>
                    </div>
                `;
                return;
            }
            
            // Sort orders by date (newest first)
            const sortedOrders = [...orders].sort((a, b) => new Date(b.date) - new Date(a.date));

            // If a customer is logged in, show only their orders (personal storage)
            const visibleOrders = (activeUser && activeUser.role === 'Customer')
                ? sortedOrders.filter(o => o.username === activeUser.username)
                : sortedOrders;

            if (visibleOrders.length === 0) {
                ordersContainer.innerHTML = `
                    <div class="no-orders">
                        <i class="fas fa-shopping-bag" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3>No orders yet</h3>
                        <p>Your orders will appear here once you place them.</p>
                    </div>
                `;
                return;
            }

            visibleOrders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                
                let statusClass = '';
                switch(order.status) {
                    case 'Pending': statusClass = 'status-pending'; break;
                    case 'Preparing': statusClass = 'status-preparing'; break;
                    case 'Out for Delivery': statusClass = 'status-out-for-delivery'; break;
                    case 'Delivered': statusClass = 'status-delivered'; break;
                }
                
                orderCard.innerHTML = `
                    <div class="order-header">
                        <div>
                            <div class="order-id">Order #${order.id}</div>
                            <div class="order-date">${new Date(order.date).toLocaleDateString()}</div>
                        </div>
                        <div class="order-status ${statusClass}">${order.status}</div>
                    </div>
                        <div class="order-items">
                            ${order.items.map(item => `
                                <div class="order-item">
                                    <span>${item.name} x ${item.quantity}</span>
                                    <span>${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="order-summary-lines">
                            <div class="order-subtotal">
                                <span>Items subtotal:</span>
                                <span>${(order.items.reduce((s,i)=>s+(i.price*i.quantity),0)).toFixed(2)}</span>
                            </div>
                            <div class="order-shipping">
                                <span>Shipping (${(order.deliveryType || 'standard').charAt(0).toUpperCase() + (order.deliveryType || 'standard').slice(1)}):</span>
                                <span>${(order.shippingFee || 0).toFixed(2)}</span>
                            </div>
                            ${order.voucherCode ? `
                            <div class="order-voucher">
                                <span>Voucher (${order.voucherCode}):</span>
                                <span>-${(order.voucherDiscount || 0).toFixed ? '' + (order.voucherDiscount || 0).toFixed(2) : ('' + (order.voucherDiscount || 0))}</span>
                            </div>
                            ` : ''}
                            <div class="order-total">
                                <span>Total:</span>
                                <span>${order.total.toFixed(2)}</span>
                            </div>
                        </div>
                    <div class="order-details" id="order-details-${order.id}" style="display:none;">
                        <div class="detail-row">
                            <span class="detail-label">Payment Method:</span>
                            <span class="detail-value">${order.paymentMethod}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Tracking Number:</span>
                            <span class="detail-value">${order.trackingNumber}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Delivery Address:</span>
                            <span class="detail-value">${order.address.fullName}, ${order.address.phoneNumber}<br>
                            ${order.address.streetAddress}, ${order.address.barangay}<br>
                            ${order.address.city}, ${order.address.province} ${order.address.zipCode}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Delivery Type:</span>
                            <span class="detail-value" style="text-transform:capitalize">${order.deliveryType || 'standard'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Shipping Fee:</span>
                            <span class="detail-value">${(order.shippingFee || 0).toFixed(2)}</span>
                        </div>
                        ${order.address.deliveryInstructions ? `
                        <div class="detail-row">
                            <span class="detail-label">Delivery Instructions:</span>
                            <span class="detail-value">${order.address.deliveryInstructions}</span>
                        </div>
                        ` : ''}
                    </div>
                    <!-- Track Order and View Details Buttons -->
                    <div class="order-actions">
                        <button class="track-order-btn" data-order-id="${order.id}">
                            <i class="fas fa-map-marker-alt"></i> Track Order
                        </button>
                        <button class="view-details-btn" data-order-id="${order.id}">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                        ${ (activeUser && activeUser.role === 'Customer' && order.username !== activeUser.username) ? '' : `
                        <button class="delete-order-btn" data-order-id="${order.id}" onclick="deleteOrder('${order.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        ` }
                    </div>
                `;
                
                ordersContainer.appendChild(orderCard);
            });

            // Add event listeners to track order buttons
            document.querySelectorAll('.track-order-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    trackSpecificOrder(orderId);
                });
            });

            // Add event listeners to view details buttons (toggle details)
            document.querySelectorAll('.view-details-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    // call existing function which will now toggle the details block
                    viewOrderDetails(orderId);
                });
            });

            // Add event listeners to delete buttons for specific orders
            document.querySelectorAll('.delete-order-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    deleteOrder(orderId);
                });
            });

            // Animate order cards
            animateList(ordersContainer);
        }

        // Track specific order function - AUTOMATIC REDIRECT TO TRACKING
        function trackSpecificOrder(orderId) {
            // Navigate to Track Order section
            document.querySelector('.nav-tab[data-tab="track-order"]').click();
            
            // Set the order ID in the search field automatically
            orderSearch.value = orderId;
            
            // Automatically trigger the search and display tracking info
            displayTrackingInfo(orderId);
        }

        // Display tracking information automatically
        function displayTrackingInfo(orderId) {
            const order = orders.find(o => o.id === orderId);
            
            if (!order) {
                trackingResult.innerHTML = `
                    <div class="no-orders">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3>Order not found</h3>
                        <p>Please check your order ID and try again.</p>
                    </div>
                `;
                return;
            }
            
            // Render tracking information automatically
            renderTrackingInfo(order);
        }

        // View order details function
        function viewOrderDetails(orderId) {
            // Ensure My Orders section is visible
            myOrdersBtn.click();

            // Scroll to the order card and toggle the details block
            const orderCards = document.querySelectorAll('.order-card');
            orderCards.forEach(card => {
                if (card.querySelector('.order-id') && card.querySelector('.order-id').textContent.includes(orderId)) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // briefly highlight
                    card.style.border = '2px solid #ff4500';
                    card.style.boxShadow = '0 8px 25px rgba(255, 69, 0, 0.3)';
                    setTimeout(() => {
                        card.style.border = '';
                        card.style.boxShadow = '';
                    }, 1800);

                    // toggle details visibility
                    try {
                        const detailsEl = document.getElementById(`order-details-${orderId}`);
                        if (detailsEl) {
                            if (detailsEl.style.display === 'none' || !detailsEl.style.display) {
                                detailsEl.style.display = 'block';
                            } else {
                                detailsEl.style.display = 'none';
                            }
                        }
                    } catch (e) { console.error('Toggle details failed', e); }
                }
            });
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Tab navigation
        navTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-tab');
                
                // Update active tab
                navTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Remove active class from My Orders button
                myOrdersBtn.classList.remove('active');
                
                // Show target section
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === targetTab) {
                        section.classList.add('active');
                    }
                });
                // Update visibility of Back button when tabs change
                try { if (typeof updateBackBtnVisibility === 'function') updateBackBtnVisibility(); } catch(e) {}
            });
        });

        // Cart modal controls
        cartButton.addEventListener('click', function() {
            renderCartItems();
            cartModal.classList.add('active');
        });

        closeCart.addEventListener('click', function() {
            cartModal.classList.remove('active');
        });

        // Close modal when clicking outside
        cartModal.addEventListener('click', function(e) {
            if (e.target === cartModal) {
                cartModal.classList.remove('active');
            }
        });

        // Checkout functionality
        checkoutBtn.addEventListener('click', function() {
            if (cart.length === 0) {
                alert('Your cart is empty. Add some items before checking out.');
                return;
            }
            
            // Close cart modal
            cartModal.classList.remove('active');
            
            // Show address modal
            showAddressModal();
        });

        // Show address modal
        function showAddressModal() {
            // Ensure delivery option controls exist in the address modal
            if (!document.getElementById('deliveryOptions')) {
                const deliveryWrapper = document.createElement('div');
                deliveryWrapper.id = 'deliveryOptions';
                deliveryWrapper.style.margin = '12px 0';
                deliveryWrapper.innerHTML = `
                    <label style="font-weight:700;display:block;margin-bottom:8px;">Delivery Method</label>
                    <label style="display:inline-flex;align-items:center;margin-right:12px;">
                        <input type="radio" name="delivery" value="pickup"> <span style="margin-left:6px">Pick-up (Free)</span>
                    </label>
                    <label style="display:inline-flex;align-items:center;margin-right:12px;">
                        <input type="radio" name="delivery" value="standard"> <span style="margin-left:6px">Standard (${SHIPPING_FEE.toFixed(2)})</span>
                    </label>
                    <label style="display:inline-flex;align-items:center;margin-right:12px;">
                        <input type="radio" name="delivery" value="express"> <span style="margin-left:6px">Express (${(DELIVERY_OPTIONS.express).toFixed(2)})</span>
                    </label>
                `;
                // insert the controls before the order items summary
                const ref = addressOrderItems || addressForm;
                if (ref && ref.parentNode) ref.parentNode.insertBefore(deliveryWrapper, ref);
            }

            // Render order summary (will include shipping based on selection)
            renderAddressOrderSummary();

            // Reset form
            addressForm.reset();
            // pre-select currentDelivery
            const radios = document.querySelectorAll('#deliveryOptions input[name="delivery"]');
            radios.forEach(r => { if (r.value === currentDelivery) r.checked = true; });

            // Show address modal
            addressModal.classList.add('active');
        }

        // Show or hide the Back to Menu button depending on active tab
        function updateBackBtnVisibility() {
            try {
                const backBtn = document.getElementById('backToMenuBtn');
                if (!backBtn) return;
                const active = document.querySelector('.nav-tab.active');
                const activeTab = active ? active.getAttribute('data-tab') : 'menu';
                if (activeTab === 'menu') {
                    backBtn.style.display = 'none';
                } else {
                    backBtn.style.display = 'inline-flex';
                }
            } catch (e) { console.error('Failed to update back button visibility', e); }
        }

        // Render order summary in address modal
        function renderAddressOrderSummary() {
            addressOrderItems.innerHTML = '';
            
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const summaryItem = document.createElement('div');
                summaryItem.className = 'summary-item';
                summaryItem.innerHTML = `
                    <span>${item.name} x ${item.quantity}</span>
                    <span>${itemTotal.toFixed(2)}</span>
                `;
                addressOrderItems.appendChild(summaryItem);
            });
            
            // determine shipping based on selected delivery option
            const shipping = (currentDelivery && DELIVERY_OPTIONS[currentDelivery] != null) ? DELIVERY_OPTIONS[currentDelivery] : DELIVERY_OPTIONS.standard;
            const grandTotal = total + shipping;

            // show delivery type row
            const deliveryRow = document.createElement('div');
            deliveryRow.className = 'summary-item';
            deliveryRow.innerHTML = `<span>Delivery:</span><span style="text-transform:capitalize">${currentDelivery}</span>`;
            addressOrderItems.appendChild(deliveryRow);

            // add shipping row
            const shipEl = document.createElement('div');
            shipEl.className = 'summary-item';
            shipEl.innerHTML = `<span>Shipping</span><span>${shipping.toFixed(2)}</span>`;
            addressOrderItems.appendChild(shipEl);

            addressOrderTotal.textContent = `${grandTotal.toFixed(2)}`;
        }

        // Close address modal
        closeAddress.addEventListener('click', function() {
            addressModal.classList.remove('active');
        });

        // Close address modal when clicking outside
        addressModal.addEventListener('click', function(e) {
            if (e.target === addressModal) {
                addressModal.classList.remove('active');
            }
        });

        // Continue to payment
        continuePaymentBtn.addEventListener('click', function() {
            // Validate address form
            if (!validateAddressForm()) {
                return;
            }
            
            // Save address data (support select-based PH dropdowns)
            const getVal = (id) => {
                const el = document.getElementById(id) || document.getElementById(id + 'Select');
                return el ? el.value : '';
            };

            currentAddress = {
                fullName: getVal('fullName'),
                phoneNumber: getVal('phoneNumber'),
                streetAddress: getVal('streetAddress'),
                barangay: getVal('barangay'),
                city: getVal('city'),
                province: getVal('province'),
                zipCode: getVal('zipCode'),
                deliveryInstructions: getVal('deliveryInstructions')
            };
            // read delivery option selection
            const sel = document.querySelector('#deliveryOptions input[name="delivery"]:checked');
            if (sel && sel.value) currentDelivery = sel.value;
            else currentDelivery = currentDelivery || 'standard';
            
            // Close address modal
            addressModal.classList.remove('active');
            
            // Show payment modal
            showPaymentModal();
        });

        // Validate address form
        function validateAddressForm() {
            const requiredIds = [
                'fullName', 'phoneNumber', 'streetAddress', 
                'barangay', 'city', 'province', 'zipCode'
            ];

            for (const id of requiredIds) {
                // support both original text inputs and new select elements (id or id + 'Select')
                const field = document.getElementById(id) || document.getElementById(id + 'Select');
                const labelEl = document.querySelector(`[for="${field && field.id}"]`) || (field && field.previousElementSibling);
                const labelText = labelEl ? labelEl.textContent.replace('*', '').trim() : id;
                if (!field || !String(field.value || '').trim()) {
                    alert(`Please fill in the ${labelText} field`);
                    if (field && typeof field.focus === 'function') field.focus();
                    return false;
                }
            }

            return true;
        }

        // Show payment modal
        function showPaymentModal() {
            // Render order summary
            renderPaymentOrderSummary();
            
            // Reset payment method selection
            paymentMethods.forEach(method => method.classList.remove('selected'));
            paymentForms.forEach(form => form.classList.remove('active'));
            
            // Show payment modal
            paymentModal.classList.add('active');
        }

        // Render order summary in payment modal
        function renderPaymentOrderSummary() {
            paymentOrderItems.innerHTML = '';
            
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const summaryItem = document.createElement('div');
                summaryItem.className = 'summary-item';
                summaryItem.innerHTML = `
                    <span>${item.name} x ${item.quantity}</span>
                    <span>${itemTotal.toFixed(2)}</span>
                `;
                paymentOrderItems.appendChild(summaryItem);
            });
            
            // determine shipping based on selected delivery option
            const shipping = (currentDelivery && DELIVERY_OPTIONS[currentDelivery] != null) ? DELIVERY_OPTIONS[currentDelivery] : DELIVERY_OPTIONS.standard;

            // compute voucher adjustments
            let voucherDiscount = 0;
            let voucherLabel = '';
            let extraFreeItem = null;
            if (appliedVoucher && VOUCHERS[appliedVoucher]) {
                const v = VOUCHERS[appliedVoucher];
                voucherLabel = appliedVoucher;
                if (v.type === 'shipping') {
                    voucherDiscount = shipping; // waive shipping
                } else if (v.type === 'percent') {
                    voucherDiscount = (v.value / 100) * total;
                } else if (v.type === 'fixed') {
                    voucherDiscount = v.value;
                } else if (v.type === 'free_item') {
                    extraFreeItem = v.item;
                    // free item has price 0 so no discount to subtotal, we'll just add the item visually
                }
            }

            const grandTotal = Math.max(0, total + shipping - voucherDiscount);

            // show delivery type row
            const deliveryRow = document.createElement('div');
            deliveryRow.className = 'summary-item';
            deliveryRow.innerHTML = `<span>Delivery:</span><span style="text-transform:capitalize">${currentDelivery}</span>`;
            paymentOrderItems.appendChild(deliveryRow);

            // add shipping row
            const shipEl = document.createElement('div');
            shipEl.className = 'summary-item';
            shipEl.innerHTML = `<span>Shipping</span><span>${shipping.toFixed(2)}</span>`;
            paymentOrderItems.appendChild(shipEl);

            // show voucher row if applied
            if (appliedVoucher) {
                const voucherEl = document.createElement('div');
                voucherEl.className = 'summary-item';
                voucherEl.innerHTML = `<span>Voucher: ${appliedVoucher}</span><span>-${voucherDiscount > 0 ? '' + voucherDiscount.toFixed(2) : (VOUCHERS[appliedVoucher] && VOUCHERS[appliedVoucher].type === 'shipping' ? 'Shipping waived' : 'Applied')}</span>`;
                paymentOrderItems.appendChild(voucherEl);
            }

            // show free item if voucher gives one
            if (extraFreeItem) {
                const freeEl = document.createElement('div');
                freeEl.className = 'summary-item';
                freeEl.innerHTML = `<span>Free: ${extraFreeItem.name}</span><span>0.00</span>`;
                paymentOrderItems.appendChild(freeEl);
            }

            paymentOrderTotal.textContent = `${grandTotal.toFixed(2)}`;
        }

        // Payment method selection
        paymentMethods.forEach(method => {
            method.addEventListener('click', function() {
                // Remove selected class from all methods
                paymentMethods.forEach(m => m.classList.remove('selected'));
                
                // Add selected class to clicked method
                this.classList.add('selected');
                
                // Get selected payment method
                const selectedMethod = this.getAttribute('data-method');
                
                // Hide all payment forms
                paymentForms.forEach(form => form.classList.remove('active'));
                
                // Show relevant payment form
                if (selectedMethod !== 'cash') {
                    document.getElementById(`${selectedMethod}Form`).classList.add('active');
                }
            });
        });

        // Voucher apply handler
        if (applyVoucherBtn) {
            applyVoucherBtn.addEventListener('click', function() {
                const code = (voucherInput && voucherInput.value || '').trim().toUpperCase();
                if (!code) {
                    if (voucherMessage) { voucherMessage.style.display = 'block'; voucherMessage.textContent = 'Please enter a voucher code'; voucherMessage.style.background = 'rgba(255,0,0,0.2)'; }
                    return;
                }
                if (VOUCHERS[code]) {
                    appliedVoucher = code;
                    if (voucherMessage) { voucherMessage.style.display = 'block'; voucherMessage.textContent = `Voucher ${code} applied`; voucherMessage.style.background = 'rgba(0,128,0,0.25)'; }
                } else {
                    appliedVoucher = null;
                    if (voucherMessage) { voucherMessage.style.display = 'block'; voucherMessage.textContent = `Invalid voucher code`; voucherMessage.style.background = 'rgba(255,0,0,0.2)'; }
                }
                // re-render payment summary to reflect voucher
                renderPaymentOrderSummary();
            });
        }

        // Close payment modal
        closePayment.addEventListener('click', function() {
            paymentModal.classList.remove('active');
        });

        // Confirmation modal helper
        function showConfirm(message, onConfirm) {
            // Ensure the confirm modal is attached to the document body so it is
            // visible regardless of which dashboard container is currently shown.
            if (confirmModal && confirmModal.parentNode !== document.body) {
                document.body.appendChild(confirmModal);
            }

            confirmMessage.textContent = message || 'Are you sure?';
            confirmCallback = typeof onConfirm === 'function' ? onConfirm : null;
            confirmModal.classList.add('active');
            // focus Confirm button for keyboard users
            setTimeout(() => confirmYesBtn.focus(), 80);
        }

        function closeConfirm() {
            confirmModal.classList.remove('active');
            confirmCallback = null;
        }

        confirmYesBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirmCallback) {
                try { confirmCallback(); } catch (err) { console.error(err); }
            }
            closeConfirm();
        });

        confirmNoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            closeConfirm();
        });

        closeConfirmModal.addEventListener('click', function() { closeConfirm(); });

        // Restore modal helpers
        function findLatestKey(prefix) {
            try {
                const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
                if (!keys.length) return null;
                // latest by numeric timestamp in suffix
                keys.sort((a,b)=>{
                    const ta = parseInt(a.split('_').pop()) || 0;
                    const tb = parseInt(b.split('_').pop()) || 0;
                    return ta - tb;
                });
                return keys[keys.length - 1];
            } catch (e) { console.error('findLatestKey failed', e); return null; }
        }

        function listLatestBackups() {
            if (!restoreList) return;
            restoreList.innerHTML = '';

            // gather per-item deleted menu item keys so we can show a single "Restore" row
            const itemDeletedKeys = Object.keys(localStorage).filter(k => k.startsWith('menuItem_deleted_')).sort((a,b)=>{
                const ta = parseInt(a.split('_').pop()) || 0;
                const tb = parseInt(b.split('_').pop()) || 0;
                return tb - ta; // newest first
            });

            const types = [
                { keyPrefix: 'orders_backup_', label: 'Orders', targetKey: 'orders' },
                { keyPrefix: 'menuItems_backup_', label: 'Menu Items', targetKey: 'menuItems' },
                { keyPrefix: 'users_backup_', label: 'Users', targetKey: 'users' }
            ];

            types.forEach(type => {
                // Find all backups for this type, newest first
                const keys = Object.keys(localStorage).filter(k => k.startsWith(type.keyPrefix)).sort((a,b)=>{
                    const ta = parseInt(a.split('_').pop()) || 0;
                    const tb = parseInt(b.split('_').pop()) || 0;
                    return tb - ta; // newest first
                });

                const headerLi = document.createElement('li');
                headerLi.style.padding = '8px 0';
                headerLi.innerHTML = `<strong>${type.label}</strong>`;
                restoreList.appendChild(headerLi);

                if (!keys.length) {
                    // If there are no full backups for Menu Items but there are per-item deleted backups,
                    // show a single Restore row that restores the most recent deleted item (matches Users UI)
                    if (type.keyPrefix === 'menuItems_backup_' && itemDeletedKeys && itemDeletedKeys.length) {
                        const key = itemDeletedKeys[0];
                        const ts = key.split('_').pop();
                        const date = new Date(parseInt(ts));

                        const li = document.createElement('li');
                        li.style.display = 'flex';
                        li.style.justifyContent = 'space-between';
                        li.style.alignItems = 'center';
                        li.style.padding = '6px 0';

                        const left = document.createElement('div');
                        left.style.flex = '1';
                        left.innerHTML = `<div style="font-weight:600">Deleted Menu Item (latest)</div><div style="font-size:12px;color:#666">Backup: ${key}  ${isNaN(date.getTime()) ? 'unknown' : date.toLocaleString()}</div>`;

                        const btnWrap = document.createElement('div');
                        const restoreBtn = document.createElement('button');
                        restoreBtn.className = 'admin-btn';
                        restoreBtn.textContent = 'Restore';
                        restoreBtn.addEventListener('click', function() {
                            showConfirm(`Restore the most recently deleted menu item from ${key}? This will append it back to the menu.`, function() {
                                try {
                                    restoreLatestDeletedMenuItem();
                                    closeRestoreModalFn();
                                } catch (err) { console.error('Restore latest deleted item failed', err); showToast('Restore failed (see console)'); }
                            });
                        });
                        btnWrap.appendChild(restoreBtn);

                        li.appendChild(left);
                        li.appendChild(btnWrap);
                        restoreList.appendChild(li);
                        return;
                    }

                    const noneLi = document.createElement('li');
                    noneLi.style.fontSize = '12px';
                    noneLi.style.color = '#666';
                    noneLi.style.padding = '6px 0 12px 0';
                    noneLi.textContent = 'No backups found';
                    restoreList.appendChild(noneLi);
                    return;
                }

                keys.forEach(key => {
                    try {
                        const ts = key.split('_').pop();
                        const date = new Date(parseInt(ts));

                        const li = document.createElement('li');
                        li.style.display = 'flex';
                        li.style.justifyContent = 'space-between';
                        li.style.alignItems = 'center';
                        li.style.padding = '6px 0';

                        const left = document.createElement('div');
                        left.style.flex = '1';
                        left.innerHTML = `<div style="font-weight:600">${key}</div><div style="font-size:12px;color:#666">${isNaN(date.getTime()) ? 'unknown' : date.toLocaleString()}</div>`;

                        const btnWrap = document.createElement('div');
                        const restoreBtn = document.createElement('button');
                        restoreBtn.className = 'admin-btn';
                        restoreBtn.textContent = 'Restore';
                        restoreBtn.addEventListener('click', function() {
                            showConfirm(`Restore ${type.label} from ${key}? This will overwrite current ${type.targetKey}.`, function() {
                                try {
                                    const raw = localStorage.getItem(key);
                                    if (!raw) { showToast('Backup not found'); return; }
                                    const data = JSON.parse(raw);
                                    localStorage.setItem(type.targetKey, JSON.stringify(data));

                                    // Rehydrate in-memory copies if present
                                    if (type.targetKey === 'orders') {
                                        try { orders = JSON.parse(localStorage.getItem('orders') || '[]'); } catch(e) { orders = []; }
                                        if (typeof renderStaffOrders === 'function') renderStaffOrders();
                                        if (typeof renderOrders === 'function') renderOrders();
                                    } else if (type.targetKey === 'menuItems') {
                                        try { menuItems = JSON.parse(localStorage.getItem('menuItems') || '[]'); } catch(e) { menuItems = []; }
                                        if (typeof renderAdminMenuItems === 'function') renderAdminMenuItems();
                                        if (typeof renderMenu === 'function') renderMenu();
                                    } else if (type.targetKey === 'users') {
                                        try { users = JSON.parse(localStorage.getItem('users') || '[]'); } catch(e) { users = []; }
                                        if (typeof renderAdminUsers === 'function') renderAdminUsers();
                                    }

                                    showToast(`${type.label} restored from backup`);
                                    closeRestoreModalFn();
                                } catch (err) { console.error('Restore failed', err); showToast('Restore failed (see console)'); }
                            });
                        });
                        btnWrap.appendChild(restoreBtn);

                        li.appendChild(left);
                        li.appendChild(btnWrap);
                        restoreList.appendChild(li);
                    } catch (e) { console.error('Failed to render backup entry', e); }
                });
            });
        }

        // Restore the most recently deleted menu item (if any)  used by modal button
        function restoreLatestDeletedMenuItem() {
            try {
                const keys = Object.keys(localStorage).filter(k => k.startsWith('menuItem_deleted_')).sort((a,b)=>{
                    const ta = parseInt(a.split('_').pop()) || 0;
                    const tb = parseInt(b.split('_').pop()) || 0;
                    return tb - ta; // newest first
                });
                if (!keys.length) { showToast('No deleted menu item backups found'); return; }
                const key = keys[0];
                const raw = localStorage.getItem(key);
                if (!raw) { showToast('Backup key found but no data at ' + key); return; }
                const item = JSON.parse(raw);
                const currentMenu = JSON.parse(localStorage.getItem('menuItems') || '[]');
                if (currentMenu.find(m => m.id === item.id)) { showToast('Item already exists in menu'); return; }
                currentMenu.push(item);
                localStorage.setItem('menuItems', JSON.stringify(currentMenu));
                try { menuItems = JSON.parse(localStorage.getItem('menuItems')||'[]'); } catch(e) { menuItems = currentMenu; }
                if (typeof renderAdminMenuItems === 'function') renderAdminMenuItems();
                if (typeof renderMenu === 'function') renderMenu();
                showToast('Restored menu item: ' + (item.name || item.id));
            } catch (err) { console.error('restoreLatestDeletedMenuItem failed', err); showToast('Restore failed (see console)'); }
        }

        
                // Also list individually backed-up deleted menu items (keys like menuItem_deleted_<id>_<ts>)
                const itemDeletedKeys = Object.keys(localStorage).filter(k => k.startsWith('menuItem_deleted_')).sort((a,b)=>{
                    const ta = parseInt(a.split('_').pop()) || 0;
                    const tb = parseInt(b.split('_').pop()) || 0;
                    return tb - ta; // newest first
                });

                if (itemDeletedKeys.length) {
                    const headerLi = document.createElement('li');
                    headerLi.style.padding = '8px 0';
                    headerLi.innerHTML = '<strong>Deleted Menu Items</strong>';
                    restoreList.appendChild(headerLi);

                    itemDeletedKeys.forEach(key => {
                        try {
                            const ts = key.split('_').pop();
                            const date = new Date(parseInt(ts));
                            const raw = localStorage.getItem(key);
                            const itemObj = raw ? JSON.parse(raw) : null;

                            const li2 = document.createElement('li');
                            li2.style.display = 'flex';
                            li2.style.justifyContent = 'space-between';
                            li2.style.alignItems = 'center';
                            li2.style.padding = '6px 0';

                            const left2 = document.createElement('div');
                            left2.style.flex = '1';
                            left2.innerHTML = `<div style="font-weight:600">${itemObj && itemObj.name ? itemObj.name : key}</div><div style="font-size:12px;color:#666">Backup: ${key}  ${isNaN(date.getTime()) ? 'unknown' : date.toLocaleString()}</div>`;

                            const btnWrap2 = document.createElement('div');
                            const restoreItemBtn = document.createElement('button');
                            restoreItemBtn.className = 'admin-btn';
                            restoreItemBtn.textContent = 'Restore';
                            restoreItemBtn.addEventListener('click', function() {
                                showConfirm(`Restore item ${itemObj && itemObj.name ? itemObj.name : key} from ${key}? This will append it back to the menu.`, function() {
                                    try {
                                        const raw2 = localStorage.getItem(key);
                                        if (!raw2) { showToast('Backup not found'); return; }
                                        const itemToRestore = JSON.parse(raw2);
                                        const currentMenu = JSON.parse(localStorage.getItem('menuItems')) || [];
                                        // avoid duplicate ids
                                        const exists = currentMenu.find(m => m.id === itemToRestore.id);
                                        if (exists) { showToast('Item already exists in menu'); return; }
                                        currentMenu.push(itemToRestore);
                                        localStorage.setItem('menuItems', JSON.stringify(currentMenu));
                                        try { menuItems = JSON.parse(localStorage.getItem('menuItems')||'[]'); } catch(e) { menuItems = []; }
                                        if (typeof renderAdminMenuItems === 'function') renderAdminMenuItems();
                                        if (typeof renderMenu === 'function') renderMenu();
                                        showToast('Menu item restored');
                                        closeRestoreModalFn();
                                    } catch (err) { console.error('Restore deleted item failed', err); showToast('Restore failed (see console)'); }
                                });
                            });
                            btnWrap2.appendChild(restoreItemBtn);

                            li2.appendChild(left2);
                            li2.appendChild(btnWrap2);
                            restoreList.appendChild(li2);
                        } catch (e) { console.error('Failed to render deleted menu item entry', e); }
                    });
                }

                // Also list individually backed-up deleted users (keys like user_deleted_<username>_<ts>)
            const userDeletedKeys = Object.keys(localStorage).filter(k => k.startsWith('user_deleted_')).sort((a,b)=>{
                const ta = parseInt(a.split('_').pop()) || 0;
                const tb = parseInt(b.split('_').pop()) || 0;
                return tb - ta; // newest first
            });

            if (userDeletedKeys.length) {
                const headerLi = document.createElement('li');
                headerLi.style.padding = '8px 0';
                headerLi.innerHTML = '<strong>Deleted Users</strong>';
                restoreList.appendChild(headerLi);

                userDeletedKeys.forEach(key => {
                    try {
                        const parts = key.split('_');
                        // format: user_deleted_<username>_<ts>
                        const ts = parts.pop();
                        parts.shift(); // user
                        parts.shift(); // deleted
                        const username = parts.join('_');

                        const li2 = document.createElement('li');
                        li2.style.display = 'flex';
                        li2.style.justifyContent = 'space-between';
                        li2.style.alignItems = 'center';

                        const left2 = document.createElement('div');
                        left2.style.flex = '1';
                        const date = new Date(parseInt(ts));
                        left2.innerHTML = `<div style="font-weight:600">${username}</div><div style="font-size:12px;color:#666">Backup: ${key}  ${isNaN(date.getTime()) ? 'unknown' : date.toLocaleString()}</div>`;

                        const btnWrap2 = document.createElement('div');

                        const restoreUserBtn = document.createElement('button');
                        restoreUserBtn.className = 'admin-btn';
                        restoreUserBtn.textContent = 'Restore';
                        restoreUserBtn.addEventListener('click', function() {
                            showConfirm(`Restore user ${username} from backup ${key}?`, function() {
                                try {
                                    const raw = localStorage.getItem(key);
                                    if (!raw) { showToast('Backup not found'); return; }
                                    const userObj = JSON.parse(raw);
                                    const users = JSON.parse(localStorage.getItem('users')) || [];
                                    const exists = users.find(u=>u.username===userObj.username);
                                    if (exists) { showToast('User already exists'); return; }
                                    users.push(userObj);
                                    localStorage.setItem('users', JSON.stringify(users));
                                    if (typeof renderAdminUsers === 'function') renderAdminUsers();
                                    showToast('User restored');
                                    closeRestoreModalFn();
                                } catch (err) { console.error('Restore user failed', err); showToast('Restore failed (see console)'); }
                            });
                        });

                        btnWrap2.appendChild(restoreUserBtn);

                        // If there is a user orders backup for this username, show restore orders button
                        const userOrdersPrefix = 'orders_backup_user_' + username + '_';
                        const latestOrdersKey = findLatestKey(userOrdersPrefix);
                        if (latestOrdersKey) {
                            const restoreOrdersBtn = document.createElement('button');
                            restoreOrdersBtn.className = 'admin-btn';
                            restoreOrdersBtn.textContent = 'Restore Orders';
                            restoreOrdersBtn.style.marginLeft = '8px';
                            restoreOrdersBtn.addEventListener('click', function() {
                                showConfirm(`Restore orders for ${username} from ${latestOrdersKey}? This will append those orders to current orders.`, function() {
                                    try {
                                        const rawO = localStorage.getItem(latestOrdersKey);
                                        if (!rawO) { showToast('Orders backup not found'); return; }
                                        const backedOrders = JSON.parse(rawO) || [];
                                        const orders = JSON.parse(localStorage.getItem('orders')) || [];
                                        // avoid duplicate order ids
                                        const existingIds = new Set(orders.map(o=>o.id));
                                        backedOrders.forEach(o => { if (!existingIds.has(o.id)) orders.push(o); });
                                        localStorage.setItem('orders', JSON.stringify(orders));
                                        try { orders = JSON.parse(localStorage.getItem('orders')||'[]'); } catch(e) { orders = []; }
                                        if (typeof renderStaffOrders === 'function') renderStaffOrders();
                                        if (typeof renderOrders === 'function') renderOrders();
                                        showToast('User orders restored');
                                        closeRestoreModalFn();
                                    } catch (err) { console.error('Restore user orders failed', err); showToast('Restore failed (see console)'); }
                                });
                            });
                            btnWrap2.appendChild(restoreOrdersBtn);
                        }

                        li2.appendChild(left2);
                        li2.appendChild(btnWrap2);
                        restoreList.appendChild(li2);
                    } catch (e) { console.error('Failed to render deleted user entry', e); }
                });
            }

        function openRestoreModalFn() {
            if (restoreModal && restoreModal.parentNode !== document.body) document.body.appendChild(restoreModal);
            listLatestBackups();
            restoreModal.classList.add('active');
        }

        function closeRestoreModalFn() {
            if (!restoreModal) return;
            restoreModal.classList.remove('active');
            restoreList.innerHTML = '';
        }

    if (openRestoreBtnAdmin) openRestoreBtnAdmin.addEventListener('click', function() { openRestoreModalFn(); });
        if (closeRestoreModal) closeRestoreModal.addEventListener('click', function() { closeRestoreModalFn(); });
        if (restoreCancelBtn) restoreCancelBtn.addEventListener('click', function() { closeRestoreModalFn(); });

        // Close confirm modal when clicking outside
        confirmModal.addEventListener('click', function(e) {
            if (e.target === confirmModal) closeConfirm();
        });

        // Admin item modal controls
        closeAdminItemModal.addEventListener('click', closeAdminItemModalFn);
        cancelAdminItemBtn.addEventListener('click', function(e) { e.preventDefault(); closeAdminItemModalFn(); });
        saveAdminItemBtn.addEventListener('click', function(e) { e.preventDefault(); saveAdminItem(); });

        // Close admin modal when clicking outside
        adminItemModal.addEventListener('click', function(e) {
            if (e.target === adminItemModal) closeAdminItemModalFn();
        });

        // Close payment modal when clicking outside
        paymentModal.addEventListener('click', function(e) {
            if (e.target === paymentModal) {
                paymentModal.classList.remove('active');
            }
        });

        // Confirm payment
        confirmPaymentBtn.addEventListener('click', function() {
            const selectedMethod = document.querySelector('.payment-method.selected');
            
            if (!selectedMethod) {
                alert('Please select a payment method');
                return;
            }
            
            const paymentMethod = selectedMethod.getAttribute('data-method');
            let paymentValid = true;
            
            // Validate payment details based on method
            if (paymentMethod === 'card') {
                const cardNumber = document.getElementById('cardNumber').value;
                const expiryDate = document.getElementById('expiryDate').value;
                const cvv = document.getElementById('cvv').value;
                const cardName = document.getElementById('cardName').value;
                
                if (!cardNumber || !expiryDate || !cvv || !cardName) {
                    paymentValid = false;
                    alert('Please fill in all card details');
                }
            } else if (paymentMethod === 'gcash') {
                const gcashNumber = document.getElementById('gcashNumber').value;
                const gcashName = document.getElementById('gcashName').value;
                
                if (!gcashNumber || !gcashName) {
                    paymentValid = false;
                    alert('Please fill in all GCash details');
                }
            }
            
            if (paymentValid) {
                processPayment(paymentMethod);
            }
        });

        // Process payment and create order
        function processPayment(paymentMethod) {
            const itemsTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = (currentDelivery && DELIVERY_OPTIONS[currentDelivery] != null) ? DELIVERY_OPTIONS[currentDelivery] : DELIVERY_OPTIONS.standard;

            // compute voucher adjustments
            let voucherDiscount = 0;
            let extraFreeItem = null;
            if (appliedVoucher && VOUCHERS[appliedVoucher]) {
                const v = VOUCHERS[appliedVoucher];
                if (v.type === 'shipping') {
                    voucherDiscount = shipping;
                } else if (v.type === 'percent') {
                    voucherDiscount = (v.value / 100) * itemsTotal;
                } else if (v.type === 'fixed') {
                    voucherDiscount = v.value;
                } else if (v.type === 'free_item') {
                    extraFreeItem = v.item;
                }
            }

            const total = Math.max(0, itemsTotal + shipping - voucherDiscount);
            
            // Generate tracking number
            const trackingNumber = 'TRK' + Date.now().toString().substring(7);
            
            // Create new order
            latestOrder = {
                id: 'ORD' + Date.now(),
                date: new Date().toISOString(),
                items: (function(){
                    const itemsCopy = [...cart];
                    if (extraFreeItem) itemsCopy.push(Object.assign({}, extraFreeItem, { quantity: 1 }));
                    return itemsCopy;
                })(),
                total: total,
                shippingFee: shipping,
                deliveryType: currentDelivery,
                status: 'Pending',
                paymentMethod: getPaymentMethodName(paymentMethod),
                trackingNumber: trackingNumber,
                address: {...currentAddress},
                voucherCode: appliedVoucher || null,
                voucherDiscount: voucherDiscount || 0,
                // associate order with logged-in user when available
                username: activeUser && activeUser.username ? activeUser.username : null
            };
            
            // Add to orders
            orders.push(latestOrder);
            localStorage.setItem('orders', JSON.stringify(orders));
            // Do NOT add revenue here. Revenue will be recorded when order is marked Delivered to avoid counting on placement.
            
            // Clear cart
            cart = [];
            updateCart();
            
            // Close payment modal
            paymentModal.classList.remove('active');
            
            // Show success modal
            showSuccessModal(latestOrder);
        }

        // Show success modal
        function showSuccessModal(order) {
            // Render order details in success modal
            const itemsSubtotal = (order.items || []).reduce((s,i)=>s + ((i.price||0) * (i.quantity||1)), 0);
            successOrderInfo.innerHTML = `
                <div class="order-info-item">
                    <span class="order-info-label">Order ID:</span>
                    <span class="order-info-value">${order.id}</span>
                </div>
                <div class="order-info-item">
                    <span class="order-info-label">Tracking Number:</span>
                    <span class="order-info-value">${order.trackingNumber}</span>
                </div>
                <div class="order-info-item">
                    <span class="order-info-label">Items subtotal:</span>
                    <span class="order-info-value">${itemsSubtotal.toFixed(2)}</span>
                </div>
                <div class="order-info-item">
                    <span class="order-info-label">Delivery Type:</span>
                    <span class="order-info-value" style="text-transform:capitalize">${order.deliveryType || 'standard'}</span>
                </div>
                <div class="order-info-item">
                    <span class="order-info-label">Shipping Fee:</span>
                    <span class="order-info-value">${(order.shippingFee || 0).toFixed(2)}</span>
                </div>
                ${order.voucherCode ? `
                <div class="order-info-item">
                    <span class="order-info-label">Voucher:</span>
                    <span class="order-info-value">${order.voucherCode} - Discount ${(order.voucherDiscount||0).toFixed(2)}</span>
                </div>
                ` : ''}
                <div class="order-info-item">
                    <span class="order-info-label">Total Amount:</span>
                    <span class="order-info-value">${order.total.toFixed(2)}</span>
                </div>
                <div class="order-info-item">
                    <span class="order-info-label">Payment Method:</span>
                    <span class="order-info-value">${order.paymentMethod}</span>
                </div>
                <div class="order-info-item">
                    <span class="order-info-label">Delivery Address:</span>
                    <span class="order-info-value">${order.address.streetAddress}, ${order.address.barangay}</span>
                </div>
            `;
            
            // Show success modal
            successModal.classList.add('active');
        }

        // View Orders button in success modal
        viewOrdersBtn.addEventListener('click', function() {
            // Close success modal
            successModal.classList.remove('active');
            
            // Navigate to My Orders section
            myOrdersBtn.click();
        });

        // Continue Shopping button in success modal
        continueShoppingBtn.addEventListener('click', function() {
            // Close success modal
            successModal.classList.remove('active');
            
            // Navigate to Menu section
            document.querySelector('.nav-tab[data-tab="menu"]').click();
        });

        // Get payment method display name
        function getPaymentMethodName(method) {
            switch(method) {
                case 'cash': return 'Cash on Delivery';
                case 'card': return 'Credit/Debit Card';
                case 'gcash': return 'GCash';
                default: return 'Unknown';
            }
        }

        // Track order functionality
        searchOrderBtn.addEventListener('click', function() {
            const orderId = orderSearch.value.trim();
            
            if (!orderId) {
                alert('Please enter an order ID');
                return;
            }
            
            displayTrackingInfo(orderId);
        });

        // Render tracking information
        function renderTrackingInfo(order) {
            const steps = [
                { 
                    id: 'ordered', 
                    title: 'Order Placed', 
                    description: 'We have received your order',
                    icon: 'fas fa-shopping-cart',
                    completed: true
                },
                { 
                    id: 'confirmed', 
                    title: 'Order Confirmed', 
                    description: 'Your order has been confirmed',
                    icon: 'fas fa-check-circle',
                    completed: order.status !== 'Pending'
                },
                { 
                    id: 'preparing', 
                    title: 'Preparing', 
                    description: 'Our chefs are preparing your food',
                    icon: 'fas fa-utensils',
                    completed: order.status === 'Preparing' || order.status === 'Out for Delivery' || order.status === 'Delivered'
                },
                { 
                    id: 'out-for-delivery', 
                    title: 'Out for Delivery', 
                    description: 'Your order is on the way',
                    icon: 'fas fa-motorcycle',
                    completed: order.status === 'Out for Delivery' || order.status === 'Delivered'
                },
                { 
                    id: 'delivered', 
                    title: 'Delivered', 
                    description: 'Your order has been delivered',
                    icon: 'fas fa-home',
                    completed: order.status === 'Delivered'
                }
            ];

            trackingResult.innerHTML = `
                <div class="tracking-card">
                    <div class="tracking-header">
                        <div class="tracking-id">Order #${order.id}</div>
                        <div class="tracking-status">Status: ${order.status}</div>
                    </div>
                    <div class="tracking-timeline">
                        ${steps.map(step => `
                            <div class="tracking-step ${step.completed ? 'completed' : ''}">
                                <div class="step-icon">
                                    <i class="${step.icon}"></i>
                                </div>
                                <div class="step-details">
                                    <div class="step-title">${step.title}</div>
                                    <div class="step-description">${step.description}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Render pizzas (uses admin-managed `menuItems`) based on filter and search
        function renderPizzas(filter, search) {
            pizzaGrid.innerHTML = '';
            search = (search || '').toLowerCase();

            // Use menuItems as the source of truth for what to display to customers
            const source = Array.isArray(menuItems) ? menuItems : [];

            const filtered = source.filter(item => {
                const matchesFilter = !filter || filter === 'all' || (item.category && item.category === filter);
                const matchesSearch = !search || (item.name && item.name.toLowerCase().includes(search));
                return matchesFilter && matchesSearch;
            });

            filtered.forEach(item => {
                const pizzaCard = document.createElement('div');
                pizzaCard.className = 'pizza-card';
                pizzaCard.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="pizza-image">
                    <div class="pizza-details">
                        <h3>${item.name}</h3>
                        <p>${item.price.toFixed ? item.price.toFixed(2) : item.price}</p>
                        <button class="add-to-cart-btn" data-id="${item.id}">Add to Cart</button>
                    </div>
                `;
                pizzaGrid.appendChild(pizzaCard);
            });

            // Animate pizza cards
            animateList(pizzaGrid);

            // Add event listeners to Add to Cart buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                // remove existing listeners by cloning the node to avoid duplicate handlers
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', function() {
                    const pizzaId = parseInt(this.getAttribute('data-id'));
                    addToCart(pizzaId);
                });
            });
        }

        // Filter and search change events
        pizzaFilter.addEventListener('change', function() {
            renderPizzas(this.value, pizzaSearch.value);
        });

        pizzaSearch.addEventListener('input', function() {
            renderPizzas(pizzaFilter.value, this.value);
        });

        // Render staff orders (improved layout + stats)
        function renderStaffOrders() {
            // Get updated orders from localStorage
            orders = JSON.parse(localStorage.getItem('orders')) || [];

            staffOrderList.innerHTML = '';

            if (orders.length === 0) {
                staffOrderList.innerHTML = '<p>No orders to manage.</p>';
                // update stats to zero
                updateStaffStats([]);
                return;
            }

            // Compute and render stats (overall)
            updateStaffStats(orders);

            // Apply UI filters/search (if any)
            let filteredOrders = Array.isArray(orders) ? orders.slice() : [];
            if (typeof staffSearchText === 'string' && staffSearchText.trim().length) {
                const q = staffSearchText.trim().toLowerCase();
                filteredOrders = filteredOrders.filter(o => {
                    const inText = [o.id, o.username || '', (o.address && o.address.fullName) || '', o.items.map(i=>i.name).join(' ')].join(' ').toLowerCase();
                    return inText.includes(q);
                });
            }
            if (typeof staffActiveFilter === 'string' && staffActiveFilter !== 'all') {
                const f = staffActiveFilter.toLowerCase();
                filteredOrders = filteredOrders.filter(o => (o.status || '').toLowerCase().includes(f));
            }

            // Sort orders by date (newest first)
            const sortedOrders = [...filteredOrders].sort((a, b) => new Date(b.date) - new Date(a.date));

            const currentIds = [];
            sortedOrders.forEach(order => {
                const item = document.createElement('div');
                item.className = 'order-item';
                // tag element with order id so we can selectively animate later
                if (order.id != null) item.dataset.orderId = String(order.id);
                currentIds.push(String(order.id));

                // Build items list string
                const itemsText = order.items.map(i => `${i.name} x ${i.quantity}`).join(', ');

                // Status badge class mapping
                let badgeClass = 'badge-pending';
                const st = (order.status || '').toLowerCase();
                if (st.includes('prepar')) badgeClass = 'badge-preparing';
                else if (st.includes('out')) badgeClass = 'badge-out';
                else if (st.includes('deliver')) badgeClass = 'badge-delivered';

                // Create inner markup matching new styles
                item.innerHTML = `
                    <div class="order-left">
                        <div class="order-avatar">${(order.address && order.address.fullName) ? order.address.fullName.split(' ').map(n=>n[0]).slice(0,2).join('') : 'CU'}</div>
                        <div class="order-body">
                            <h4 class="order-title">${order.username || 'Order'}</h4>
                            <div class="order-id">Order ${order.id}</div>
                            <div class="order-meta">
                                <div class="order-date">${new Date(order.date).toLocaleString()}</div>
                                <div></div>
                                <div class="order-contact">Phone: ${order.address && order.address.phoneNumber ? order.address.phoneNumber : ''}</div>
                            </div>

                            ${order.address ? `
                            <div class="order-address" style="margin-top:8px;font-size:13px;color:#444;">
                                <div style="font-weight:600">${order.address.fullName || (order.username||'')}</div>
                                <div style="margin-top:4px;">${order.address.streetAddress || ''}${order.address.barangay ? ', ' + order.address.barangay : ''}</div>
                                <div>${order.address.city || ''}${order.address.province ? ', ' + order.address.province : ''}${order.address.zipCode ? ' ' + order.address.zipCode : ''}</div>
                                ${order.address.deliveryInstructions ? `<div style="margin-top:6px;color:#666;">Instructions: ${order.address.deliveryInstructions}</div>` : ''}
                            </div>
                            ` : ''}

                            <div class="items-list">${itemsText}</div>
                            <div class="order-total-amount">Total: ${(order.total || 0).toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="order-right">
                        <div class="status-badge ${badgeClass}">${order.status}</div>
                        <div class="order-actions">
                            <select id="status-${order.id}">
                                <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Order Confirmed" ${order.status === 'Order Confirmed' ? 'selected' : ''}>Order Confirmed</option>
                                <option value="Preparing" ${order.status === 'Preparing' ? 'selected' : ''}>Preparing</option>
                                <option value="Out for Delivery" ${order.status === 'Out for Delivery' ? 'selected' : ''}>Out for Delivery</option>
                                <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                            <button class="update-btn" onclick="updateOrderStatus('${order.id}')">Update</button>
                        </div>
                    </div>
                `;

                staffOrderList.appendChild(item);
            });

            // compute which IDs are new (only animate those)
            const newIds = [];
            if (lastRenderedOrderIds && lastRenderedOrderIds.size > 0) {
                currentIds.forEach(id => { if (!lastRenderedOrderIds.has(id)) newIds.push(id); });
            }

            if (newIds.length > 0) {
                animateList(staffOrderList, new Set(newIds));
            } else {
                // if this is the very first render (no lastRendered), animate all
                if (!lastRenderedOrderIds || lastRenderedOrderIds.size === 0) animateList(staffOrderList);
            }

            // update lastRenderedOrderIds for next render
            lastRenderedOrderIds = new Set(currentIds);
        }

        // Update the small stats shown at the top of the staff dashboard
        function updateStaffStats(allOrders) {
            const list = Array.isArray(allOrders) ? allOrders : (JSON.parse(localStorage.getItem('orders')) || []);
            const total = list.length;
            const pending = list.filter(o => (o.status || '').toLowerCase().includes('pend')).length;
            const preparing = list.filter(o => (o.status || '').toLowerCase().includes('prepar')).length;
            const outFor = list.filter(o => (o.status || '').toLowerCase().includes('out')).length;

            const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            setEl('statTotal', total);
            setEl('statPending', pending);
            setEl('statPreparing', preparing);
            setEl('statOut', outFor);
        }

        // Staff search & filter state and bindings
        let staffSearchText = '';
        let staffActiveFilter = 'all';

        // Bind search and filters after DOM is ready (elements exist)
        document.addEventListener('DOMContentLoaded', function() {
            const staffSearchEl = document.getElementById('staffSearch');
            const clearSearchBtn = document.getElementById('clearSearch');
            const filterBtns = document.querySelectorAll('.staff-filters .filter-btn');

            if (staffSearchEl) {
                staffSearchEl.addEventListener('input', function(e) {
                    staffSearchText = (e.target.value || '').toLowerCase();
                    renderStaffOrders();
                });
            }

            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    if (staffSearchEl) staffSearchEl.value = '';
                    staffSearchText = '';
                    renderStaffOrders();
                });
            }

            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    staffActiveFilter = this.dataset.filter || 'all';
                    renderStaffOrders();
                });
            });
        });

        // Update Order Status (for staff)
        function updateOrderStatus(orderId) {
            // Guard: ensure the select exists
            const selEl = document.getElementById(`status-${orderId}`);
            if (!selEl) { showToast('Status control not found for order ' + orderId); return; }
            const newStatus = selEl.value;

            showConfirm(`Are you sure you want to update order ${orderId} status to "${newStatus}"?`, function() {
                // Rehydrate orders from storage to avoid operating on a stale in-memory copy
                try { orders = JSON.parse(localStorage.getItem('orders')) || []; } catch (e) { orders = orders || []; }

                // Compare IDs as strings to avoid type mismatches
                const orderIndex = orders.findIndex(o => String(o.id) === String(orderId));
                    if (orderIndex !== -1) {
                    const prevStatus = orders[orderIndex].status;
                    orders[orderIndex].status = newStatus;
                    try { localStorage.setItem('orders', JSON.stringify(orders)); } catch(e) { console.error('Failed saving orders', e); }
                    showToast('Order status updated successfully!');

                    // Update only the affected order DOM to avoid a full re-render/flash
                    try {
                        const orderEl = document.querySelector(`.order-item[data-order-id="${orderId}"]`);
                        if (orderEl) {
                            const badge = orderEl.querySelector('.status-badge');
                            if (badge) {
                                badge.textContent = newStatus;
                                badge.classList.remove('badge-pending','badge-preparing','badge-out','badge-delivered');
                                const s = (newStatus || '').toLowerCase();
                                if (s.includes('prepar')) badge.classList.add('badge-preparing');
                                else if (s.includes('out')) badge.classList.add('badge-out');
                                else if (s.includes('deliver')) badge.classList.add('badge-delivered');
                                else badge.classList.add('badge-pending');
                            }
                            // ensure the select reflects the saved value
                            const sel = orderEl.querySelector(`#status-${orderId}`);
                            if (sel) sel.value = newStatus;
                        }
                    } catch (e) { console.error('Failed updating order DOM', e); }

                    // Update small overview stats and charts without re-rendering the whole list
                    try { updateStaffStats(orders); } catch(e) { console.error('updateStaffStats failed', e); }
                    try { renderStatusPieChart(); } catch(e) { console.error('renderStatusPieChart failed', e); }
                    try { renderStaffAnalytics(); } catch(e) { /* keep silent if not visible */ }
                    try { window._staffOrdersSnapshot = JSON.stringify(orders.map(o=>({id:o.id, status:o.status, date:o.date}))); } catch(e) {}
                    // If the order was just marked Delivered, record revenue once
                    try {
                        const sLower = (newStatus || '').toLowerCase();
                        if (sLower.includes('deliver')) {
                            // Only add revenue if it hasn't been recorded for this order yet
                            if (!orders[orderIndex].revenueRecorded) {
                                const amt = Number(orders[orderIndex].total) || 0;
                                if (amt > 0) {
                                    addRevenue(amt);
                                    // mark as recorded to avoid double-counting
                                    orders[orderIndex].revenueRecorded = true;
                                    try { localStorage.setItem('orders', JSON.stringify(orders)); } catch(e) { console.error('Failed to persist revenueRecorded flag', e); }
                                    try { renderRevenueDisplay(); } catch(e) {}
                                    try { syncOverviewStats(); } catch(e) {}
                                }
                            }
                        }
                    } catch (e) { console.error('Failed recording revenue on delivery', e); }
                } else {
                    showToast('Order not found.');
                }
            });
        }

        // Admin Dashboard Functions
        function renderAdminMenuItems() {
            adminMenuTable.innerHTML = '';
            
            menuItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.description}</td>
                    <td>
                        <select onchange="updateMenuItemCategory(${index}, this.value)">
                            <option value="">--</option>
                            <option value="vegetarian" ${item.category === 'vegetarian' ? 'selected' : ''}>Vegetarian</option>
                            <option value="non-vegetarian" ${item.category === 'non-vegetarian' ? 'selected' : ''}>Non-Vegetarian</option>
                            <option value="cheese" ${item.category === 'cheese' ? 'selected' : ''}>Cheese</option>
                            <option value="other" ${item.category === 'other' ? 'selected' : ''}>Other</option>
                        </select>
                    </td>
                    <td>${item.price.toFixed(2)}</td>
                    <td><img src="${item.image}" alt="${item.name}" style="max-width:60px; height:auto;" /></td>
                    <td>
                        <button class="admin-btn" onclick="editMenuItem(${index})">Edit</button>
                        <button class="admin-btn delete" onclick="deleteMenuItem(${index})">Delete</button>
                    </td>
                `;
                adminMenuTable.appendChild(row);
            });

            // Animate admin table rows
            animateList(adminMenuTable);
        }

        // Update category for a menu item and persist
        function updateMenuItemCategory(index, category) {
            if (typeof index === 'undefined' || index === null) return;
            menuItems[index].category = category;
            localStorage.setItem('menuItems', JSON.stringify(menuItems));
            // Update customer view if needed
            if (activeUser && activeUser.role === 'Customer') renderMenu();
        }

        // Helper to animate children of a container with a small stagger
        // If idsToAnimate (Set) is provided, only animate children whose data-order-id is in the set.
        function animateList(container, idsToAnimate) {
            if (!container) return;
            // If animations are temporarily suppressed for this container, skip applying entrance animations
            try {
                if (container.dataset && container.dataset.disableAnimate === '1') return;
            } catch (e) {}
            // For staff order list we disable entrance animations to avoid popping during interactions
            try { if (container.id === 'staffOrderList') return; } catch(e) {}
            const children = Array.from(container.children || []);
            children.forEach((el, i) => {
                // Skip entrance animation for order cards / order items to avoid pop effect
                try {
                    if (el.classList && (el.classList.contains('order-card') || el.classList.contains('order-item'))) return;
                } catch (e) {}
                const orderId = el.dataset && el.dataset.orderId;
                // If idsToAnimate is provided, skip elements not in it
                if (idsToAnimate && idsToAnimate.size > 0) {
                    if (!orderId || !idsToAnimate.has(orderId)) return;
                }
                // set initial state
                el.style.opacity = 0;
                el.style.transform = 'translateY(8px) scale(0.995)';
                // ensure any previous animation is cleared
                el.classList.remove('enter');
                // stagger via inline animation delay
                el.style.animationDelay = (i * 70) + 'ms';
                // force reflow to ensure animation will run
                void el.offsetWidth;
                el.classList.add('enter');
            });
        }

        // Open admin modal for adding or editing an item
        function openAdminItemModal(index = null) {
            // Reset inline errors
            [aiNameError, aiDescriptionError, aiPriceError, aiCategoryError, aiImageError].forEach(el => el.style.display = 'none');
            adminEditingIndex = (typeof index === 'number') ? index : null;
            if (adminEditingIndex === null) {
                adminItemModalTitle.textContent = 'Add Menu Item';
                aiName.value = '';
                aiDescription.value = '';
                aiPrice.value = '';
                aiCategory.value = '';
                aiImage.value = '';
                if (aiImagePreview) { aiImagePreview.src = ''; aiImagePreview.style.display = 'none'; }
                if (aiImageFile) { aiImageFile.value = ''; }
            } else {
                const item = menuItems[adminEditingIndex];
                adminItemModalTitle.textContent = 'Edit Menu Item';
                aiName.value = item.name || '';
                aiDescription.value = item.description || '';
                aiPrice.value = item.price != null ? item.price : '';
                aiCategory.value = item.category || '';
                aiImage.value = item.image || '';
                // show preview if image value is present
                if (aiImagePreview) {
                    if (aiImage.value) {
                        aiImagePreview.src = aiImage.value;
                        aiImagePreview.style.display = 'inline-block';
                    } else {
                        aiImagePreview.src = '';
                        aiImagePreview.style.display = 'none';
                    }
                }
                if (aiImageFile) { aiImageFile.value = ''; }
            }
            adminItemModal.classList.add('active');
            // small delay to focus input after modal animation
            setTimeout(() => aiName.focus(), 120);

            // (file input listener is attached once at initialization)
        }

        function closeAdminItemModalFn() {
            adminItemModal.classList.remove('active');
            adminEditingIndex = null;
            if (aiImagePreview) { aiImagePreview.src = ''; aiImagePreview.style.display = 'none'; }
        }

        function saveAdminItem() {
            // Reset errors
            [aiNameError, aiDescriptionError, aiPriceError, aiCategoryError, aiImageError].forEach(el => el.style.display = 'none');

            const name = aiName.value.trim();
            const description = aiDescription.value.trim();
            const price = parseFloat(aiPrice.value);
            const category = aiCategory.value;
            const image = aiImage.value.trim();

            let valid = true;
            if (!name) { aiNameError.style.display = 'block'; valid = false; }
            if (!description) { aiDescriptionError.style.display = 'block'; valid = false; }
            if (isNaN(price) || price <= 0) { aiPriceError.style.display = 'block'; valid = false; }
            if (!category) { aiCategoryError.style.display = 'block'; valid = false; }
            if (!image) { aiImageError.style.display = 'block'; valid = false; }
            if (!valid) return;

            if (adminEditingIndex === null) {
                const newId = menuItems.length > 0 ? Math.max(...menuItems.map(item => item.id)) + 1 : 1;
                menuItems.push({ id: newId, name, description, price, image, category });
            } else {
                const item = menuItems[adminEditingIndex];
                menuItems[adminEditingIndex] = { id: item.id, name, description, price, image, category };
            }

            localStorage.setItem('menuItems', JSON.stringify(menuItems));
            renderAdminMenuItems();
            if (activeUser && activeUser.role === 'Customer') renderMenu();
            closeAdminItemModalFn();
        }

        // Updated add/edit functions to open modal
        function addMenuItem() { openAdminItemModal(null); }
        function editMenuItem(index) { openAdminItemModal(index); }

        function deleteMenuItem(index) {
            showConfirm('Are you sure you want to delete this item?', function() {
                try {
                    // Backup full menu items before deletion
                    try {
                        const backupKey = 'menuItems_backup_' + Date.now();
                        localStorage.setItem(backupKey, JSON.stringify(menuItems));
                        console.log('Menu items backed up to', backupKey);
                    } catch (e) { console.error('Failed to backup menu items', e); }

                    // Also back up the single deleted item for easy restore
                    let singleBackupKey = null;
                    try {
                        const item = menuItems[index];
                        if (item) {
                            singleBackupKey = 'menuItem_deleted_' + (item.id != null ? item.id : 'unknown') + '_' + Date.now();
                            localStorage.setItem(singleBackupKey, JSON.stringify(item));
                            console.log('Menu item backed up to', singleBackupKey);
                        }
                    } catch (e) { console.error('Failed to backup deleted menu item', e); }

                    menuItems.splice(index, 1);
                    localStorage.setItem('menuItems', JSON.stringify(menuItems));
                    renderAdminMenuItems();
                    // Also update the customer menu if they're logged in
                    if (activeUser && activeUser.role === 'Customer') {
                        renderMenu();
                    }
                    // Show toast including the single-item backup key if available
                    if (singleBackupKey) {
                        showToast('Menu item deleted (backup: ' + singleBackupKey + ')');
                    } else {
                        showToast('Menu item deleted (backup created)');
                    }
                } catch (e) {
                    console.error('Failed deleting menu item', e);
                    showToast('Failed to delete menu item');
                }
            });
        }

        // Toggle display of a user's password in the admin users table (shows/hides plaintext)
        function togglePassword(username, btn) {
            try {
                const safeId = 'pwd_' + (username || '').replace(/[^a-zA-Z0-9_-]/g, '_');
                const span = document.getElementById(safeId);
                if (!span) { showToast('Password element not found'); return; }
                // If currently shown, hide it
                if (span.dataset && span.dataset.shown === '1') {
                    span.textContent = '';
                    span.dataset.shown = '0';
                    if (btn) btn.textContent = 'Show';
                } else {
                    // retrieve the user's current password from storage
                    const users = JSON.parse(localStorage.getItem('users')) || [];
                    const user = users.find(u => u.username === username);
                    const pwd = user ? (user.password || '') : '';
                    span.textContent = pwd ? pwd : '(no password)';
                    span.dataset.shown = '1';
                    if (btn) btn.textContent = 'Hide';
                }
            } catch (e) { console.error('togglePassword failed', e); showToast('Unable to toggle password'); }
        }

        function renderAdminUsers() {
            adminUserTable.innerHTML = '';

            // Read users from localStorage if present; otherwise fall back to demo users
            const storedUsers = JSON.parse(localStorage.getItem('users')) || [
                { username: 'admin', role: 'Admin' },
                { username: 'staff1', role: 'Staff' },
                { username: 'customer1', role: 'Customer' },
                { username: 'customer2', role: 'Customer' }
            ];

            storedUsers.forEach((user, index) => {
                const row = document.createElement('tr');

                // Username
                const tdUsername = document.createElement('td');
                tdUsername.textContent = user.username;

                // Email
                const tdEmail = document.createElement('td');
                tdEmail.textContent = user.email || '';

                // Password (masked) with toggle button
                const tdPassword = document.createElement('td');
                const safeId = 'pwd_' + (user.username || '').replace(/[^a-zA-Z0-9_-]/g, '_');
                const span = document.createElement('span');
                span.id = safeId;
                span.textContent = '';
                tdPassword.appendChild(span);
                const showBtn = document.createElement('button');
                showBtn.className = 'admin-btn';
                showBtn.style.marginLeft = '8px';
                showBtn.style.padding = '6px 8px';
                showBtn.style.fontSize = '12px';
                showBtn.textContent = 'Show';
                showBtn.addEventListener('click', function() { togglePassword(user.username, this); });
                tdPassword.appendChild(showBtn);

                // Role
                const tdRole = document.createElement('td');
                tdRole.textContent = user.role;

                // Actions (Edit / Delete)
                const tdActions = document.createElement('td');
                const editBtn = document.createElement('button');
                editBtn.className = 'admin-btn';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', function() { openEditUserModal(user.username); });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'admin-btn delete';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', function() { deleteUser(user.username); });

                tdActions.appendChild(editBtn);
                tdActions.appendChild(deleteBtn);

                row.appendChild(tdUsername);
                row.appendChild(tdEmail);
                row.appendChild(tdPassword);
                row.appendChild(tdRole);
                row.appendChild(tdActions);

                adminUserTable.appendChild(row);
            });
        }

        function deleteUser(username) {
            if (!username) return;
            showConfirm(`Are you sure you want to delete user "${username}"?`, function() {
                try {
                    // Read current users
                    const users = JSON.parse(localStorage.getItem('users')) || [];
                    const user = users.find(u => u.username === username);

                    // Backup full users list
                    try {
                        const usersBackupKey = 'users_backup_' + Date.now();
                        localStorage.setItem(usersBackupKey, JSON.stringify(users));
                        console.log('Users backed up to', usersBackupKey);
                    } catch (e) { console.error('Failed to backup users list', e); }

                    // Backup single user object
                    if (user) {
                        try {
                            const singleBackupKey = 'user_deleted_' + username + '_' + Date.now();
                            localStorage.setItem(singleBackupKey, JSON.stringify(user));
                            console.log('User backed up to', singleBackupKey);
                        } catch (e) { console.error('Failed to backup single user', e); }

                        // Backup user's orders if any
                        try {
                            const orders = JSON.parse(localStorage.getItem('orders')) || [];
                            const userOrders = orders.filter(o => o.username === username);
                            if (userOrders.length) {
                                const ordersBackupKey = 'orders_backup_user_' + username + '_' + Date.now();
                                localStorage.setItem(ordersBackupKey, JSON.stringify(userOrders));
                                console.log('User orders backed up to', ordersBackupKey);
                            }
                        } catch (e) { console.error('Failed to backup user orders', e); }
                    }

                    // Remove the user
                    const newUsers = users.filter(u => u.username !== username);
                    localStorage.setItem('users', JSON.stringify(newUsers));

                    showToast('User deleted (backup created)');
                    if (typeof renderAdminUsers === 'function') renderAdminUsers();
                } catch (err) {
                    console.error('Failed to delete user', err);
                    showToast('Failed to delete user');
                }
            });
        }

        // Edit user support
        let _editingUsername = null;
        const editUserModal = document.getElementById('editUserModal');
        const editUsernameEl = document.getElementById('editUsername');
        const editEmailEl = document.getElementById('editEmail');
        const editRoleEl = document.getElementById('editRole');
        const editPasswordEl = document.getElementById('editPassword');
        const editUserSaveBtn = document.getElementById('editUserSaveBtn');
        const editUserCancelBtn = document.getElementById('editUserCancelBtn');
        const editUsernameError = document.getElementById('editUsernameError');
        const editEmailError = document.getElementById('editEmailError');

        function openEditUserModal(username) {
            try {
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const user = users.find(u => u.username === username);
                if (!user) { showToast('User not found'); return; }
                _editingUsername = username;
                // Prefill
                editUsernameEl.value = user.username || '';
                editEmailEl.value = user.email || '';
                editRoleEl.value = user.role || 'Customer';
                editPasswordEl.value = '';
                // hide errors
                editUsernameError.style.display = 'none';
                editEmailError.style.display = 'none';
                // show modal
                editUserModal.style.display = 'flex';
            } catch (e) {
                console.error('Failed to open edit modal', e);
                showToast('Unable to open edit form');
            }
        }

        function closeEditUserModal() {
            _editingUsername = null;
            if (editUserModal) editUserModal.style.display = 'none';
        }

        // Save edited user
        if (editUserSaveBtn) {
            editUserSaveBtn.addEventListener('click', function() {
                const newUsername = (editUsernameEl.value || '').trim();
                const newEmail = (editEmailEl.value || '').trim().toLowerCase();
                const newRole = (editRoleEl.value || 'Customer');
                const newPassword = (editPasswordEl.value || '');

                // Basic validation
                let valid = true;
                editUsernameError.style.display = 'none';
                editEmailError.style.display = 'none';

                if (!newUsername || newUsername.length < 2) {
                    editUsernameError.textContent = 'Username is required and must be at least 2 characters.';
                    editUsernameError.style.display = 'block';
                    valid = false;
                }
                if (newEmail && !/^\S+@\S+\.\S+$/.test(newEmail)) {
                    editEmailError.textContent = 'Please enter a valid email address.';
                    editEmailError.style.display = 'block';
                    valid = false;
                }
                if (!valid) return;

                const users = JSON.parse(localStorage.getItem('users')) || [];
                // Check for username/email conflicts with other users
                const conflict = users.find(u => (u.username !== _editingUsername) && (u.username === newUsername || (u.email || '').toLowerCase() === newEmail));
                if (conflict) {
                    if (conflict.username === newUsername) {
                        editUsernameError.textContent = 'Username already exists.';
                        editUsernameError.style.display = 'block';
                    } else {
                        editEmailError.textContent = 'Email already in use.';
                        editEmailError.style.display = 'block';
                    }
                    return;
                }

                // Update user record
                const idx = users.findIndex(u => u.username === _editingUsername);
                if (idx === -1) { showToast('Original user not found'); closeEditUserModal(); return; }

                // Apply updates
                users[idx].username = newUsername;
                users[idx].email = newEmail || users[idx].email;
                users[idx].role = newRole;
                if (newPassword && newPassword.length >= 4) users[idx].password = newPassword;

                // Persist users
                localStorage.setItem('users', JSON.stringify(users));

                // If username changed, propagate to other stored references (orders, loginHistory, activeUser)
                try {
                    const oldUsername = _editingUsername;
                    if (oldUsername && oldUsername !== newUsername) {
                        // update orders
                        try {
                            const storedOrders = JSON.parse(localStorage.getItem('orders')) || [];
                            let changedOrders = false;
                            storedOrders.forEach(o => {
                                if (o && o.username === oldUsername) { o.username = newUsername; changedOrders = true; }
                            });
                            if (changedOrders) {
                                localStorage.setItem('orders', JSON.stringify(storedOrders));
                                // update in-memory orders too
                                try { orders = storedOrders; } catch(e) {}
                            }
                        } catch (e) { console.error('Failed propagating username to orders', e); }

                        // update login history entries
                        try {
                            const history = JSON.parse(localStorage.getItem('loginHistory')) || [];
                            let changedHistory = false;
                            history.forEach(h => {
                                if (h && h.username === oldUsername) { h.username = newUsername; changedHistory = true; }
                            });
                            if (changedHistory) localStorage.setItem('loginHistory', JSON.stringify(history));
                        } catch (e) { console.error('Failed propagating username to loginHistory', e); }

                        // update activeUser if it's the same user
                        try {
                            const act = JSON.parse(localStorage.getItem('activeUser')) || null;
                            if (act && act.username === oldUsername) {
                                act.username = newUsername;
                                localStorage.setItem('activeUser', JSON.stringify(act));
                                try { activeUser = act; } catch(e) {}
                            }
                        } catch (e) { console.error('Failed updating activeUser', e); }
                    }
                } catch (e) {
                    console.error('Error propagating username change', e);
                }

                showToast('User account updated');
                closeEditUserModal();
                renderAdminUsers();
            });
        }

        if (editUserCancelBtn) {
            editUserCancelBtn.addEventListener('click', function() { closeEditUserModal(); });
        }

        // Close edit modal when clicking outside content
        if (editUserModal) {
            editUserModal.addEventListener('click', function(e) {
                if (e.target === editUserModal) closeEditUserModal();
            });
        }

        // Add user support (Add New User modal + handlers)
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserModal = document.getElementById('addUserModal');
        const addUsernameEl = document.getElementById('addUsername');
        const addEmailEl = document.getElementById('addEmail');
        const addRoleEl = document.getElementById('addRole');
        const addPasswordEl = document.getElementById('addPassword');
        const addUserSaveBtnEl = document.getElementById('addUserSaveBtn');
        const addUserCancelBtnEl = document.getElementById('addUserCancelBtn');
        const addUsernameErrorEl = document.getElementById('addUsernameError');
        const addEmailErrorEl = document.getElementById('addEmailError');
        const addPasswordErrorEl = document.getElementById('addPasswordError');

        function openAddUserModal() {
            try {
                if (!addUserModal) return;
                if (addUsernameEl) addUsernameEl.value = '';
                if (addEmailEl) addEmailEl.value = '';
                if (addPasswordEl) addPasswordEl.value = '';
                if (addRoleEl) addRoleEl.value = 'Customer';
                if (addUsernameErrorEl) addUsernameErrorEl.style.display = 'none';
                if (addEmailErrorEl) addEmailErrorEl.style.display = 'none';
                if (addPasswordErrorEl) addPasswordErrorEl.style.display = 'none';
                addUserModal.style.display = 'flex';
            } catch (e) { console.error('openAddUserModal failed', e); }
        }

        function closeAddUserModal() {
            try { if (addUserModal) addUserModal.style.display = 'none'; } catch (e) {}
        }

        if (addUserBtn) addUserBtn.addEventListener('click', openAddUserModal);
        if (addUserCancelBtnEl) addUserCancelBtnEl.addEventListener('click', closeAddUserModal);

        if (addUserSaveBtnEl) {
            addUserSaveBtnEl.addEventListener('click', function() {
                const username = (addUsernameEl && addUsernameEl.value || '').trim();
                const email = (addEmailEl && addEmailEl.value || '').trim().toLowerCase();
                const role = (addRoleEl && addRoleEl.value) || 'Customer';
                const password = (addPasswordEl && addPasswordEl.value) || '';

                // Reset errors
                if (addUsernameErrorEl) addUsernameErrorEl.style.display = 'none';
                if (addEmailErrorEl) addEmailErrorEl.style.display = 'none';
                if (addPasswordErrorEl) addPasswordErrorEl.style.display = 'none';

                let valid = true;
                if (!username || username.length < 2) {
                    if (addUsernameErrorEl) { addUsernameErrorEl.textContent = 'Username is required and must be at least 2 characters.'; addUsernameErrorEl.style.display = 'block'; }
                    valid = false;
                }
                if (email && !/^\S+@\S+\.\S+$/.test(email)) {
                    if (addEmailErrorEl) { addEmailErrorEl.textContent = 'Please enter a valid email address.'; addEmailErrorEl.style.display = 'block'; }
                    valid = false;
                }
                if (!password || password.length < 4) {
                    if (addPasswordErrorEl) { addPasswordErrorEl.textContent = 'Password must be at least 4 characters.'; addPasswordErrorEl.style.display = 'block'; }
                    valid = false;
                }
                if (!valid) return;

                try {
                    const users = JSON.parse(localStorage.getItem('users')) || [];
                    // check conflicts
                    const conflict = users.find(u => u.username === username || ((u.email || '').toLowerCase() === email && email));
                    if (conflict) {
                        if (conflict.username === username) {
                            if (addUsernameErrorEl) { addUsernameErrorEl.textContent = 'Username already exists.'; addUsernameErrorEl.style.display = 'block'; }
                        } else {
                            if (addEmailErrorEl) { addEmailErrorEl.textContent = 'Email already in use.'; addEmailErrorEl.style.display = 'block'; }
                        }
                        return;
                    }

                    const newUser = {
                        id: Date.now(),
                        username,
                        email: email || '',
                        password,
                        role,
                        createdAt: new Date().toISOString()
                    };

                    users.push(newUser);
                    localStorage.setItem('users', JSON.stringify(users));
                    showToast('User added successfully');
                    closeAddUserModal();
                    if (typeof renderAdminUsers === 'function') renderAdminUsers();
                } catch (e) {
                    console.error('Failed to add user', e);
                    showToast('Failed to add user');
                }
            });
        }

        // Close add user modal when clicking outside content
        if (addUserModal) {
            addUserModal.addEventListener('click', function(e) {
                if (e.target === addUserModal) closeAddUserModal();
            });
        }

        // Clear personal stored orders (customer action)  now includes backup
        function clearOrderHistory() {
            // Only allow customers to clear their own order history here.
            if (!activeUser || activeUser.role !== 'Customer') {
                showToast('Only customers can clear their personal order history.');
                return;
            }

            showConfirm('This will permanently delete your order history. Continue?', function() {
                try {
                    const existing = JSON.parse(localStorage.getItem('orders')) || [];
                    const removed = existing.filter(o => o.username === activeUser.username);
                    if (removed && removed.length > 0) {
                        const backupKey = 'orders_backup_user_' + (activeUser.username || 'unknown') + '_' + Date.now();
                        try { localStorage.setItem(backupKey, JSON.stringify(removed)); console.log('User orders backed up to', backupKey); } catch (e) { console.error('Failed to backup user orders', e); }
                    }

                    // Keep other users' orders
                    orders = existing.filter(o => o.username !== activeUser.username);
                    try { localStorage.setItem('orders', JSON.stringify(orders)); } catch (e) { console.error('Failed to save orders after clearing user history', e); }

                    // Update any visible order lists
                    try { renderOrders(); } catch (e) { /* ignore if not visible */ }
                    try { renderStaffOrders(); } catch (e) { /* ignore if not visible */ }

                    showToast('Your order history was cleared');
                } catch (e) {
                    console.error('Failed clearing personal order history', e);
                    showToast('Failed to clear your order history');
                }
            });
        }

        // Delete a specific order by ID (customer/admin action)
        function deleteOrder(orderId) {
            if (!orderId) return;
            // Ensure permission: customers can only delete their own orders
            const order = orders.find(o => o.id === orderId);
            if (!order) { showToast('Order not found'); return; }

            if (activeUser && activeUser.role === 'Customer' && order.username !== activeUser.username) {
                showToast('You can only delete your own orders.');
                return;
            }
            showConfirm(`Are you sure you want to delete order ${orderId}?`, function() {
                try {
                    const idx = orders.findIndex(o => o.id === orderId);
                    if (idx !== -1) {
                        // Backup the single order before removal
                        try {
                            const backupKey = 'orders_deleted_' + orderId + '_' + Date.now();
                            localStorage.setItem(backupKey, JSON.stringify(orders[idx]));
                            console.log('Order backed up to', backupKey);
                        } catch (e) { console.error('Failed to backup order before deletion', e); }

                        orders.splice(idx, 1);
                        try { localStorage.setItem('orders', JSON.stringify(orders)); } catch (e) { console.error('Failed to save orders after deletion', e); }
                        try { renderOrders(); } catch (e) { /* ignore */ }
                        try { renderStaffOrders(); } catch (e) { /* ignore */ }
                        showToast('Order deleted (backup created)');
                    } else {
                        showToast('Order not found');
                    }
                } catch (e) {
                    console.error('Failed deleting order', e);
                    showToast('Failed to delete order');
                }
            });
        }

        // Login and Sign Up functionality
        function showLoginPage() {
            landingPage.style.display = 'none';
            loginPage.style.display = 'flex';
            signupPage.style.display = 'none';
            // Clear any leftover social messages
            try { var sm = document.getElementById('socialMessage'); if(sm) sm.textContent = ''; } catch(e){}
            try { var ssm = document.getElementById('signupSocialMessage'); if(ssm) ssm.textContent = ''; } catch(e){}
        }

        function showSignUpPage() {
            landingPage.style.display = 'none';
            loginPage.style.display = 'none';
            signupPage.style.display = 'flex';
            // Clear any leftover social messages
            try { var sm = document.getElementById('socialMessage'); if(sm) sm.textContent = ''; } catch(e){}
            try { var ssm = document.getElementById('signupSocialMessage'); if(ssm) ssm.textContent = ''; } catch(e){}
        }

        function goToLandingPage() {
            landingPage.style.display = 'block';
            loginPage.style.display = 'none';
            signupPage.style.display = 'none';
            customerDashboard.style.display = 'none';
            staffDashboard.style.display = 'none';
            adminDashboard.style.display = 'none';
            // Clear any leftover social messages when returning to landing
            try { var sm = document.getElementById('socialMessage'); if(sm) sm.textContent = ''; } catch(e){}
            try { var ssm = document.getElementById('signupSocialMessage'); if(ssm) ssm.textContent = ''; } catch(e){}
        }

        // Logout function
        function logout() {
            showConfirm('Are you sure you want to log out?', function() {
                // clear staff refresh interval to stop background re-renders
                try { if (staffRefreshInterval) { clearInterval(staffRefreshInterval); staffRefreshInterval = null; } } catch(e) {}
                localStorage.removeItem('activeUser');
                // clear in-memory activeUser and switch to guest cart
                activeUser = null;
                try { loadCartForActiveUser(false); } catch(e) { console.error('Failed to load guest cart on logout', e); }
                showToast('You have logged out successfully.');
                goToLandingPage();
            });
        }

        // Add test data for orders if none exists
        if (orders.length === 0) {
            orders = [
                {
                    id: 'ORD1761220960555',
                    date: new Date().toISOString(),
                    items: [
                        { name: 'BBQ Chicken Pizza', quantity: 1, price: 379 }
                    ],
                    total: 379,
                    status: 'Pending',
                    paymentMethod: 'Cash on Delivery',
                    trackingNumber: 'TRK960555',
                    username: 'customer1',
                    address: {
                        fullName: 'Christian A. Agena',
                        phoneNumber: '09763424924',
                        streetAddress: 'Malimatoc 2 Mabini Batangas',
                        barangay: 'Malimatoc2',
                        city: 'Mabini',
                        province: 'Batangas',
                        zipCode: '4202',
                        deliveryInstructions: ''
                    }
                },
                {
                    id: 'ORD12345',
                    date: new Date().toISOString(),
                    items: [
                        { name: 'Margherita Pizza', quantity: 2, price: 299 },
                        { name: 'Pepperoni Pizza', quantity: 1, price: 349 }
                    ],
                    total: 947,
                    status: 'Pending',
                    paymentMethod: 'Cash on Delivery',
                    trackingNumber: 'TRK12345',
                    username: 'customer2',
                    address: {
                        fullName: 'John Doe',
                        phoneNumber: '09123456789',
                        streetAddress: '123 Main St',
                        barangay: 'Barangay Uno',
                        city: 'Metro City',
                        province: 'Metro Province',
                        zipCode: '1234',
                        deliveryInstructions: 'Leave at the front door.'
                    }
                }
            ];
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        // Initialize menu items in localStorage if not present
        if (!localStorage.getItem('menuItems')) {
            localStorage.setItem('menuItems', JSON.stringify(menuItems));
        }

        // Call render functions based on current user role
        if (activeUser) {
            if (activeUser.role === 'Customer') {
                renderOrders();
            } else if (activeUser.role === 'Admin') {
                renderAdminMenuItems();
                renderAdminUsers();
            }
        }

        // Dev helper: ensure a default admin account exists for local testing
        (function ensureDevAdmin() {
            try {
                const adminEmail = 'admin@gmail.com.com';
                const adminPassword = 'admin123';
                const adminUsername = 'admin';
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const existing = users.find(u => ((u.email || '').toLowerCase() === adminEmail.toLowerCase()) || (u.username === adminUsername));
                if (!existing) {
                    users.push({
                        id: Date.now(),
                        username: adminUsername,
                        email: adminEmail,
                        password: adminPassword,
                        role: 'Admin',
                        createdAt: new Date().toISOString()
                    });
                    localStorage.setItem('users', JSON.stringify(users));
                    console.log('Dev admin account created:', adminEmail);
                } else {
                    console.log('Dev admin account already present');
                }
            } catch (e) {
                console.error('Failed to ensure dev admin account', e);
            }
        })();

        // Dashboard overlay toggle: provide a subtle, non-interactive translucent overlay
        // This helps readability on busy background images without blocking interactions.
        (function dashboardOverlayToggle() {
            try {
                // Helper to wire a toggle button to a specific dashboard element
                function wireToggle(buttonId, dashboardId, storageKey) {
                    const dash = document.getElementById(dashboardId);
                    const btn = document.getElementById(buttonId);
                    if (!dash || !btn) return;

                    // Initialize from saved preference (per-dashboard key)
                    const saved = localStorage.getItem(storageKey) === '1';
                    if (saved) {
                        dash.classList.add('overlay-on');
                        btn.classList.add('active');
                        btn.setAttribute('aria-pressed', 'true');
                    }

                    btn.addEventListener('click', function() {
                        const on = dash.classList.toggle('overlay-on');
                        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
                        if (on) btn.classList.add('active'); else btn.classList.remove('active');
                        try { localStorage.setItem(storageKey, on ? '1' : '0'); } catch (e) { /* ignore */ }
                    });
                }

                // Wire only the customer dashboard overlay toggle; staff overlay is disabled
                wireToggle('toggleOverlayBtn', 'customerDashboard', 'dashboardOverlay_customer');
            } catch (e) { console.error('Overlay toggle init failed', e); }
        })();
    </script>

    <!-- Leaflet JS + interactive geocode/marker script -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        (function(){
            let map, markerLayer;

            function initMap() {
                // Default view: Mabini area
                map = L.map('map', { zoomControl: true }).setView([13.7, 120.93], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                markerLayer = L.layerGroup().addTo(map);
            }

            function clearMarkers() {
                markerLayer.clearLayers();
            }

            function addMarker(lat, lon, popup) {
                clearMarkers();
                const m = L.marker([lat, lon]).addTo(markerLayer);
                if (popup) m.bindPopup(popup).openPopup();
                return m;
            }

            function normalizePopupText(text) {
                if (!text) return text;
                const t = String(text).toLowerCase();
                // If the returned display name refers to Malimatoc (II / 2) in Mabini, map it to 'pizzalicious'
                if (t.includes('malimatoc') && t.includes('mabini')) return 'pizzalicious';
                // Also map the full specific string if present
                if (t.includes('calabarzon') && t.includes('4202') && t.includes('malimatoc')) return 'pizzalicious';
                return text;
            }

            function geocode(query) {
                const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(query) + '&limit=5&addressdetails=1';
                return fetch(url, { headers: { 'Accept': 'application/json' } }).then(r => r.json());
            }

            function tryLocateInitial() {
                const initial = 'Malimatoc 2, Mabini, Batangas, Philippines';
                geocode(initial).then(results => {
                    if (results && results.length > 0) {
                        const loc = results[0];
                        const lat = parseFloat(loc.lat), lon = parseFloat(loc.lon);
                        map.setView([lat, lon], 16);
                        addMarker(lat, lon, normalizePopupText(loc.display_name || initial));
                    } else {
                        // keep default view
                        console.warn('Initial geocode returned no result for', initial);
                    }
                }).catch(err => console.warn('Geocode error', err));
            }

            document.addEventListener('DOMContentLoaded', function(){
                try { initMap(); } catch(e) { console.error('Failed initializing map', e); return; }

                // Run initial locate for Malimatoc 2
                tryLocateInitial();

                // Pin the exact location from the provided Google Maps link and label it 'pizzalicious'
                // Coordinates extracted from the URL: 13.7051653, 120.9101738
                try {
                    const providedLat = 13.7051653;
                    const providedLon = 120.9101738;
                    map.setView([providedLat, providedLon], 17);
                    addMarker(providedLat, providedLon, 'pizzalicious');
                    // Pre-fill the URL input with the link for user reference
                    try { document.getElementById('mapUrl').value = 'https://www.google.com/maps/place/Malimatoc+II,+Mabini,+Batangas/@13.7082925,120.9060815,15.52z/data=!4m15!1m8!3m7!1s0x33bd00b2253d113b:0x4f50d0c407f4242f!2sMalimatoc+II,+Mabini,+Batangas!3b1!8m2!3d13.7051653!4d120.9101738!16s%2Fg%2F11fyxfm5r8!3m5!1s0x33bd00b2253d113b:0x4f50d0c407f4242f!8m2!3d13.7051653!4d120.9101738!16s%2Fg%2F11fyxfm5r8?entry=ttu&g_ep=EgoyMDI1MTAyMi4wIKXMDSoASAFQAw%3D%3D'; } catch(e){}
                } catch (e) { console.warn('Failed to pin provided location', e); }

                const input = document.getElementById('mapSearch');
                const btn = document.getElementById('mapSearchBtn');

                function doSearch() {
                    const q = input.value.trim();
                    if (!q) return;
                    geocode(q).then(results => {
                        if (results && results.length > 0) {
                            const loc = results[0];
                            const lat = parseFloat(loc.lat), lon = parseFloat(loc.lon);
                            map.setView([lat, lon], 16);
                            addMarker(lat, lon, normalizePopupText(loc.display_name || q));
                        } else {
                            alert('No results found for "' + q + '". Try a nearby landmark or full address.');
                        }
                    }).catch(err => {
                        console.error('Geocode failed', err);
                        alert('Geocoding failed. Check your network connection.');
                    });
                }

                btn.addEventListener('click', doSearch);
                input.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); doSearch(); } });
            });
        })();
    </script>
    <script>
    // Align staff sidebar to the Manage Orders heading so they are visually level.
    (function alignStaffSidebar(){
        function update() {
            try {
                const sidebar = document.querySelector('#staffDashboard .staff-sidebar');
                const heading = document.querySelector('#staffDashboard .staff-orders h2');
                if (!sidebar || !heading) return;
                // heading.getBoundingClientRect().top is distance from viewport top to heading
                // Use a small negative offset so the sidebar appears slightly higher than the heading
                const desiredTop = Math.max(8, Math.round(heading.getBoundingClientRect().top - 6));
                sidebar.style.top = desiredTop + 'px';
                // Ensure sidebar uses sticky positioning (in case CSS was changed)
                if (getComputedStyle(sidebar).position !== 'sticky') sidebar.style.position = 'sticky';
            } catch (e) { /* fail silently */ }
        }

        // Update on load and resize and when navigating views
        window.addEventListener('load', function(){ setTimeout(update, 120); });
        window.addEventListener('resize', function(){ setTimeout(update, 80); });
        // Also observe DOM changes inside staff container and re-align when Manage Orders appears
        const container = document.querySelector('#staffDashboard .staff-container');
        if (container && window.MutationObserver) {
            const mo = new MutationObserver(function(){ setTimeout(update, 60); });
            mo.observe(container, { childList: true, subtree: true });
        }
    })();
</script>

    <!-- Google Identity Services client and social login handlers (Google only) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
    // Handles the credential response from Google Identity Services
    function handleGoogleCredentialResponse(response){
        try{
            const parts = response.credential.split('.');
            const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
            const name = payload.name || payload.email || 'Google User';
            const email = (payload.email || '').toLowerCase();

            // Friendly UI feedback
            var el = document.getElementById('socialMessage'); if(el) el.textContent = 'Signed in as ' + name + ' (Google)';
            var el2 = document.getElementById('signupSocialMessage'); if(el2) el2.textContent = 'Signed up as ' + name + ' (Google)';

            // Client-side sign-in / sign-up flow (for demo/local usage)
            // IMPORTANT: For production, send `response.credential` to your backend and verify it server-side.
            const users = JSON.parse(localStorage.getItem('users')) || [];
            let user = users.find(u => (u.email || '').toLowerCase() === email);

            if (user) {
                // Existing user -> log them in
                const role = user.role || 'Customer';
                activeUser = { username: user.username || (email.split('@')[0]), email: user.email, role };
                localStorage.setItem('activeUser', JSON.stringify(activeUser));

                // Record login
                try { addLoginHistoryEntry({ username: activeUser.username, role: activeUser.role, password: '', status: 'success', timestamp: new Date().toISOString(), info: 'Google Sign-In' }); } catch(e){}

                // Navigate to dashboard and load user's cart
                try { showDashboard(activeUser.role); loadCartForActiveUser(true); } catch(e){ console.error('Failed to complete Google login flow', e); }
            } else {
                // Create a minimal user record and sign them up
                const username = 'g_' + (email.split('@')[0] || Date.now());
                const newUser = { username: username, email: email, password: '', role: 'Customer', createdWith: 'google' };
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));

                activeUser = { username: newUser.username, email: newUser.email, role: 'Customer' };
                localStorage.setItem('activeUser', JSON.stringify(activeUser));

                try { addLoginHistoryEntry({ username: activeUser.username, role: activeUser.role, password: '', status: 'success', timestamp: new Date().toISOString(), info: 'Google Sign-Up' }); } catch(e){}

                try { showDashboard('Customer'); loadCartForActiveUser(true); } catch(e){ console.error('Failed to complete Google signup flow', e); }
            }

            // TODO: send `response.credential` to your backend for secure verification and session creation
        }catch(e){
            console.error('Failed to parse Google credential', e);
        }
    }

    window.addEventListener('load', function(){
        try{
            if(window.google && google.accounts && google.accounts.id){
                google.accounts.id.initialize({
                    client_id: '1039377199268-i8n9rv7gkgffhrudpukh614oe71hn099.apps.googleusercontent.com',
                    callback: handleGoogleCredentialResponse
                });
                // Render sign-in button on Login page (if present)
                const signInEl = document.getElementById('googleSignInButton');
                const signUpEl = document.getElementById('googleSignUpButton');
                const opts = { theme: 'outline', size: 'large', width: '260' };
                if(signInEl) google.accounts.id.renderButton(signInEl, opts);
                if(signUpEl) google.accounts.id.renderButton(signUpEl, opts);
                // google.accounts.id.prompt(); // optional one-tap
            }
        }catch(e){ console.warn('Google Identity Services not available yet', e); }
    });

    function logoutSocial(){
        try{ google.accounts.id.disableAutoSelect(); }catch(e){}
        var el = document.getElementById('socialMessage'); if(el) el.textContent = '';
        var el2 = document.getElementById('signupSocialMessage'); if(el2) el2.textContent = '';
    }
    </script>

    <script>
    // Philippines cascading selects (Province -> City/Municipality -> Barangay)
    (function(){
        // Small sample dataset. To use a full dataset, replace this object with a full JSON
        // mapping: { "Province Name": { "City Name": ["Barangay 1","Barangay 2"] , ... }, ... }
        const PH_LOCATIONS = {
            "Metro Manila": {
                "Makati City": ["Poblacion", "San Antonio"],
                "Quezon City": ["Batasan Hills", "Diliman"]
            },
            "Batangas": {
                "Mabini": [
                    "Anilao Proper",
                    "Anilao East",
                    "Bagalangit",
                    "Bulacan",
                    "Calamias",
                    "Estrella",
                    "Gasang",
                    "Laurel",
                    "Ligaya",
                    "Mainaga",
                    "Mainit",
                    "Majuben",
                    "Malimatoc I",
                    "Malimatoc II",
                    "Nag-Iba",
                    "Pilahan",
                    "Poblacion",
                    "Pulang Lupa",
                    "Pulong Anahao",
                    "Pulong Balibaguhan",
                    "Pulong Niogan",
                    "Saguing",
                    "Sampaguita",
                    "San Francisco",
                    "San Jose",
                    "San Juan",
                    "San Teodoro",
                    "Santa Ana",
                    "Santa Mesa",
                    "Santo Nio",
                    "Santo Tomas",
                    "Solo",
                    "Talaga Proper",
                    "Talaga East"
                ],
                "Lipa City": ["Poblacion", "Banaybanay"]
            }
        };

        function byId(id){ return document.getElementById(id); }

        function clearSelect(sel, placeholder){
            sel.innerHTML = '';
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = placeholder || 'Choose';
            sel.appendChild(opt);
        }

        function populateProvinces(){
            const sel = byId('provinceSelect'); if(!sel) return;
            clearSelect(sel, 'Choose province');
            Object.keys(PH_LOCATIONS).forEach(p => {
                const o = document.createElement('option'); o.value = p; o.textContent = p; sel.appendChild(o);
            });
        }

        function populateCities(province){
            const citySel = byId('citySelect'); if(!citySel) return;
            clearSelect(citySel, 'Choose city/municipality');
            const barangaySel = byId('barangaySelect'); if(barangaySel) clearSelect(barangaySel, 'Choose barangay');
            if(!province) return;
            const citiesObj = PH_LOCATIONS[province] || {};
            Object.keys(citiesObj).forEach(city => {
                const o = document.createElement('option'); o.value = city; o.textContent = city; citySel.appendChild(o);
            });
        }

        function populateBarangays(province, city){
            const sel = byId('barangaySelect'); if(!sel) return;
            clearSelect(sel, 'Choose barangay');
            if(!province || !city) return;
            const arr = (PH_LOCATIONS[province] && PH_LOCATIONS[province][city]) || [];
            arr.forEach(b => { const o = document.createElement('option'); o.value = b; o.textContent = b; sel.appendChild(o); });
        }

        document.addEventListener('DOMContentLoaded', function(){
            populateProvinces();

            const provinceSel = byId('provinceSelect');
            const citySel = byId('citySelect');
            const barangaySel = byId('barangaySelect');

            if(provinceSel){
                provinceSel.addEventListener('change', function(){
                    populateCities(this.value);
                });
            }

            if(citySel){
                citySel.addEventListener('change', function(){
                    const prov = provinceSel ? provinceSel.value : '';
                    populateBarangays(prov, this.value);
                });
            }

            // If the page has existing plain-text inputs (editing scenario), try to preselect
            try {
                const existingProvince = (byId('province') && byId('province').value) || '';
                const existingCity = (byId('city') && byId('city').value) || '';
                const existingBarangay = (byId('barangay') && byId('barangay').value) || '';
                if(existingProvince && provinceSel){ provinceSel.value = existingProvince; populateCities(existingProvince); }
                if(existingCity && citySel){ citySel.value = existingCity; const prov = provinceSel ? provinceSel.value : existingProvince; populateBarangays(prov, existingCity); }
                if(existingBarangay && barangaySel){ barangaySel.value = existingBarangay; }
            } catch(e){ /* ignore */ }

            // Optional: allow keyboard typing to jump to options (basic)
            function enableTypeSearch(sel){
                if(!sel) return;
                let term = '';
                let to = null;
                sel.addEventListener('keydown', function(e){
                    if(e.key.length === 1){
                        term += e.key.toLowerCase();
                        clearTimeout(to);
                        to = setTimeout(()=> term = '', 700);
                        for(const opt of Array.from(sel.options)){
                            if(opt.value && opt.value.toLowerCase().startsWith(term)){
                                sel.value = opt.value; sel.dispatchEvent(new Event('change')); break;
                            }
                        }
                    }
                });
            }

            enableTypeSearch(provinceSel); enableTypeSearch(citySel); enableTypeSearch(barangaySel);
        });
    })();
    </script>
</body>

</html>
